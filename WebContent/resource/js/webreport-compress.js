if($==undefined){$=jQuery}var dataType=["String","Int","Double","Date"];var layout={};layout.l1_json={tr1:[{colspan:1,rowspan:1,width:100,height:100,id:1}]};layout.l2_json={tr1:[{colspan:1,rowspan:1,width:50,height:100,id:1},{colspan:1,rowspan:1,width:50,height:100,id:2}]};layout.l3_json={tr1:[{colspan:2,rowspan:1,width:100,height:50,id:1}],tr2:[{colspan:1,rowspan:1,width:50,height:50,id:2},{colspan:1,rowspan:1,width:50,height:50,id:3}]};layout.l4_json={tr1:[{colspan:2,rowspan:1,width:100,height:33,id:1}],tr2:[{colspan:1,rowspan:1,width:50,height:33,id:2},{colspan:1,rowspan:1,width:50,height:33,id:3}],tr3:[{colspan:2,rowspan:1,width:100,height:33,id:4}]};layout.l5_json={tr1:[{colspan:2,rowspan:1,width:100,height:20,id:1}],tr2:[{colspan:1,rowspan:1,width:50,height:20,id:2},{colspan:1,rowspan:1,width:50,height:20,id:3}],tr3:[{colspan:2,rowspan:1,width:100,height:20,id:4}],tr4:[{colspan:1,rowspan:1,width:50,height:20,id:5},{colspan:1,rowspan:1,width:50,height:20,id:6}],tr5:[{colspan:2,rowspan:1,width:100,height:20,id:7}]};function newpage(){var a="ReportMain.action?showtit="+showtit+"&menus="+curTmpInfo.menus;if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(function(){location.href=a})}else{location.href=a}}else{location.href=a}}function initviewTree(){var a=[{text:"页面参数",id:"cs",state:"open",iconCls:"icon-param",attributes:{showmenu:false,onlyAdd:true}},{text:"页面组件",id:"comp",state:"open"}];if(pageInfo.param){a[0].children=[];for(var f=0;f<pageInfo.param.length;f++){var e=pageInfo.param[f];var p={text:(e.desc!=""?e.desc:e.id),id:e.id,iconCls:(e.type=="casca"?"icon-param":"icon-param2"),attributes:{showmenu:true,type:"param"}};if(e.type=="casca"){p.children=[];for(c=0;c<e.children.length;c++){var g=e.children[c];p.children.push({text:g.desc,id:g.id,iconCls:"icon-param2",attributes:{showmenu:false,type:"param"}})}}a[0].children.push(p)}}if(pageInfo.body){a[1].children=[];for(var f=1;true;f++){var o=pageInfo.body["tr"+f];if(!o||o==null){break}for(var d=0;d<o.length;d++){var b=o[d];for(var c=0;b.children&&c<b.children.length;c++){var e={text:b.children[c].name,id:b.children[c].id,attributes:{showmenu:true,type:"compview"}};var h=b.children[c].type;if(h=="label"){e.iconCls="icon-label"}else{if(h=="text"){e.iconCls="icon-text"}else{if(h=="cross"){e.iconCls="icon-cross"}else{if(h=="pic"){e.iconCls="icon-pic"}else{if(h=="chart"){e.iconCls="icon-chart"}else{if(h=="table"){e.iconCls="icon-table"}else{if(h=="staticCross"){e.iconCls="icon-cross2"}}}}}}}a[1].children.push(e)}}}}$("#viewtree").tree({data:a,onContextMenu:function(r,q){r.preventDefault()},onClick:function(q){if(q.attributes&&q.attributes.type=="compview"){compBorderSet($("#"+q.id));setProp($("#"+q.id).parent().attr("id").split("_")[1],q.id)}}})}function initmydatatree(a){var c=[{text:"数据源",id:"sjy",iconCls:"icon-dsource",attributes:{showmenu:true,onlyAdd:true}},{text:"数据集",id:"sjj",iconCls:"icon-dataset2",attributes:{showmenu:true,onlyAdd:true}},{text:"立方体",id:"lft",iconCls:"icon-cube",attributes:{showmenu:true,onlyAdd:true}},{text:"参数",id:"cs",iconCls:"icon-param",attributes:{showmenu:true,onlyAdd:true}},{text:"变量",id:"var",iconCls:"icon-var",attributes:{showmenu:true,onlyAdd:true}}];if(pageInfo.datasource){c[0].children=[];for(var h=0;h<pageInfo.datasource.length;h++){c[0].children.push({text:(pageInfo.datasource[h].use=="jndi"?pageInfo.datasource[h].jndiname:pageInfo.datasource[h].dsname),id:pageInfo.datasource[h].dsid,iconCls:"icon-dsource",attributes:{showmenu:true,type:"dsource"}})}}if(pageInfo.dataset){c[1].children=[];for(var h=0;h<pageInfo.dataset.length;h++){var g={text:pageInfo.dataset[h].name,id:pageInfo.dataset[h].datasetid,iconCls:"icon-dataset2",attributes:{showmenu:true,type:"dset"},children:[],state:"closed"};c[1].children.push(g);var b=pageInfo.dataset[h].cols;if(b&&b[0]!=null){for(var f=0;f<b.length;f++){g.children.push({text:(b[f].dispName==""?b[f].name:b[f].dispName),id:b[f].name,iconCls:"icon-dscol",attributes:{drag:"y",datasetid:g.id,type:b[f].type,income:"dataset"}})}}}}if(pageInfo.cube){c[2].children=[];for(var h=0;h<pageInfo.cube.length;h++){var d=pageInfo.cube[h];var g={text:d.name,id:d.id,iconCls:"icon-cube",attributes:{showmenu:true,type:"cube"},children:[],state:"closed"};c[2].children.push(g);var b=d.dim;if(b){for(var f=0;f<b.length;f++){if(b[f].tp=="group"){var q={text:b[f].name,id:b[f].id,iconCls:"icon-group",children:[],attributes:{drag:"n",type:"group",cubeId:d.id}};g.children.push(q);for(var e=0;e<b[f].children.length;e++){var p=b[f].children[e];q.children.push({text:p.name,id:p.id,iconCls:"icon-dim",attributes:{drag:"y",type:"dim",dimkey:(p.dimkey?p.dimkey:""),dimtxt:(p.dimtxt?p.dimtxt:""),cubeId:d.id,income:"cube",tname:p.tname,dim_type:p.dim_type,dimord:p.dimord,ordcol:p.ordcol}})}}else{g.children.push({text:b[f].name,id:b[f].id,iconCls:"icon-dim",attributes:{drag:"y",type:"dim",dimkey:(b[f].dimkey?b[f].dimkey:""),dimtxt:(b[f].dimtxt?b[f].dimtxt:""),cubeId:d.id,income:"cube",tname:b[f].tname,dim_type:b[f].dim_type,dimord:b[f].dimord,ordcol:b[f].ordcol}})}}}var e=d.kpi;if(e){for(var f=0;f<e.length;f++){g.children.push({text:e[f].aggre+"("+e[f].name+")",id:e[f].id,iconCls:(e[f].calc==1?"icon-ckpi":"icon-kpi"),attributes:{drag:"y",type:"kpi",fmt:e[f].fmt,unit:e[f].unit,aggre:e[f].aggre,cubeId:d.id,income:"cube",dispName:e[f].name,calc:e[f].calc,expression:e[f].expression}})}}}}if(pageInfo.param){c[3].children=[];for(var h=0;h<pageInfo.param.length;h++){var g=pageInfo.param[h];var q={text:(g.desc!=""?g.desc:g.id),id:g.id,iconCls:(g.type=="casca"?"icon-param":"icon-param2"),attributes:{showmenu:true,type:"param"}};if(g.type=="casca"){q.children=[];for(e=0;e<g.children.length;e++){var p=g.children[e];q.children.push({text:p.desc,id:p.id,iconCls:"icon-param2",attributes:{showmenu:false,type:"param"}})}}c[3].children.push(q)}}if(pageInfo.vars){c[4].children=[];for(var h=0;h<pageInfo.vars.length;h++){var g=pageInfo.vars[h];var q={id:g.id,text:g.id,iconCls:"icon-var",attributes:{showmenu:true,type:"var"}};c[4].children.push(q)}}$("#mydatatree").tree({data:c,dnd:true,onBeforeDrag:function(o){if(o.attributes&&o.attributes.drag=="y"){return true}return false},onDragEnter:function(r,o){return false},onContextMenu:function(r,o){if(o.attributes&&o.attributes.showmenu==true){r.preventDefault();curTmpInfo.tp=o.attributes.type;curTmpInfo.id=o.id;if(o.attributes.onlyAdd){$("#mydatasetmenu").menu("disableItem",$("#dataset_mod"));$("#mydatasetmenu").menu("disableItem",$("#dataset_gx"));$("#mydatasetmenu").menu("disableItem",$("#dataset_del"));$("#mydatasetmenu").menu("enableItem",$("#dataset_add"));$("#mydatasetmenu").menu("enableItem",$("#dataset_exist"))}else{$("#mydatasetmenu").menu("enableItem",$("#dataset_mod"));$("#mydatasetmenu").menu("enableItem",$("#dataset_gx"));$("#mydatasetmenu").menu("enableItem",$("#dataset_del"));$("#mydatasetmenu").menu("disableItem",$("#dataset_add"));$("#mydatasetmenu").menu("disableItem",$("#dataset_exist"))}$("#mydatatree").tree("select",o.target);$("#mydatasetmenu").menu("show",{left:r.pageX,top:r.pageY})}else{r.preventDefault()}}})}function initSubmitData(g){if(g){for(var d=0;curTmpInfo.comps&&d<curTmpInfo.comps.length;d++){if(curTmpInfo.comps[d].type=="table"){table2json(curTmpInfo.comps[d].id)}}}for(var d=1;true;d++){var f=pageInfo.body["tr"+d];if(!f||f==null){break}for(var c=0;c<f.length;c++){var h=f[c];h.children=[];var e=$("#layout_"+h.id).children();if(e&&e.size()>0){var a=e;for(var b=0;a&&b<a.size();b++){h.children.push(findCompById(a[b].id))}}}}}function savepage(b,f){initSubmitData(true);if(f){if(!curTmpInfo.comps||curTmpInfo.comps.length==0){msginfo("您还未添加任何组件。");return}var e=checkCompErrInfo();if(e.length!=0){msginfo("报表存在错误信息，请修正后再预览。");return}}var a=JSON.stringify(pageInfo);var d=pageInfo.id;if(d==undefined||d==null){d=""}if(f==true){$("#pageviewform #pageInfo").val(a);$("#pageviewform").submit();return}if(d==""){var c='<div style="margin:5px 20px 5px 20px;"><span style="display:inline-block;width:60px;"> 名 称： </span><input type="text" style="width:187px;" id="pageName"><div style="margin-top:5px;"><table cellspacing="0" cellpadding="0"><tr><td valign="top"><span style="display:inline-block;width:60px;"> 目 录：</span></td><td><ul id="reportcatalist"></ul></td></tr></table></div></div>';$("#pdailog").dialog({title:"保存报表",width:330,height:260,closed:false,cache:false,modal:true,toolbar:null,content:c,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var g=$("#pdailog #pageName").val();if(g==""){msginfo("您还未录入文件名称。");$("#pdailog #pageName").focus();return}var h=$("#reportcatalist").tree("getSelected");if(h==null||h.id=="0"){msginfo("您还未选择报表目录。");return}$.post("ReportMain!save.action",{pageInfo:a,pageId:d,pageName:g,cataId:h.id},function(o){if(o=="no"){msginfo("保存失败，名称存在重复。");return}pageInfo.id=Number(o);if(b!=undefined){b()}else{}msginfo("保存成功！","suc");curTmpInfo.isupdate=false;$("#pdailog").dialog("close")})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #reportcatalist").tree({url:"../report/ReportCatalog!tree.action?type=1",dnd:false,data:[{id:"0",text:"报表目录",state:"closed"}],onBeforeLoad:function(g){if(!g||g==null){return false}}});$("#reportcatalist").tree("expand",$("#reportcatalist").tree("getRoot").target)}else{$.post("ReportMain!save.action",{pageInfo:a,pageId:d},function(g){pageInfo.id=Number(g);if(b!=undefined){b()}else{}msginfo("保存成功！","suc");curTmpInfo.isupdate=false})}}function saveas(){initSubmitData(true);var a=JSON.stringify(pageInfo);var b='<div style="margin:5px 20px 5px 20px;"><span style="display:inline-block;width:60px;"> 名 称： </span><input type="text" style="width:187px;" id="pageName"><div style="margin-top:5px;"><table cellspacing="0" cellpadding="0"><tr><td valign="top"><span style="display:inline-block;width:60px;"> 目 录：</span></td><td><ul id="reportcatalist"></ul></td></tr></table></div></div>';$("#pdailog").dialog({title:"保存报表",width:330,height:260,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var c=$("#pdailog #pageName").val();if(c==""){msginfo("您还未录入文件名称。");$("#pdailog #pageName").focus();return}var d=$("#reportcatalist").tree("getSelected");if(d==null||d.id=="0"){msginfo("您还未选择报表目录。");return}$.post("ReportMain!save.action",{pageInfo:a,pageId:"",pageName:c,cataId:d.id},function(e){if(e=="no"){msginfo("保存失败，名称存在重复。");return}pageInfo.id=Number(e);msginfo("另存成功！","suc");$("#pdailog").dialog("close")})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #reportcatalist").tree({url:"../report/ReportCatalog!tree.action?type=1",dnd:false,data:[{id:"0",text:"报表目录",state:"closed"}],onBeforeLoad:function(c){if(!c||c==null){return false}}});$("#reportcatalist").tree("expand",$("#reportcatalist").tree("getRoot").target)}function editmyreport(){location.href="ReportMain.action?pageId="+pageInfo.reportId+"&showtit="+showtit+"&menus="+curTmpInfo.menus}function initlayout(b){$("#optarea").html(crtJson2table(pageInfo,b));regCompEvent();for(l=0;curTmpInfo.comps&&l<curTmpInfo.comps.length;l++){var a=curTmpInfo.comps[l];if(a.type=="cross"){regCrossDropEvent(a);regCrossCellSelect(a.id)}if(a.type=="staticCross"){curTmpInfo.scrossTable.regDropEvent(a);curTmpInfo.scrossTable.cellSelect(a.id)}if(a.type=="table"){regTableEvent(a.id);regTableDrop(a.id)}if(a.type=="chart"){curTmpInfo.chart=a;chartview(null,function(d,c){$("#"+c+" div.ctx img").attr("src","Chart!showPic.action?mvid="+d+"&T="+Math.random())},"Chart!toPic.action",a.id)}}curTmpInfo.chart=null;$("#optarea").bind("click",function(c){if(!$(c.target).hasClass("laytd")){return false}else{curTmpInfo.property.setLayoutProp(pageInfo.body);compBorderSet()}}).bind("contextmenu",function(c){c.preventDefault();compBorderSet();curTmpInfo.property.setLayoutProp(pageInfo.body);curTmpInfo.layoutId=$(c.target).attr("id").split("_")[1];if(!curTmpInfo.copycomp){$("#layoutmenu").menu("disableItem",$("#m_paste2"))}else{$("#layoutmenu").menu("enableItem",$("#m_paste2"))}$("#layoutmenu").menu("show",{left:c.pageX,top:c.pageY})});curTmpInfo.property.setLayoutProp(pageInfo.body)}function autoLayout(){var b=function(q){var o='<table border="0" cellspacing="0" cellpadding="0" class="r_layout" id="autoLayoutTable">';for(var p=1;true;p++){var r=q["tr"+p];if(!r||r==null){break}o=o+"<tr>";for(var h=0;h<r.length;h++){var s=r[h];o=o+'<td class="laytd" height="'+s.height+'%" width="'+s.width+'%" colspan="'+s.colspan+'" rowspan="'+s.rowspan+'">';o=o+"&nbsp; </td>"}o=o+"</tr>"}o=o+"</table>";return o};var c=pageInfo.body;var a=b(c);$("#pdailog").dialog({title:"自定义报表布局",width:540,height:350,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"确定",handler:function(){var r={};var v=document.getElementById("autoLayoutTable").rows;var s=0;for(var q=0;q<v.length;q++){var u=v[q].cells;var p=[];r["tr"+(q+1)]=p;for(var h=0;h<u.length;h++){var t=$(u[h]);var o={};o.colspan=t.attr("colspan")?t.attr("colspan"):"1";o.rowspan=(t.attr("rowspan")?t.attr("rowspan"):"1");o.height=Number(t.attr("height").replace("%",""));o.width=Number(t.attr("width").replace("%",""));o.id=s;s=s+1;p.push(o)}}pageInfo.body=json=r;for(var q=0;curTmpInfo.comps&&q<curTmpInfo.comps.length;q++){if(!json.tr1[0].children){json.tr1[0].children=[]}json.tr1[0].children.push(curTmpInfo.comps[q])}initlayout(false);initCompDropEvent();curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});updateHeightWidth();var f=function(h){$("#autoLayoutTable td").removeClass("tdselect");$(h).addClass("tdselect")};var e=function(q,h){$("#autoLayoutTable td").removeClass("tdselect");var p=$(q).attr("pos").split(",");var o=$(h).attr("pos").split(",");if(p[0]>o[0]||p[1]>o[1]){tmp=p;p=o;o=tmp}for(i=p[0];i<=o[0];i++){for(j=p[1];j<=o[1];j++){$("#autoLayoutTable td[pos='"+(i+","+j)+"']").addClass("tdselect")}}};var d=false;var g=null;$("#autoLayoutTable td").live("click",function(){f(this)}).live("mousedown",function(h){d=true;g=this}).live("mouseup",function(h){d=false}).live("mousemove",function(h){if(d){e(g,this)}}).live("contextmenu",function(h){h.preventDefault();h.stopPropagation();curTmpInfo.curtabtd=this;if($("#autoLayoutTable td.tdselect").size()<=1){f(this)}if($(this).attr("colspan")>1||$(this).attr("rowspan")>1){$("#autolayoutmenu").menu("enableItem",$("#lyt_unmergeCell"));$("#autolayoutmenu").menu("disableItem",$("#lyt_mergeCell"))}else{$("#autolayoutmenu").menu("disableItem",$("#lyt_unmergeCell"));$("#autolayoutmenu").menu("enableItem",$("#lyt_mergeCell"))}$("#autolayoutmenu").menu("show",{left:h.pageX,top:h.pageY})})}function lyt_mergeCell(){var e=null;var c=null;var a=$("#autoLayoutTable td.tdselect").size();if(a<=1){return}var d=null;$("#autoLayoutTable td.tdselect").each(function(g,h){if(g==0){e=$(this).attr("pos").split(",")}if(g==a-1){c=$(this).attr("pos").split(",");d=$(this)}if(g>0){$(this).remove()}});var f=d.attr("colspan")?Number(d.attr("colspan")):1;var b=d.attr("rowspan")?Number(d.attr("rowspan")):1;$("#autoLayoutTable td.tdselect").attr("rowspan",Math.abs(e[0]-c[0]+(b-1))+1).attr("colspan",Math.abs(e[1]-c[1]+(f-1))+1);updateHeightWidth(true)}function lyt_unmergeCell(){var g=$(curTmpInfo.curtabtd);var f=g.attr("colspan")?Number(g.attr("colspan")):1;var d=g.attr("rowspan")?Number(g.attr("rowspan")):1;g.attr("colspan",1);g.attr("rowspan",1);for(i=1;i<=d;i++){var e="";for(j=1;j<(i==1?f:f+1);j++){e=e+'<td class="laytd"></td>'}if(i==1){g.after(e)}else{var a=g.attr("pos").split(",");var b=$("#autoLayoutTable td[pos='"+((Number(a[0])+i-1)+","+(Number(a[1])-1))+"']");if(b.size()==0){b=$("#autoLayoutTable td[pos='"+((Number(a[0])+i-1)+","+(Number(a[1])+f))+"']");if(b.size()>0){b.before(e)}else{var c=g.parent();for(k=1;k<=i-1;k++){c=c.next()}c.append(e)}}else{b.after(e)}}}updateHeightWidth()}function lyt_insertRow(){var e=curTmpInfo.curtabtd;var h=function(w,c){var r=null;$("#autoLayoutTable td").each(function(x,y){var B=$(y).attr("pos").split(",");var z=$(y).attr("rowspan")?Number($(y).attr("rowspan")):1;var A=$(y).attr("colspan")?Number($(y).attr("colspan")):1;if(z>1){if(w>Number(B[0])&&w<=Number(B[0])+z&&c>=Number(B[1])&&c<Number(B[1])+A){r=$(y)}}});return r};var t=0;var u=document.getElementById("autoLayoutTable").rows[0].cells;for(i=0;i<u.length;i++){var d=$(u[i]).attr("colspan")?Number($(u[i]).attr("colspan")):1;t=t+d}var s=$(e).attr("pos").split(",");var v=Number(s[0])+1;var f=$(e).attr("rowspan")?Number($(e).attr("rowspan")):1;v=v+f-1;var q="<tr>";for(i=0;i<t;i++){var b=$("#autoLayoutTable td[pos='"+v+","+i+"']");if(b.size()==0){var g=h(v,i);if(g!=null){var a=Number(g.attr("rowspan"))+1;g.attr("rowspan",a);var p=Number(g.attr("colspan"));if(p>1){i=i+p-1}continue}}q=q+'<td class="laytd">';q=q+"</td>"}q=q+"</tr>";var o=$(e).parent();for(i=1;i<f;i++){o=o.next()}o.after(q);updateHeightWidth()}function lyt_insertCol(){var g=curTmpInfo.curtabtd;var o=function(x,c){var r=null;$("#autoLayoutTable td").each(function(y,z){var C=$(z).attr("pos").split(",");var B=$(z).attr("colspan")?Number($(z).attr("colspan")):1;var A=$(z).attr("rowspan")?Number($(z).attr("rowspan")):1;if(B>1){if(x>=Number(C[0])&&x<Number(C[0])+A&&c>Number(C[1])&&c<=Number(C[1])+B){r=$(z)}}});return r};var w=document.getElementById("autoLayoutTable").rows;var s=$(g).attr("pos").split(",");var u=Number(s[1]);var f=$(g).attr("colspan")?Number($(g).attr("colspan")):1;if(f>1){u=u+f-1}var b=[];for(i=0;i<w.length;i++){var t=null;var d=$("#autoLayoutTable td[pos='"+i+","+(u)+"']");if(d.size()==0){var h=o(i,u);if(h!=null){var a=Number(h.attr("colspan"))+1;h.attr("colspan",a);var q=Number(h.attr("rowspan"));if(q>1){i=i+q-1}continue}}else{var a=d.attr("colspan")?Number(d.attr("colspan")):1;var q=Number(d.attr("rowspan"));if(q>1){i=i+q-1}if(a>1){d.attr("colspan",a+1);continue}t=d}var v=t.attr("rowspan")?Number(t.attr("rowspan")):1;var e=t.attr("colspan")?Number(t.attr("colspan")):1;var p='<td class="laytd" rowspan="'+v+'" colspan="'+e+'"></td>';b.push({obj:t,str:p})}for(i=0;i<b.length;i++){b[i].obj.after(b[i].str)}updateHeightWidth()}function lyt_deleteCol(){var d=$(curTmpInfo.curtabtd);var s=document.getElementById("autoLayoutTable").rows;var f=function(t,c){var r=null;$("#autoLayoutTable td").each(function(u,v){var y=$(v).attr("pos").split(",");var x=$(v).attr("colspan")?Number($(v).attr("colspan")):1;var w=$(v).attr("rowspan")?Number($(v).attr("rowspan")):1;if(x>1){if(t>=Number(y[0])&&t<Number(y[0])+w&&c>Number(y[1])&&c<=Number(y[1])+x){r=$(v)}}});return r};var g=Number(d.attr("pos").split(",")[1]);var q=[];var p=d.attr("colspan")?Number(d.attr("colspan")):1;for(k=0;k<p;k++){var o=g+k;for(i=0;i<s.length;i++){var b=$("#autoLayoutTable td[pos='"+i+","+(o)+"']");if(b.attr("pos")==d.attr("pos")){q.push(b);var h=Number(b.attr("rowspan"));if(h>1){i=i+h-1}continue}if(b.size()==0){var e=f(i,o);if(e!=null){var a=Number(e.attr("colspan"))-1;e.attr("colspan",a);var h=Number(e.attr("rowspan"));if(h>1){i=i+h-1}continue}}else{var a=b.attr("colspan")?Number(b.attr("colspan")):1;var h=b.attr("rowspan")?Number(b.attr("rowspan")):1;if(h>1){i=i+h-1}if(a>1){b.attr("colspan",a-1);continue}}q.push(b)}}for(i=0;i<q.length;i++){$(q[i]).remove()}updateHeightWidth()}function lyt_deleteRow(){var f=$(curTmpInfo.curtabtd);var w=0;var x=document.getElementById("autoLayoutTable").rows[0].cells;for(i=0;i<x.length;i++){var d=$(x[i]).attr("colspan")?Number($(x[i]).attr("colspan")):1;w=w+d}var p=function(z,c){var r=null;$("#autoLayoutTable td").each(function(A,B){var E=$(B).attr("pos").split(",");var C=$(B).attr("rowspan")?Number($(B).attr("rowspan")):1;var D=$(B).attr("colspan")?Number($(B).attr("colspan")):1;if(C>1){if(z>Number(E[0])&&z<=Number(E[0]+C)&&c>=Number(E[1])&&c<Number(E[1])+D){r=$(B)}}});return r};var h=[];var u=$(f).attr("pos").split(",");var g=Number(u[0]);var v=f.attr("rowspan")?Number(f.attr("rowspan")):1;for(n=0;n<v;n++){for(i=0;i<w;i++){var y=g+n;var b=$("#autoLayoutTable td[pos='"+y+","+i+"']");if(b.size()==0){var o=p(y,i);if(o!=null){var a=Number(o.attr("rowspan"))-1;o.attr("rowspan",a);var t=Number(o.attr("colspan"));if(t>1){i=i+t-1}}}else{if(Number(b.attr("rowspan"))>1){b.attr("rowspan",Number(b.attr("rowspan"))-1);var s=false;var e=i-1;while(e>=0){var q=$("#T"+compId+" td[pos='"+(y+1)+","+(e)+"']");if(q.size()>0){q.after(b);s=true;break}e=e-1}if(s==false){e=i+1;while(e<w){var q=$("autoLayoutTable td[pos='"+(y+1)+","+(e)+"']");if(q.size()>0){q.before(b);s=true;break}e=e+1}}}var t=Number(b.attr("colspan"));if(t>1){i=i+t-1}}}h.push($("#autoLayoutTable tr").get(y))}for(i=0;i<h.length;i++){$(h[i]).remove()}updateHeightWidth()}function updateHeightWidth(h){var r=document.getElementById("autoLayoutTable").rows[0].cells;var o=0;for(i=0;i<r.length;i++){o=o+Number(($(r[i]).attr("colspan")?$(r[i]).attr("colspan"):1))}var p={};var s=document.getElementById("autoLayoutTable").rows;var d=s.length;for(j=0;j<d;j++){r=s[j].cells;var c=0;for(i=0;i<r.length;i++){var a=$(r[i]).attr("colspan")?Number($(r[i]).attr("colspan")):1;var f=$(r[i]).attr("rowspan")?Number($(r[i]).attr("rowspan")):1;var b=((100/o)*a);var g=((100/d)*f);$(r[i]).attr({width:Math.round(b)+"%",height:Math.round(g)+"%"});if(h&&h==true){continue}if(f>1){for(k=1;k<f;k++){var q="before";for(m=0;m<i;m++){var e=($(r[m]).attr("rowspan")?Number($(r[m]).attr("rowspan")):1)-1;if(e<k){q="after";break}}p[(j+k)+","+(q=="before"?c:c-1)+q]=a}}for(l=c-1;i==0&&l<o;l++){if(p[j+","+(c)+"before"]){c=c+p[j+","+(c)+"before"]}else{break}}$(r[i]).attr({pos:j+","+c});c=c+1;if(a>1){c=c+(a-1)}for(l=c-1;l<o;l++){if(p[j+","+(l)+"after"]){c=c+p[j+","+(l)+"after"]}else{break}}}}}function setlayout(){var ctx='<div class="textpanel"><br/>';for(var i=1;i<=6;i++){ctx=ctx+'<span class="rlayout"><img src="../resource/img/layout/l'+i+'.png"><br/><input type="radio" name="sellayout" value="'+i+'" '+(i==pageInfo.layout?"checked":"")+" ></span>"}ctx=ctx+"</div>";$("#pdailog").dialog({title:"设置报表布局",width:430,height:340,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:ctx,buttons:[{text:"确定",handler:function(){var s=$('input[name="sellayout"]:checked').val();pageInfo.layout=Number(s);var json=null;if(s==1){json=layout.l1_json}else{if(s==2){json=layout.l2_json}else{if(s==3){json=layout.l3_json}else{if(s==4){json=layout.l4_json}else{if(s==5){json=layout.l5_json}else{if(s==6){$("#pdailog").dialog("close");autoLayout();return}}}}}}pageInfo.body=json=eval("("+JSON.stringify(json)+")");for(var i=0;curTmpInfo.comps&&i<curTmpInfo.comps.length;i++){if(!json.tr1[0].children){json.tr1[0].children=[]}json.tr1[0].children.push(curTmpInfo.comps[i])}initlayout(false);initCompDropEvent();curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})}function crtJson2table(p,o){var q=p.body;if(!q){return}var e="";if(p.style&&p.style.type){if(p.style.type=="PHONE"){e="width:400px;"}else{if(p.style.type=="PAD"){e="width:800px;"}else{if(p.style.type=="PC"){}}}}var g='<table border="0" cellspacing="0" cellpadding="0" class="r_layout" id="layout_table" '+(e==""?"":'style="'+e+'"')+">";for(var d=1;true;d++){var h=q["tr"+d];if(!h||h==null){break}g=g+"<tr>";for(var c=0;c<h.length;c++){var a=h[c];g=g+'<td class="laytd" height="'+a.height+'%" width="'+a.width+'%" colspan="'+a.colspan+'" rowspan="'+a.rowspan+'" id="layout_'+a.id+'">';if(a.children){for(var b=0;b<a.children.length;b++){var f=a.children[b];if(o==true){if(!curTmpInfo.comps){curTmpInfo.comps=[]}curTmpInfo.comps.push(f)}g=g+addComp(f,a.id,false)}}g=g+"</td>"}g=g+"</tr>"}g=g+"</table>";return g}function reloadParamVals(b){$("#pdailog #values table tr").each(function(f,e){if(f>0){$(this).remove()}});var d="";for(var a=0;a<curTmpInfo.paramvals.length;a++){var c=curTmpInfo.paramvals[a];d=d+'<tr><td  class="kpiData1 grid3-td">'+c.value+'</td><td  class="kpiData1 grid3-td">'+c.text+'</td><td class="kpiData1 grid3-td"><a href="javascript:newparamval(true,\''+c.value+"');\"><img title='编辑' src='../resource/img/pencil.png' border='0'></a> &nbsp; <a href=\"javascript:paramdelvals('"+c.value+"');\"><img title='删除' src='../resource/img/closeme.png' border='0'></a></td></tr>"}for(var a=curTmpInfo.paramvals.length;a<5;a++){d=d+"<tr>";for(j=0;j<3;j++){d=d+'<td class="kpiData1 grid3-td"> &nbsp; </td>'}d=d+"</tr>"}if(b==true){return d}else{$(d).insertAfter("#pdailog #values table tr")}}function paramdelvals(c){var a=-1;for(var b=0;b<curTmpInfo.paramvals.length;b++){if(curTmpInfo.paramvals[b].value==c){a=b;break}}curTmpInfo.paramvals.splice(a,1);reloadParamVals()}function newCascaParam(e,c){var g={children:[]};if(e=="update"){g=findParamById(c)}var a='<div class="textpanel"><span class="inputtext">参数组名称：</span><input type="text" class="inputform" name="groupname" id="groupname" value="'+(g.desc?g.desc:"")+'"><div class="cascaparamleft"><fieldset><legend>级联参数列表</legend><table id="cascaparam" title="" style="width:480px;height:200px;"><thead><tr><th data-options="field:\'id\',width:80">标识<th data-options="field:\'desc\',width:100">显示名</th><th data-options="field:\'datasetid\',width:100">数据集</th><th data-options="field:\'value\',width:95">Value字段</th><th data-options="field:\'text\',width:95">Text字段</th></tr></thead></table></fieldset></div><div class="cascaparamright"><a href="#" id="casca_new">新建</a> <br/> <a href="#" id="casca_update">修改</a> <br/> <a href="#" id="casca_del">删除</a></div><div style="clear:both;">级联参数接收字段：<select id="acceptColumn" name="acceptColumn" class="inputform"></select>(设置参数列表中的第二个及以后参数)</div></div>';$("#pdailog").dialog({title:e=="insert"?"创建级联参数":"编辑级联参数",width:620,height:420,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},buttons:[{text:"确定",handler:function(){var h=$("#pdailog #groupname").val();if(h==""){msginfo("请输入参数组名称。");return}if(g.children.length==0){msginfo("您还未添加参数。");return}g.desc=h;g.type="casca";if(e=="insert"){if(!pageInfo.param){pageInfo.param=[]}g.id=newGuid();pageInfo.param.push(g);var p=[{id:g.id,text:g.desc,state:"open",iconCls:"icon-param",attributes:{showmenu:true,type:"param"},children:[]}];for(j=0;j<g.children.length;j++){var q=g.children[j];p[0].children.push({id:q.id,text:q.desc,iconCls:"icon-param2",attributes:{showmenu:false,type:"param"}})}$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='cs']"),data:p})}else{$("#mydatatree").tree("update",{target:$("#mydatatree div[node-id='"+g.id+"']"),text:h});for(j=0;j<g.children.length;j++){var q=g.children[j];$("#mydatatree").tree("update",{target:$("#mydatatree div[node-id='"+q.id+"']"),text:q.desc})}}initviewTree();$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});var d=function(q){var h=null;for(k=0;k<g.children.length;k++){var o=g.children[k];if(o.id==q){h=o;break}}return h};var b=function(){var h=[];for(k=0;k<g.children.length;k++){var q=g.children[k];var o=findDatasetById(q.option.datasetid);h.push({id:q.id,desc:q.desc,dsid:q.option.datasetid,datasetid:o.name,value:q.option.value,text:q.option.text})}return h};$("#pdailog #cascaparam").datagrid({data:b(),singleSelect:true,onSelect:function(o,t){if(o==0){$("#pdailog #acceptColumn").html("");return}var q=findDatasetById(t.dsid);var r=d(t.id);var s='<option value=""></option>';for(i=0;i<q.cols.length;i++){var h=q.cols[i].dispName!=""?q.cols[i].dispName:q.cols[i].name;var u=q.cols[i].name;s=s+'<option value="'+u+'" '+(r.acceptColumn==u?"selected":"")+">"+h+"</option>"}$("#pdailog #acceptColumn").html(s)}});$("#pdailog #casca_new").linkbutton({iconCls:"icon-add",plain:true});$("#pdailog #casca_update").linkbutton({iconCls:"icon-edit",plain:true});$("#pdailog #casca_del").linkbutton({iconCls:"icon-cancel",plain:true});$("#pdailog #casca_new").click(function(){f(false)});$("#pdailog #casca_update").click(function(){var h=$("#pdailog #cascaparam").datagrid("getSelected");if(h==null){msginfo("请选择你要修改的参数。");return}f(true,h.id)});$("#pdailog #casca_del").click(function(){var q=$("#pdailog #cascaparam").datagrid("getSelected");if(q==null){msginfo("请选择你要删除的参数。");return}var h=-1;for(k=0;k<g.children.length;k++){var o=g.children[k];if(o.id==q.id){h=k;break}}g.children.splice(h,1);$("#pdailog #cascaparam").datagrid("loadData",b())});$("#pdailog #acceptColumn").change(function(){var o=$("#pdailog #cascaparam").datagrid("getSelected");var h=d(o.id);h.acceptColumn=$(this).val()});var f=function(t,y){var r=null;if(y){r=d(y)}var u="";for(var v=0;pageInfo.dataset&&v<pageInfo.dataset.length;v++){u=u+'<option value="'+pageInfo.dataset[v].datasetid+'" '+(r!=null&&r.option&&pageInfo.dataset[v].datasetid==r.option.datasetid?"selected":"")+">"+pageInfo.dataset[v].name+"</option>"}var x;var p;if(r!=null){var q=findDatasetById(r.option.datasetid);for(var s=0;q!=null&&s<q.cols.length;s++){var h=q.cols[s].dispName!=""?q.cols[s].dispName:q.cols[s].name;var o=q.cols[s].name;x=x+'<option value="'+o+'" '+(o==r.option.value?"selected":"")+">"+h+"</option>";p=p+'<option value="'+o+'" '+(o==r.option.text?"selected":"")+">"+h+"</option>"}}var w='<div class="textpanel"><span class="inputtext">参数标识：</span><input type="text" class="inputform" name="paramid" id="paramid" value="'+(r==null?"":r.id)+'" '+(t?"readonly":"")+'><font color=\'#ccc\'>(创建后不能更改)</font><br/><span class="inputtext">显示名称：</span><input type="text" class="inputform" name="paramname" id="paramname" value="'+(r==null?"":r.desc)+'"><br/><span class="inputtext">数据集：</span><select class="inputform" name="dataset" id="dataset"><option vlaue=""></option>'+u+'</select><br/><span class="inputtext">Value字段：</span><select class="inputform" name="param_option_val" id="param_option_val">'+(x?x:"")+'</select><br/><span class="inputtext">Text字段：</span><select class="inputform" name="param_option_text" id="param_option_text">'+(p?p:"")+'</select><br/><span class="inputtext">默认值：</span><input type="text" value="'+(r==null||!r.defvalue?"":r.defvalue)+'" id="defvalue" name="defvalue" class="inputform"></div>';if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:(t?"修改":"创建")+"级联参数",width:380,height:270,closed:false,cache:false,modal:true,toolbar:null,content:w,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var E=$("#dsColumn_div #paramid").val();var D=$("#dsColumn_div #paramname").val();var C=$("#dsColumn_div #dataset").val();var B=$("#dsColumn_div #param_option_val").val();var A=$("#dsColumn_div #param_option_text").val();var z=$("#dsColumn_div #defvalue").val();if(paramid==""||paramname==""){msginfo("请录入参数标识和名称。");return}if(ischinese(E)){msginfo("参数标识只能是英文字符。");$("#dsColumn_div #paramid").select();return}if(C==""||B==""||A==""){msginfo("请绑定参数到数据集。");return}if(t==false){g.children.push({id:E,desc:D,type:"casca",defvalue:z,option:{datasetid:C,value:B,text:A}})}else{r.id=E;r.desc=D;r.defvalue=z;r.option.datasetid=C;r.option.value=B;r.option.text=A}$("#pdailog #cascaparam").datagrid("loadData",b());$("#dsColumn_div").dialog("close")}},{text:"关闭",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div #dataset").bind("change",function(){document.getElementById("param_option_val").options.length=0;document.getElementById("param_option_text").options.length=0;var E=$(this).val();var D=findDatasetById(E);if(D==null){return}for(var A=0;A<D.cols.length;A++){var B=D.cols[A].dispName!=""?D.cols[A].dispName:D.cols[A].name;var F=D.cols[A].name;var z=new Option(B,F);document.getElementById("param_option_val").options.add(z);var C=new Option(B,F);document.getElementById("param_option_text").options.add(C)}})}}function newparam(q){curTmpInfo.paramvals=[];var e=null;if(q=="update"){e=findParamById(curTmpInfo.id);if(e.type=="casca"){newCascaParam("update",e.id);return}if(e.values){curTmpInfo.paramvals=e.values}}var g="";for(var h=0;pageInfo.dataset&&h<pageInfo.dataset.length;h++){g=g+'<option value="'+pageInfo.dataset[h].datasetid+'" '+(e!=null&&e.option&&pageInfo.dataset[h].datasetid==e.option.datasetid?"selected":"")+">"+pageInfo.dataset[h].name+"</option>"}var t="";var c="";var o="";if(e!=null&&e.option){var d=findDatasetById(e.option.datasetid);for(var f=0;d!=null&&f<d.cols.length;f++){var a=d.cols[f].dispName!=""?d.cols[f].dispName:d.cols[f].name;var b=d.cols[f].name;t=t+'<option value="'+b+'" '+(b==e.option.value?"selected":"")+">"+a+"</option>";c=c+'<option value="'+b+'" '+(b==e.option.text?"selected":"")+">"+a+"</option>";if(e.type=="tree"){o=o+'<option value="'+b+'" '+(b==e.option.pid?"selected":"")+">"+a+"</option>"}}}var p="";for(h=0;pageInfo.vars&&h<pageInfo.vars.length;h++){p=p+'<option value="'+pageInfo.vars[h].id+'" '+(e!=null&&e.defvalRef==pageInfo.vars[h].id?"selected":"")+">"+pageInfo.vars[h].id+"</option>"}var r=reloadParamVals(true);var s='<div class="textpanel"><span class="inputtext">参数标识：</span><input type="text" class="inputform" name="paramid" id="paramid" value="'+(e==null?"":e.id)+'" '+(q=="insert"?"":"readonly")+'><font color=\'#ccc\'>(创建后不能更改)</font><br/><span class="inputtext">显示名称：</span><input type="text" class="inputform" name="paramname" id="paramname" value="'+(e==null?"":e.desc)+'"><br/><span class="inputtext">参数类型：</span><select class="inputform" name="paramtype" id="paramtype"><option value="textField" '+(e!=null&&e.type=="textField"?"selected":"")+'>文本框</option><option value="select" '+(e!=null&&e.type=="select"?"selected":"")+'>SELECT</option><option value="dateSelect" '+(e!=null&&e.type=="dateSelect"?"selected":"")+'>日历选择</option><option value="radio" '+(e!=null&&e.type=="radio"?"selected":"")+'>RADIO</option><option value="checkbox" '+(e!=null&&e.type=="checkbox"?"selected":"")+'>CHECKBOX</option><option value="tree" '+(e!=null&&e.type=="tree"?"selected":"")+'>树形选择</option></select><br/><span class="inputtext">默认值：</span><input type="text" class="inputform" name="defvalue" id="defvalue" value="'+(e==null?"":e.defvalue)+'" style="'+(e!=null&&e.defvalType=="dtz"?"display:none":"")+'"><select id="defvalueref" name="defvalueref" class="inputform" style="'+(e==null||!e.defvalType||e.defvalType=="jtz"?"display:none":"")+'">'+p+'</select><span id="refvars" title="引用变量" tp="'+(e!=null&&e.defvalType=="dtz"?"dtz":"jtz")+'" class="link_param icon-var"></span><br/><div id="values" style="line-height:10px;display:'+(e==null?"none":(e.type=="select"||e.type=="radio"||e.type=="checkbox"?"block":"none"))+"\"><fieldset><legend>值列表</legend><div style='margin:0px 3px 3px 3px;'><label><input type='radio' id='valtype' name='valtype' value=\"static\" "+(e==null||e.valtype=="static"?"checked":"")+">静态值</label> <label><input type='radio' id='valtype' name='valtype' value=\"dynamic\" "+(e!=null&&e.valtype=="dynamic"?"checked":"")+'>动态值</label></div><div class="param_left" style="display:'+(e==null||e.valtype=="static"?"block":"none")+'"><table cellspacing="0" cellpadding="0" class="grid3"><tr><th width=\'33%\'>Value</th><th width=\'33%\'>Text</th><th width=\'33%\'>操作</th></tr>'+r+'</table></div><div style="display:'+(e==null||e.valtype=="static"?"block":"none")+'" class="param_right"><a href="javascript:newparamval(false);"><img src=\'../resource/img/edit_add.png\' border=\'0\' title=\'新增\'></a><br/></div><div id="dynamic_div" style="display:'+(e!=null&&e.valtype=="dynamic"?"block":"none")+'"><span class="inputtext">数据集：</span><select id="dataset" name="dataset" class="inputform"><option vlaue=\'\'></option>'+g+'</select><br/><span class="inputtext">Value字段：</span><select id="param_option_val" name="param_option_val" class="inputform">'+t+'</select><br/><span class="inputtext">Text字段：</span><select id="param_option_text" name="param_option_text" class="inputform">'+c+'</select><br/></div></fieldset></div><div id="treevalues" style="line-height:10px;display:'+(e==null?"none":(e.type=="tree"?"block":"none"))+'"><fieldset><legend>值列表</legend><div style="line-height:30px;"><span class="inputtext">数据集：</span><select id="treedataset" name="treedataset" class="inputform"><option vlaue=\'\'></option>'+g+'</select><br/><span class="inputtext">Value字段：</span><select id="tree_option_val" name="tree_option_val" class="inputform">'+t+'</select><br/><span class="inputtext">Text字段：</span><select id="tree_option_text" name="tree_option_text" class="inputform">'+c+'</select><br/><span class="inputtext">Pid字段：</span><select id="tree_option_pid" name="tree_option_pid" class="inputform">'+o+'</select><br/><span class="inputtext">Root默认Id：</span><input type="text" id="defrootid" name="defrootid" value="'+(e!=null&&e.option?e.option.defrootid:"")+'" class="inputform"></div></fieldset></div></div>';$("#pdailog").dialog({title:q=="insert"?"创建参数":"编辑参数",width:400,height:380,closed:false,cache:false,modal:true,toolbar:null,content:s,onLoad:function(){},buttons:[{text:"确定",handler:function(){var w=$("#pdailog #paramid").val();if(w==""){msginfo("请填写参数标识!");$("#pdailog #paramid").focus();return}if(ischinese($("#pdailog #paramid").val())){msginfo("参数标识必须是英文字符!");$("#pdailog #paramid").select();return}var v=$("#pdailog #paramname").val();var A=$("#pdailog #paramtype").val();var D=$("#pdailog #defvalue").val();var z=$("#pdailog #refvars").attr("tp");var B=$("#pdailog #defvalueref").val();if(!B||B==null){B=""}if(!pageInfo.param){pageInfo.param=[]}if(z=="dtz"){if(B==""){msginfo("参数默认值还未关联到变量。");return}}if(A=="select"||A=="radio"||A=="checkbox"){var u=$('#pdailog input[name="valtype"]:checked').val();if(u=="static"){if(!curTmpInfo.paramvals||curTmpInfo.paramvals.length==0){msginfo("您还未设置参数值。");return}}else{if($("#pdailog #dataset").val()==""||$("#pdailog #param_option_val").val()==""||$("#pdailog #param_option_text").val()==""){msginfo("您的参数还未绑定到数据集。");return}}}if(A=="tree"){if($("#pdailog #treedataset").val()==""||$("#pdailog #tree_option_val").val()==""||$("#pdailog #tree_option_text").val()==""||$("#pdailog #tree_option_pid").val()==""||$("#pdailog #defrootid").val()==""){msginfo("您的参数还未绑定到数据集。");return}}if(q=="insert"){var u=$('#pdailog input[name="valtype"]:checked').val();var C={id:w,desc:v,type:A,defvalue:D,valtype:u,defvalType:z,defvalRef:B};if(A=="select"||A=="radio"||A=="checkbox"){if(u=="static"){C.values=curTmpInfo.paramvals}else{C.option={datasetid:$("#pdailog #dataset").val(),value:$("#pdailog #param_option_val").val(),text:$("#pdailog #param_option_text").val()}}}else{if(A=="tree"){C.option={datasetid:$("#pdailog #treedataset").val(),value:$("#pdailog #tree_option_val").val(),text:$("#pdailog #tree_option_text").val(),pid:$("#pdailog #tree_option_pid").val(),defrootid:$("#pdailog #defrootid").val()}}}pageInfo.param.push(C);$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='cs']"),data:[{id:w,text:v,state:"open",iconCls:"icon-param2",attributes:{showmenu:true,type:"param"}}]});if(pageInfo.param&&pageInfo.param.length==1){$("#mydatatree").tree("expand",$("#mydatatree div[node-id='cs']"))}initviewTree()}else{var y=findParamById(w);y.desc=v;y.type=A;y.defvalue=D;y.values=curTmpInfo.paramvals;y.defvalRef=B;y.defvalType=z;var u=$('#pdailog input[name="valtype"]:checked').val();y.valtype=u;if(A=="select"||A=="radio"||A=="checkbox"){if(u=="static"){y.values=curTmpInfo.paramvals;delete y.option}else{y.option={datasetid:$("#pdailog #dataset").val(),value:$("#pdailog #param_option_val").val(),text:$("#pdailog #param_option_text").val()};delete y.values}}else{if(A=="tree"){y.option={datasetid:$("#pdailog #treedataset").val(),value:$("#pdailog #tree_option_val").val(),text:$("#pdailog #tree_option_text").val(),pid:$("#pdailog #tree_option_pid").val(),defrootid:$("#pdailog #defrootid").val()};delete y.values}}var x=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("update",{target:x.target,text:y.desc})}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #paramtype").bind("change",function(){var u=$(this).val();if(u=="select"||u=="radio"||u=="checkbox"){$("#pdailog #values").css("display","block");$("#pdailog #treevalues").css("display","none")}else{if(u=="tree"){$("#pdailog #treevalues").css("display","block");$("#pdailog #values").css("display","none")}else{$("#pdailog #treevalues").css("display","none");$("#pdailog #values").css("display","none")}}});$("#pdailog #valtype").bind("click",function(){var u=$(this).val();if(u=="static"){$("#pdailog #dynamic_div").css("display","none");$("#pdailog .param_left").css("display","block");$("#pdailog .param_right").css("display","block")}else{$("#pdailog #dynamic_div").css("display","block");$("#pdailog .param_left").css("display","none");$("#pdailog .param_right").css("display","none")}});$("#pdailog #dataset,#pdailog #treedataset").bind("change",function(){var E=$(this).attr("id");var B,A;if(E=="dataset"){B="param_option_val";A="param_option_text"}else{B="tree_option_val";A="tree_option_text"}document.getElementById(B).options.length=0;document.getElementById(A).options.length=0;if(E=="treedataset"){document.getElementById("tree_option_pid").options.length=0}var w=$(this).val();var x=findDatasetById(w);if(x==null){return}for(var z=0;z<x.cols.length;z++){var u=x.cols[z].dispName!=""?x.cols[z].dispName:x.cols[z].name;var v=x.cols[z].name;var y=new Option(u,v);document.getElementById(B).options.add(y);var D=new Option(u,v);document.getElementById(A).options.add(D);if(E=="treedataset"){var C=new Option(u,v);document.getElementById("tree_option_pid").options.add(C)}}});$("#pdailog #refvars").click(function(){var u=$(this).attr("tp");if(u=="jtz"){$("#pdailog #defvalue").css("display","none");$("#pdailog #defvalueref").css("display","inline");$(this).attr("tp","dtz")}else{$("#pdailog #defvalue").css("display","inline");$("#pdailog #defvalueref").css("display","none");$(this).attr("tp","jtz")}})}function delallparamval(){curTmpInfo.paramvals=[];reloadParamVals()}function newparamval(e,d){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var c=null;if(e&&d){for(var b=0;b<curTmpInfo.paramvals.length;b++){if(curTmpInfo.paramvals[b].value==d){c=curTmpInfo.paramvals[b];break}}}var a='<div class="textpanel"><span class="inputtext">Value：</span><input type="text"  id="val" name="val" class="inputform" value="'+(c==null?"":c.value)+'"><span class="inputtext">Text：</span><input type="text"  id="txt" name="txt" class="inputform" value="'+(c==null?"":c.text)+'"></div>';$("#dsColumn_div").dialog({title:(e==false?"添加值":"编辑值"),width:300,height:170,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){if(e){c.value=$("#dsColumn_div #val").val();c.text=$("#dsColumn_div #txt").val()}else{curTmpInfo.paramvals.push({value:$("#dsColumn_div #val").val(),text:$("#dsColumn_div #txt").val()})}reloadParamVals();$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function exportPage(){if(!curTmpInfo.comps||curTmpInfo.comps.length==0){msginfo("您还未添加任何组件。");return}var b=checkCompErrInfo();if(b.length!=0){msginfo("报表存在错误信息，请修正后再导出。");return}var a="<form action=\"ReportExport.action\" method=\"post\"><input type='hidden' name='pageInfo' id='pageInfo'><input type='hidden' name='type' id='type'><div class='exportpanel'><span class='exptp select' tp='html'><img src='../resource/img/export-html.gif'><br>HTML</span><span class='exptp' tp='csv'><img src='../resource/img/export-csv.gif'><br>CSV</span><span class='exptp' tp='excel'><img src='../resource/img/export-excel.gif'><br>EXCEL</span><span class='exptp' tp='word'><img src='../resource/img/export-word.gif'><br>WORD</span><span class='exptp' tp='pdf'><img src='../resource/img/export-pdf.gif'><br>PDF</span></div></form>";$("#pdailog").dialog({title:"导出数据",width:376,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},buttons:[{text:"确定",handler:function(){initSubmitData(true);var c=JSON.stringify(pageInfo);$("#pdailog #pageInfo").val(c);$("#pdailog #type").val(curTmpInfo.expType);$("#pdailog form").submit();$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});curTmpInfo.expType="html";$(".exportpanel span.exptp").click(function(c){$(".exportpanel span.exptp").removeClass("select");$(this).addClass("select");curTmpInfo.expType=$(this).attr("tp")})}function releasePage(){if(!curTmpInfo.comps||curTmpInfo.comps.length==0){msginfo("您还未添加任何组件。");return}var a=checkCompErrInfo();if(a.length!=0){msginfo("报表存在错误信息，请修正后再发布。");return}$("#pdailog").dialog({title:"报表发布",width:612,height:420,closed:false,cache:false,modal:true,toolbar:null,content:'<div style="margin:5px 5px 5px 1px;"><span class="inputtext">报表目录：</span><input id="reportcatalist" style="width:200px;"></div><div style="border-bottom:solid 1px #CCCCCC;border-top:solid 1px #CCCCCC;"><table id="reportlist" title="" style="width:600px;height:270px;"><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'name\',width:320">名称</th><th data-options="field:\'crtdate\',width:100">创建时间</th><th data-options="field:\'loginName\',width:100">创建人</th></tr></thead></table></div><div style="margin:5px;"><span class="inputtext">报表名称：</span><input type="text" style="width:187px" name="rname" id="rname"></div>',onLoad:function(){},buttons:[{text:"确定",handler:function(){var d=$("#pdailog #reportcatalist").combotree("tree").tree("getSelected");if(d==null||d.id=="0"){msginfo("您还未选择报表发布目录。");return}var b=$("#pdailog #rname").val();if(b==""){msginfo("请输入报表名称！");$("#pdailog #rname").focus();return}var c=JSON.stringify(pageInfo);$.ajax({type:"POST",url:"ReportMain!release.action",dataType:"json",data:{pageName:b,cataId:d.id,pageInfo:c},async:false,success:function(e){msginfo("报表发布成功。","suc");pageInfo.releCata=d.id;curTmpInfo.isupdate=true;$("#pdailog").dialog("close")},error:function(){msginfo("报表发布出错。")}})}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #reportcatalist").combotree({url:"../report/ReportCatalog!tree.action?type=-1",onClick:function(b){$("#reportlist").datagrid("load",{cataId:b.id,t:Math.random()})}});if(pageInfo.releCata){$("#pdailog #reportcatalist").combotree("setValues",[pageInfo.releCata])}$("#pdailog #reportlist").datagrid({singleSelect:true,collapsible:false,border:false,url:"../report/Report!listRelease.action",method:"post",queryParams:{cataId:pageInfo.releCata?pageInfo.releCata:"-1",t:Math.random()},onSelect:function(b,c){$("#pdailog #rname").val(c.name)}})}function initkeyborad(){$(document).keypress(function(a){if(a.shiftKey&&a.which==83){savepage()}if(a.shiftKey&&a.which==86){savepage(null,true)}if(a.shiftKey&&a.which==82){releasePage()}})}function printData(){var c=JSON.stringify(pageInfo);var d="about:blank";var b="printwindow";window.open(d,b);var a="<form name='prtff' method='post' target='printwindow' action=\"ReportMain!print.action\" id='expff'><textarea name='pageInfo' id='pageInfo'>"+c+"</textarea></form>";$(a).appendTo("body").submit().remove()}function pushData(){var a='<div style="margin:5px 5px 5px 1px;"><span class="inputtext">推送目录：</span><input id="3gcatalist" style="width:200px;"></div><div style="border-bottom:solid 1px #CCCCCC;border-top:solid 1px #CCCCCC;"><table id="3glist" title="" style="width:555px;height:250px;"><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'title\',width:220">页面名称</th><th data-options="field:\'cataName\',width:100">所属分类</th><th data-options="field:\'crtdate\',width:100">推送时间</th><th data-options="field:\'loginname\',width:100">推送人</th></tr></thead></table></div><div style="margin:5px;"><span class="inputtext">页面名称：</span><input type="text" name="pageName" id="pageName" style="width:187px;" ></div>';$("#pdailog").dialog({title:"推送手机页面",width:580,height:390,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",handler:function(){var f=$("#pdailog #3gcatalist").combotree("tree").tree("getSelected");if(f==null||f.id=="0"){msginfo("您还未选择推送目录。");return}var e=$("#pdailog #pushType").val();var b=$("#pdailog #pageName").val();var d=$("#pdailog #pageNote").val();if(e==""){msginfo("请选择数据推送到哪里？");return}if(b==""){msginfo("请填写推送的页面名称！");$("#pdailog #pageName").focus();return}if(d==""){msginfo("请填写推送的页面说明信息！");$("#pdailog #pageNote").focus();return}var c=JSON.stringify(pageInfo);$.ajax({type:"POST",url:"ReportMain!push.action",data:{pushType:e,pageName:b,pageNote:d,cataId:f.id,pageInfo:c},success:function(){msginfo("数据推送成功！","suc")}});$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #3gcatalist").combotree({url:"../report/Report!list3GCata.action",onClick:function(b){$("#pdailog #3glist").datagrid("load",{cataId:b.id,t:Math.random()})}});$("#pdailog #3glist").datagrid({singleSelect:true,collapsible:false,border:false,url:"../report/Report!list3G.action",method:"post",queryParams:{t:Math.random()},onSelect:function(b,c){$("#pdailog #pageName").val(c.title)}})}function openreport(){var a='<div class="openlistbody"><div style="margin:5px 5px 5px 1px;float:left;">报表目录： <input id="cataSelect" style="width:200px;"></div><div align="right" style="margin:5px;"><input id="subSearchBox" style="width:160px"></input></div><div class="openlist"></div></div>';$("#pdailog").dialog({title:"打开报表",width:620,height:400,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},buttons:[{text:"确定",handler:function(){var c=$('input[name="reportId"]:checked').val();if(!c||c==null){msginfo("请至少选择一个报表！");return}$("#pdailog").dialog("close");$(this).attr("href","#");var b="ReportMain.action?pageId="+c+"&showtit="+showtit+"&menus="+curTmpInfo.menus;if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(function(){location.href=b})}else{location.href=b}}else{location.href=b}}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#cataSelect").combotree({url:"../report/ReportCatalog!tree.action?type=1",onClick:function(b){$("#pdailog .openlist").load("MyReport!list.action?cataId="+b.id+"&t="+Math.random())}});$("#subSearchBox").searchbox({searcher:function(c,b){$("#pdailog .openlist").load("MyReport!list.action",{keyword:c,t:Math.random()})},prompt:"请输入查询关键字."});$("#pdailog .openlist").load("MyReport!list.action?t="+Math.random())}function helper(){$("#pdailog").dialog({title:"使用帮助",width:300,height:200,closed:false,cache:false,modal:true,toolbar:null,buttons:[{text:"关闭",iconCls:"icon-ok",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","Helper.action")}function error_info(){var a=checkCompErrInfo();var b='<div class="textpanel">';if(a.length==0){b=b+"很棒！ 无错误信息。"}else{for(i=0;i<a.length;i++){b=b+a[i].name+'： <font color="red">'+a[i].msg+"</font> <br/>"}}b=b+"</div>";$("#pdailog").dialog({title:"查看报表错误信息",width:550,height:300,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:b,buttons:[{text:"确定",handler:function(){$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})}function msginfo(a,c){var b=null;if(c&&c=="suc"){b="<div class='msginfo msgsuc'>"+a+"</div>"}else{b="<div class='msginfo msgerr'>"+a+"</div>"}$.messager.show({title:(c&&c=="suc")?"成功了":"出错了",msg:b,showType:"fade",timeout:2000,style:{right:"",top:document.body.scrollTop+document.documentElement.scrollTop+10,bottom:""}})}function newGuid(){var a="";for(var b=1;b<=32;b++){var c=Math.floor(Math.random()*16).toString(16);a+=c}return a}function encoder(h,g){var f=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","1","2","3","4","5","6","7","8","9","0",".","-","*","/","'",":",";",">","<","~","!","@","#","$","%","^","&","(",")","{","}","[","]","|","_","=",","];var e=["T","l","m",">","S","&","J","G","/","!","p","h","Z","7","q","_","U","(","0","a","X","f","^","@","D","~","M","t","O","6","9","C","N","K","H","g","w","4","F","<","e","2","R","o","$","d","V","v","]","#","[","L","r","b","Y","{","z","k","x","n","5","B","W","-","A","P","1","j","E","u","s","'","I","c","%",".","i","y","Q","*",")","3","8","}",";",":","|","=",","];var a=function(q,c){var r=-1;for(var p=0;p<c.length;p++){if(q==c[p]){r=p;break}}return r};var d="";if(g=="encode"){for(var b=0;b<h.length;b++){var o=h.charAt(b);d=d+e[a(o,f)]}}else{if(g=="decode"){for(var b=0;b<h.length;b++){var o=h.charAt(b);d=d+f[a(o,e)]}}}return d}function findDatasourceById(a){var b=null;for(i=0;pageInfo.datasource&&i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==a){b=pageInfo.datasource[i]}}return b}function findDatasetById(a){var b=null;for(var c=0;pageInfo.dataset&&c<pageInfo.dataset.length;c++){var e=pageInfo.dataset[c];if(e.datasetid==a){b=e;break}}return b}function fundCubeById(c){var a=null;for(var b=0;pageInfo.cube&&b<pageInfo.cube.length;b++){var e=pageInfo.cube[b];if(e.id==c){a=e;break}}return a}function findLayoutById(a){var c=null;for(var d=1;true;d++){var e=pageInfo.body["tr"+d];if(!e||e==null){break}for(var b=0;b<e.length;b++){var f=e[b];if(f.id==a){c=f;break}}}return c}function findParamById(a){var b=null;for(var c=0;pageInfo.param&&c<pageInfo.param.length;c++){if(pageInfo.param[c].id==a){b=pageInfo.param[c];break}}return b}function findVarById(c){var a=null;for(var b=0;pageInfo.vars&&b<pageInfo.vars.length;b++){if(pageInfo.vars[b].id==c){a=pageInfo.vars[b];break}}return a}function ischinese(b){if(/[\u4E00-\u9FA5]/i.test(b)){return true}else{return false}}if($==undefined){$=jQuery}function regCompTree(){$("#comp_tree").tree({dnd:true,onBeforeDrag:function(a){return true},onDragEnter:function(b,a){return false}});initCompDropEvent()}function initCompDropEvent(a){var b;if(a){b="#"+a}else{b="#layout_table td.laytd,#layout_table div.comp_table"}$(b).droppable({accept:"#comp_tree .tree-node, #layout_table div.comp_table",onDragEnter:function(h,f){if($(f).hasClass("comp_table")){var g=$(this);if(g.attr("ctp")=="comp"){var o=$(this).offset();$(".indicator").css({display:"block",left:o.left-10,top:o.top-5});curTmpInfo.curComp={tp:"zjj",obj:g};h.cancelBubble=true;h.stopPropagation()}else{var d=null;var c=false;if(g.children().size()==0){d=g}else{d=g.children().last();c=true}curTmpInfo.curComp={tp:"zjw",obj:g};var o=$(d).offset();$(".indicator").css({display:"block",left:o.left-10,top:o.top-5+(c?$(d).height():0)})}}else{$(f).draggable("proxy").find("span").removeClass("tree-dnd-no");$(f).draggable("proxy").find("span").addClass("tree-dnd-yes")}},onDragLeave:function(h,f){if($(f).hasClass("comp_table")){var g=$(this);if(h.target.tagName=="DIV"){var d=null;var c=false;if(g.children().size()==0){d=g}else{d=g.children().last();c=true}curTmpInfo.curComp={tp:"zjw",obj:g};var o=$(d).offset();$(".indicator").css({display:"block",left:o.left-10,top:o.top-5+(c?$(d).height():0)})}}else{$(f).draggable("proxy").find("span").addClass("tree-dnd-no");$(f).draggable("proxy").find("span").removeClass("tree-dnd-yes")}},onDrop:function(g,f){if($(f).hasClass("comp_table")){if(curTmpInfo.curComp.tp&&curTmpInfo.curComp.tp=="zjj"){$(f).insertBefore(curTmpInfo.curComp.obj);g.cancelBubble=true;g.stopPropagation()}else{if(curTmpInfo.curComp.tp&&curTmpInfo.curComp.tp=="zjw"){$(curTmpInfo.curComp.obj).append(f)}}$(".indicator").hide()}else{var d=$("#datasettree").tree("getNode",f);var h=(d.attributes.tp);var c=$("#"+g.target.id).attr("id").split("_")[1];if(h=="text"){insertText("insert",c)}else{if(h=="label"){insertLabel(c)}else{if(h=="chart"){insertChart("insert",c)}else{if(h=="cross"){insertCrossReport(c)}else{if(h=="table"){insertTable(c)}else{if(h=="pic"){insertPic(c)}else{if(h=="staticCross"){curTmpInfo.scrossTable.create(c)}}}}}}}}}})}function layoutInsertComp(b){var a=curTmpInfo.layoutId;if(b=="text"){insertText("insert",a)}else{if(b=="label"){insertLabel(a)}else{if(b=="chart"){insertChart("insert",a)}else{if(b=="cross"){insertCrossReport(a)}else{if(b=="table"){insertTable(a)}else{if(b=="pic"){insertPic(a)}else{if(b=="staticCross"){curTmpInfo.scrossTable.create(a)}}}}}}}}function addComp(b,a,f){var c=b;var e=findLayoutById(a);if(f){if(!e.children){e.children=[]}e.children.push(c);if(!curTmpInfo.comps){curTmpInfo.comps=[]}curTmpInfo.comps.push(c);initviewTree()}var g='<div class="comp_table" type="'+c.type+'" ctp="comp" id="'+c.id+'" style="'+(c.type=="cross"||c.type=="staticCross"||c.type=="table"?"border:none":"")+'"><div class="ctx" style=\'';if(c.type=="text"){var d=curTmpInfo.property.setLabelStyle(b,true);g=g+d}else{if(c.type=="label"){var d=curTmpInfo.property.setLabelStyle(b,true);g=g+d}else{if(c.type=="cross"||c.type=="table"||c.type=="staticCross"){g=g+"padding:0px;"}else{if(c.type=="chart"){g=g+"text-align:"+(c.chartJson.align?c.chartJson.align:"center")+";"}else{if(c.type=="pic"){g=g+(c.style&&c.style.align?"text-align:"+c.style.align+";":"")}}}}}g=g+"'>";if(c.type=="text"){g=g+b.desc.replace(/\n/g,"<br>")}else{if(c.type=="label"){g=g+b.desc}else{if(c.type=="chart"){g=g+'<img src="../ext-res/image/large-loading.gif" '+(b.chartJson.width?"width="+b.chartJson.width:"")+" "+(b.chartJson.height?"height="+b.chartJson.height:"")+">"}else{if(c.type=="cross"){g=g+crtCrossTable(b)}else{if(c.type=="staticCross"){g=g+curTmpInfo.scrossTable.crtStaticTable(b)}else{if(c.type=="table"){g=g+crtTable(b)}else{if(c.type=="pic"){if(c.income=="file"){g=g+'<img src="../pic/'+c.url+'" '+(c.style&&c.style.width&&c.style.width!=""?"width='"+c.style.width+"'":"")+" "+(c.style&&c.style.height&&c.style.height!=""?"height='"+c.style.height+"'":"")+">"}else{g=g+'<img src="'+c.url+'" '+(c.style&&c.style.width&&c.style.width!=""?"width='"+c.style.width+"'":"")+" "+(c.style&&c.style.height&&c.style.height!=""?"height='"+c.style.height+"'":"")+">"}}}}}}}}g=g+"</div></div>";return g}function deletecomp(){var b=curTmpInfo.layoutId;var e=curTmpInfo.compId;var f=findLayoutById(b);var c=-1;for(var d=0;f.children&&d<f.children.length;d++){if(f.children[d].id==e){c=d;break}}f.children.splice(c,1);var a=findCompById(e,true);curTmpInfo.comps.splice(a,1);$("#"+e).remove();initviewTree();curTmpInfo.property.setLayoutProp()}function editcomp(){var a=curTmpInfo.layoutId;var c=curTmpInfo.compId;var b=findCompById(c);if(b.type=="text"){insertText("update",a)}else{if(b.type=="label"){editLabel(b,a)}else{if(b.type=="chart"){insertChart("update",a,b)}else{if(b.type=="pic"){insertPic(a,true,b)}}}}}function compBorderSet(a){$("#layout_table table.gridtab td").removeClass("tdselect");$("table.crosstab2 td").removeClass("tdselect");$(".comp_table table.d_table div.crskpi2").removeClass("cellselect");$("#layout_table .comp_table").each(function(){var c=$(this).attr("type");$(this).css("border",(c=="table"||c=="staticCross"||c=="cross"?"0":"1")+"px solid #cccccc")});if(a){var b=a.attr("type");a.css("border",(b=="table"||b=="staticCross"||b=="cross"?"1":"2")+"px solid #999999")}}function regCompEvent(b){if(!curTmpInfo.comps){return}var c=function(d){$("#"+d.id).bind("click",function(e){if(d.type=="table"){return}compBorderSet($(this));setProp($(this).parent().attr("id").split("_")[1],d.id)}).bind("contextmenu",function(f){if(d.type=="table"){return}f.preventDefault();f.stopPropagation();compBorderSet($(this));$("#comprightmenu").menu("show",{left:f.pageX,top:f.pageY});curTmpInfo.layoutId=$(this).parent().attr("id").split("_")[1];curTmpInfo.compId=d.id;if(d.type=="cross"||d.type=="staticCross"){$("#comprightmenu").menu("disableItem",$("#m_editcomp"))}else{$("#comprightmenu").menu("enableItem",$("#m_editcomp"))}if(!curTmpInfo.copycomp){$("#comprightmenu").menu("disableItem",$("#m_paste"))}else{$("#comprightmenu").menu("enableItem",$("#m_paste"))}if(d.type=="chart"||d.type=="table"||d.type=="cross"){$("#comprightmenu").menu("enableItem",$("#m_compevent"))}else{$("#comprightmenu").menu("disableItem",$("#m_compevent"))}setProp(curTmpInfo.layoutId,d.id)}).draggable({revert:true,disabled:true,proxy:function(g){var f=$(g).width();var e=$(g).height();var h=$('<div style="border:1px solid #999999;background-color:#cccccc; opacity:0.5; filter:alpha(opacity=50); width:'+f+"px; height:"+e+'px;"></div>');h.appendTo("body");return h},onBeforeDrag:function(f){},onStartDrag:function(f){},onStopDrag:function(f){$(this).draggable("disable");initSubmitData(false)}})};if(b){c(b)}else{for(i=0;i<curTmpInfo.comps.length;i++){var a=curTmpInfo.comps[i];c(a)}}}function crtChartDataHtml(f){var d=curTmpInfo.chart.chartJson.type=="pie"||curTmpInfo.chart.chartJson.type=="gauge";var q=curTmpInfo.chart.chartJson.type=="bubble"||curTmpInfo.chart.chartJson.type=="scatter";var c=curTmpInfo.chart.chartJson.type=="bubble";var g="";for(var h=0;pageInfo.dataset&&h<pageInfo.dataset.length;h++){g=g+'<option value="dset@'+pageInfo.dataset[h].datasetid+'" '+(pageInfo.dataset[h].datasetid==f?"selected":"")+">"+pageInfo.dataset[h].name+"</option>"}for(var h=0;pageInfo.cube&&h<pageInfo.cube.length;h++){g=g+'<option value="cube@'+pageInfo.cube[h].id+'" '+(pageInfo.cube[h].id==f?"selected":"")+">"+pageInfo.cube[h].name+"</option>"}var e="";if(curTmpInfo.chart.chartJson.xcol&&curTmpInfo.chart.chartJson.xcol.id){e='<span class="charttxt">'+curTmpInfo.chart.chartJson.xcol.dimdesc+"</span><span onclick=\"chartmenu(this, '"+curTmpInfo.chart.chartJson.xcol.id+"','xcol', '"+curTmpInfo.chart.chartJson.xcol.dimdesc+'\')" title="配置" class="charticon"></span>'}else{e='<span class="charttip">拖拽字段到这里</span>'}var b="";var a="";var p="";if(curTmpInfo.chart.kpiJson&&curTmpInfo.chart.kpiJson.length>0){b='<span title="聚合方式" onclick="chartAggreType(this)" class="grouptype"></span><span class="charttxt" style="width:72px;">'+curTmpInfo.chart.kpiJson[0].kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, \''+curTmpInfo.chart.kpiJson[0].kpi_id+"','ycol','"+curTmpInfo.chart.kpiJson[0].kpi_name+"')\"></span>";if(curTmpInfo.chart.kpiJson[1]!=null){a='<span title="聚合方式" onclick="chartAggreType(this)" class="grouptype"></span><span class="charttxt" style="width:72px;">'+curTmpInfo.chart.kpiJson[1].kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, \''+curTmpInfo.chart.kpiJson[1].kpi_id+"','y2col','"+curTmpInfo.chart.kpiJson[1].kpi_name+"')\"></span>"}else{a='<span class="charttip">拖拽字段到这里</span>'}if(curTmpInfo.chart.kpiJson[2]!=null){p='<span title="聚合方式" onclick="chartAggreType(this)" class="grouptype"></span><span class="charttxt" style="width:72px;">'+curTmpInfo.chart.kpiJson[2].kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, \''+curTmpInfo.chart.kpiJson[2].kpi_id+"','y3col','"+curTmpInfo.chart.kpiJson[2].kpi_name+"')\"></span>"}else{p='<span class="charttip">拖拽字段到这里</span>'}}else{p=a=b='<span class="charttip">拖拽字段到这里</span>'}var o="";if(curTmpInfo.chart.chartJson.scol&&curTmpInfo.chart.chartJson.scol.id){o='<span class="charttxt">'+curTmpInfo.chart.chartJson.scol.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, \''+curTmpInfo.chart.chartJson.scol.id+"','scol', '"+curTmpInfo.chart.chartJson.scol.dimdesc+"')\"></span>"}else{o='<span class="charttip">拖拽字段到这里</span>'}return'<div class="tsbd"><div class="ts_h">'+(q?'横轴：<div class="h_ctx" id="y2col">'+a+"</div>":((d?"观察维度":"横轴")+'：<div id="xcol" class="h_ctx">'+e+"</div>"))+'</div><div class="ts_h">'+(d?"指标":"纵轴")+'：<div id="ycol" class="h_ctx">'+b+"</div></div>"+(c?'<div class="ts_h">气泡大小：<div id="y3col" class="h_ctx">'+p+"</div></div>":"")+(q?'<div class="ts_h" >观察维度：<div id="xcol" class="h_ctx">'+e+"</div></div>":"")+(c?"":'<div class="ts_h" '+(d||((curTmpInfo.chart.chartJson.type=="column"||curTmpInfo.chart.chartJson.type=="line")&&curTmpInfo.chart.chartJson.typeIndex=="2")?'style="display:none"':"")+'>图例：<div id="scol" class="h_ctx">'+o+"</div></div>")+((curTmpInfo.chart.chartJson.type=="column"||curTmpInfo.chart.chartJson.type=="line")&&curTmpInfo.chart.chartJson.typeIndex=="2"?'<div class="ts_h">第二纵轴：<div class="h_ctx" id="y2col">'+a+"</div></div>":"")+'<div class="fgx"></div><div class="ts_h">数据：<font color=\'#999999\'>(请先选数据)</font><div class="h_ctx"><select id="selDataset" onchange="changeChartData(1)" name="selDataset" style="width:116px;"><option value=\'\'></option>'+g+'</select></div><div id="datacol" class="h_ctx datacol" style="'+(q?"height:110px;":"")+'"></div></div></div>'+(d||q||((curTmpInfo.chart.chartJson.type=="column"||curTmpInfo.chart.chartJson.type=="line")&&curTmpInfo.chart.chartJson.typeIndex=="2")?"":"<div class=\"exchangexs\"><img src='../resource/img/exchangexs1.gif' height='70'><a title='交换维度' href='javascript:exchangexs();'><img src='../resource/img/reload.png' border='0'></a><img src='../resource/img/exchangexs2.gif' height='50'></div>")+'<div class="chartctx">图形预览区域</div>'}function exchangexs(){var a=curTmpInfo.chart;if(a.chartJson==undefined||(a.chartJson.xcol==undefined&&a.chartJson.scol==undefined)){msginfo("您还未选择维度。")}var b=a.chartJson.xcol;a.chartJson.xcol=a.chartJson.scol;a.chartJson.scol=b;if(a.chartJson.xcol&&a.chartJson.xcol.id){var c=a.chartJson.xcol;$("#charttabs #xcol").html('<span class="charttxt">'+(c.dimdesc?c.dimdesc:"")+'</span><span class="charticon" title="配置" onclick="chartmenu(this, \''+c.id+"','xcol', '"+c.dimdesc+"')\"></span>")}else{$("#charttabs #xcol").html('<span class="charttip">拖拽字段到这里</span>')}if(a.chartJson.scol&&a.chartJson.scol.id){var c=a.chartJson.scol;$("#charttabs #scol").html('<span class="charttxt">'+(c.dimdesc?c.dimdesc:"")+'</span><span class="charticon" title="配置" onclick="chartmenu(this, \''+c.id+"','scol', '"+c.dimdesc+"')\"></span>")}else{$("#charttabs #scol").html('<span class="charttip">拖拽字段到这里</span>')}curTmpInfo.isupdate=true;chartview()}function changeChartData(a){if(a==1){delChartKpiOrDim(true)}var h=$("#charttabs #selDataset").val();if(h==""){$("#charttabs #datacol").html("");return}var r=h.split("@");h=r[1];tp=r[0];var c=[];if(tp=="dset"){curTmpInfo.chart.datasetid=h;curTmpInfo.chart.income="dset";var o=findDatasetById(h);for(var f=0;f<o.cols.length;f++){c.push({id:o.cols[f].name,text:(o.cols[f].dispName==""?o.cols[f].name:o.cols[f].dispName),iconCls:"icon-dscol",attributes:{vtype:o.cols[f].type,income:"dset",colname:o.cols[f].name}})}}else{curTmpInfo.chart.cubeid=h;curTmpInfo.chart.income="cube";var b=fundCubeById(h);for(var f=0;f<b.dim.length;f++){var g=b.dim[f];if(g.tp=="group"){for(var e=0;e<g.children.length;e++){var p=g.children[e];c.push({id:p.id,text:p.name,iconCls:"icon-dim",attributes:{vtype:"String",income:"cube",tname:p.tname,type:p.dim_type,dimord:p.dimord,dimkey:p.dimkey,dimtxt:p.dimtxt,ordcol:p.ordcol,from:"dim"}})}}else{c.push({id:g.id,text:g.name,iconCls:"icon-dim",attributes:{vtype:"String",income:"cube",tname:g.tname,type:g.dim_type,dimord:g.dimord,dimkey:g.dimkey,dimtxt:g.dimtxt,ordcol:g.ordcol,from:"dim"}})}}for(var f=0;f<b.kpi.length;f++){var q=b.kpi[f];c.push({id:q.id,text:q.name,iconCls:"icon-kpi",attributes:{vtype:"Double",income:"cube",aggre:q.aggre,calc:q.calc,fmt:q.fmt,unit:q.unit,colname:q.id,expression:q.expression,from:"kpi"}})}}$("#charttabs #datacol").tree({dnd:true,data:c,onDragEnter:function(s,d){return false}})}function setChartProp2(a){var b=$(a);var d=curTmpInfo.chart;if(b.attr("id")=="title"){d.chartJson.title=b.val()}else{if(b.attr("id")=="showLegend"){d.chartJson.showLegend=$(".chart_set input[name='showLegend']").attr("checked")==undefined?false:true}else{if(b.attr("id")=="legendLayout"){d.chartJson.legendLayout=b.val()}else{if(b.attr("id")=="legendpos"){d.chartJson.legendpos=b.val()}else{if(b.attr("id")=="labelType"){d.chartJson.labelType=b.val()}else{if(b.attr("id")=="distance"){d.chartJson.distance=b.val()}else{if(b.attr("id")=="xtitle"){d.chartJson.xcol.dimdesc=b.val()}else{if(b.attr("id")=="routeXaxisLable"){d.chartJson.xcol.routeXaxisLable=b.val()}else{if(b.attr("id")=="tickInterval"){d.chartJson.xcol.tickInterval=b.val()}else{if(b.attr("id")=="ytitle"){d.kpiJson[0].kpi_name=b.val()}else{if(b.attr("id")=="yfmt"){d.kpiJson[0].fmt=b.val()}else{if(b.attr("id")=="ymin"){d.kpiJson[0].min=b.val()}else{if(b.attr("id")=="ymax"){d.kpiJson[0].ymax=b.val()}else{if(b.attr("id")=="yunit"){d.kpiJson[0].unit=b.val()}else{if(b.attr("id")=="rate"){d.kpiJson[0].rate=b.val()}else{if(b.attr("id")=="top"){d.chartJson.xcol.top=b.val()}else{if(b.attr("id")=="dataLabel"){d.chartJson.dataLabel=$(".chart_set input[name='dataLabel']").attr("checked")==undefined?false:true}else{if(b.attr("id")=="kpi_name2"){d.kpiJson[1].kpi_name=b.val()}else{if(b.attr("id")=="yunit2"){d.kpiJson[1].unit=b.val()}else{if(b.attr("id")=="yfmt2"){d.kpiJson[1].fmt=b.val()}else{if(b.attr("id")=="rate2"){d.kpiJson[1].rate=b.val()}}}}}}}}}}}}}}}}}}}}}chartview("chartsetdiv")}function insertPic(a,c,b){$("#pdailog").dialog({title:c?"编辑图片":"添加图片",width:520,height:460,closed:false,cache:false,modal:true,toolbar:null,content:'<form id="picForm" name="picForm" method="post" action="Chart!uploadPic.action" target="picUploadFrm" enctype="multipart/form-data"><div class="textpanel"><span class="inputtext">图片来源：</span><input type="radio" name="income" checked value="url">URL<br/><span class="inputtext"> </span><input type="radio" name="income" value="file">本地文件上传<div class="picline"></div><div id="income1">URL地址：<input type="text" name="picurl" size="50"><input type="button" value="加载"></div><div id="income2" style="display:none">上传文件：<input type="file" name="image" size="50"><input type="hidden" name="picurl2"><input type="button" value="上传"></div><div id="ldpicpos"></div></div></form>',onLoad:function(){},buttons:[{text:"确定",handler:function(){var d=$('#pdailog input[name="income"]:checked').val();var f="";if(d=="url"){f=$('#pdailog input[name="picurl"]').val()}else{if(d=="file"){f=$('#pdailog input[name="picurl2"]').val()}}if(f==""){msginfo("请选择或上传图片。");return}if(c){b.url=f;b.income=d;b.url=f;$("#"+b.id+" div.ctx img").attr("src",d=="url"?f:"../pic/"+f)}else{var e={id:newGuid(),type:"pic",name:"图片组件",url:f,income:d};var g=addComp(e,a,true);$("#layout_"+a).append(g);regCompEvent(e);initCompDropEvent(e.id)}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #income1 input[type='button']").bind("click",function(){var d=$("#pdailog input[name='picurl']").val();if(d==""){msginfo("请填写URL地址，再点击加载按钮。");$("#pdailog input[name='picurl']").focus();return}$("#pdailog #ldpicpos").html('<img src="'+d+'">')});$("#pdailog input[type='radio']").bind("click",function(){if($(this).val()=="url"){$("#pdailog #income1").css("display","");$("#pdailog #income2").css("display","none")}else{if($(this).val()=="file"){$("#pdailog #income1").css("display","none");$("#pdailog #income2").css("display","")}}});$("#pdailog #income2 input[type='button']").bind("click",function(){var d=$("#pdailog input[name='image']").val();if(d==""){msginfo("请选择上传的图片。");return}$("#pdailog #ldpicpos").html('<iframe name="picUploadFrm" frameborder="0" width="98%" height="98%" id="picUploadFrm"></iframe>');$("#pdailog #picForm").submit()})}function insertChart(tp,layoutId,comp){curTmpInfo.chartstep=0;if(tp=="insert"){curTmpInfo.chart={kpiJson:[],chartJson:{type:"line"}}}else{curTmpInfo.chart=eval("("+JSON.stringify(comp)+")")}$("#pdailog").dialog({title:tp=="insert"?"创建图表":"编辑图表",width:800,height:480,closed:false,cache:false,modal:true,toolbar:null,content:'<div id="charttabs"><div title="图表类型" href="Chart!chartType.action"></div><div title="图表数据"></div><div title="图表配置"></div></div>',onLoad:function(){},onClose:function(){curTmpInfo.chart=null},buttons:[{id:"syb",text:"上一步",disabled:true,handler:function(){$("#pdailog #xyb").linkbutton("enable");curTmpInfo.chartstep=curTmpInfo.chartstep-1;if(curTmpInfo.chartstep==0){$("#pdailog #syb").linkbutton("disable")}$("#pdailog #charttabs").tabs("select",curTmpInfo.chartstep)}},{id:"xyb",text:"下一步",handler:function(){$("#pdailog #syb").linkbutton("enable");curTmpInfo.chartstep=curTmpInfo.chartstep+1;if(curTmpInfo.chartstep==2){$("#pdailog #xyb").linkbutton("disable")}$("#pdailog #charttabs").tabs("select",curTmpInfo.chartstep)}},{id:"comlit",text:"完 成",disabled:tp=="insert"?true:false,handler:function(){var issetkpi=false;if(curTmpInfo.chart.kpiJson&&curTmpInfo.chart.chartJson.type!="scatter"&&curTmpInfo.chart.chartJson.type!="bubble"&&curTmpInfo.chart.kpiJson.length>0){issetkpi=true}if(curTmpInfo.chart.chartJson.type=="scatter"&&curTmpInfo.chart.kpiJson&&curTmpInfo.chart.kpiJson[0]!=null&&curTmpInfo.chart.kpiJson[1]!=null){issetkpi=true}if(curTmpInfo.chart.chartJson.type=="bubble"&&curTmpInfo.chart.kpiJson&&curTmpInfo.chart.kpiJson[0]!=null&&curTmpInfo.chart.kpiJson[1]!=null&&curTmpInfo.chart.kpiJson[2]!=null){issetkpi=true}if(issetkpi==false){msginfo("您还未设置图形指标。");return}if(tp=="insert"){var obj={id:newGuid(),datasetid:curTmpInfo.chart.datasetid,type:"chart",name:"图形组件",chartJson:curTmpInfo.chart.chartJson,kpiJson:curTmpInfo.chart.kpiJson,income:curTmpInfo.chart.income,cubeid:curTmpInfo.chart.cubeid};obj.chartJson.width="600";obj.chartJson.height="250";var str=addComp(obj,layoutId,true);$("#layout_"+layoutId).append(str);regCompEvent(obj);initCompDropEvent(obj.id);chartview(null,function(resp){$("#"+obj.id+" div.ctx img").attr("src","Chart!showPic.action?mvid="+resp+"&T="+Math.random())},"Chart!toPic.action")}else{comp.kpiJson=curTmpInfo.chart.kpiJson;comp.chartJson=curTmpInfo.chart.chartJson;comp.income=curTmpInfo.chart.income;comp.cubeid=curTmpInfo.chart.cubeid;comp.datasetid=curTmpInfo.chart.datasetid;var id=curTmpInfo.chart.id;chartview(null,function(resp){$("#"+id+" div.ctx img").attr("src","Chart!showPic.action?mvid="+resp+"&T="+Math.random())},"Chart!toPic.action")}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取 消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #charttabs").tabs({border:false,fit:true,tabPosition:"top",plain:false,onSelect:function(title,index){curTmpInfo.chartstep=index;if(curTmpInfo.chartstep==2){$("#pdailog #xyb").linkbutton("disable");$("#pdailog #syb").linkbutton("enable")}else{if(curTmpInfo.chartstep==0){$("#pdailog #syb").linkbutton("disable");$("#pdailog #xyb").linkbutton("enable")}else{$("#pdailog #syb,#pdailog #xyb").linkbutton("enable")}}if(index==2){var tab=$("#pdailog #charttabs").tabs("getSelected");var o=curTmpInfo.chart;var ctp=curTmpInfo.chart.chartJson.type;var isgauge=curTmpInfo.chart.chartJson.type=="gauge"||curTmpInfo.chart.chartJson.type=="radar";var html='<div class="chart_set"><div class="selleft"><ul><li class="select" cid="1">图形</li>'+(!isgauge?'<li cid="2">横轴</li>':"")+'<li cid="3">纵轴</li>'+((curTmpInfo.chart.chartJson.type=="column"||curTmpInfo.chart.chartJson.type=="line")&&curTmpInfo.chart.chartJson.typeIndex=="2"?'<li cid="4">第二纵轴</li>':"")+'<div style="height:280px; background-color:#EEE"></div></ul></div><div id="chartsetdiv" class="selright">图形预览区域</div><div class="selright"><div id="set1" class="one" style="display: block;"><span class="inputtext">图形标题：</span><input type="text" style="width:300px;" class="inputform" name="title" id="title" value="'+(o.chartJson.title?o.chartJson.title:"")+'" onblur="setChartProp2(this)"><br><span class="inputtext">是否显示图例：</span><input type="checkbox"  name="showLegend" id="showLegend" onclick="setChartProp2(this)" '+(o.chartJson.showLegend&&o.chartJson.showLegend==true?"checked":"")+'><span class="inputtext"></span><span class="inputtext">图例位置：</span><select id="legendpos" name="legendpos" onchange="setChartProp2(this)"><option value=\'righttop\' '+(o.chartJson.legendpos=="righttop"?"selected":"")+">右上</option><option value='centerbottom' "+(o.chartJson.legendpos=="centerbottom"?"selected":"")+'>中下</option></select><span class="inputtext"></span><span class="inputtext">排列方式：</span><select id="legendLayout" name="legendLayout" onchange="setChartProp2(this)"><option value=\'vertical\' '+(o.chartJson.legendLayout=="vertical"?"selected":"")+">垂直</option><option value='horizontal' "+(o.chartJson.legendLayout=="horizontal"?"selected":"")+">水平</option></select>";if(ctp=="pie"){html=html+'<br/><span class="inputtext">是否显示标签：</span><input type="checkbox"  name="dataLabel" id="dataLabel" onclick="setChartProp2(this)" '+(o.chartJson.dataLabel?"checked":"")+'><span class="inputtext"></span><span class="inputtext">标签长度：</span><input type="text" id="distance" name="distance" size="5" value="'+(o.chartJson.distance?o.chartJson.distance:"")+'" onblur="setChartProp2(this)"><span class="inputtext"></span><span class="inputtext">显示方式：</span><select id="labelType" name="labelType" onchange="setChartProp2(this)"><option value="np" '+(o.chartJson.labelType=="np"?"selected":"")+'>名称+占比</option><option value="n" '+(o.chartJson.labelType=="n"?"selected":"")+'>名称</option><option value="nv" '+(o.chartJson.labelType=="nv"?"selected":"")+">名称+值</option></select>"}html=html+'</div><div id="set2" class="one">';if(ctp=="pie"||ctp=="gauge"||ctp=="scatter"||ctp=="bubble"||ctp=="radar"||ctp=="map"){}else{html=html+'<span class="inputtext">横轴标题：</span><input type="text" class="inputform" name="xtitle" id="xtitle" onblur="setChartProp2(this)" value="'+(o.chartJson.xcol?o.chartJson.xcol.dimdesc:"")+'"><br>'}if(ctp=="pie"||ctp=="gauge"||ctp=="scatter"||ctp=="bubble"||ctp=="radar"||ctp=="map"){}else{html=html+'<span class="inputtext">显示间隔：</span><input type="text" data-options="min:1,max:10" class="inputform sty1" name="tickInterval" id="tickInterval" onblur="setChartProp2(this)" value="'+(o.chartJson.xcol&&o.chartJson.xcol.tickInterval?o.chartJson.xcol.tickInterval:"")+'"><br>'}if(ctp=="pie"||ctp=="gauge"||ctp=="scatter"||ctp=="bubble"||ctp=="radar"||ctp=="map"){}else{html=html+'<span class="inputtext">旋转角度：</span><input type="text" data-options="min:1,max:180" class="inputform sty1" name="routeXaxisLable" id="routeXaxisLable" onblur="setChartProp2(this)" value="'+(o.chartJson.xcol&&o.chartJson.xcol.routeXaxisLable?o.chartJson.xcol.routeXaxisLable:"")+'"><br>'}if(ctp=="scatter"||ctp=="bubble"){html=html+'<span class="inputtext">横轴标题：</span><input type="text" class="inputform" name="kpi_name2" id="kpi_name2" value="'+(o.kpiJson&&o.kpiJson.length>1?o.kpiJson[1].kpi_name:"")+'" onblur="setChartProp2(this)"> <span class="inputtext"></span><span class="inputtext">显示单位：</span><input type="text" class="inputform sty1" onblur="setChartProp2(this)" name="yunit2" id="yunit2" value="'+(o.kpiJson&&o.kpiJson.length>1&&o.kpiJson[1].unit?o.kpiJson[1].unit:"")+'">(元、次、分钟等)<br><span class="inputtext">格式化：</span>'+curTmpInfo.property.ftmstr("yfmt2","inputform",o.kpiJson&&o.kpiJson.length>1&&o.kpiJson[1].fmt?o.kpiJson[1].fmt:"",true)+'<br><span class="inputtext">比 例：</span><select onchange="setChartProp2(this)"  class="inputform" id="rate2"><option value=""></option><option value="1">1</option><option value="10000">10000(万)</option><option value="1000000">1000000(百万)</option><option value="100000000">100000000(亿)</option></select>'}if(ctp=="gauge"||ctp=="scatter"||ctp=="bubble"||ctp=="radar"||ctp=="map"){}else{html=html+'<span class="inputtext">取 Top：</span><input type="text" data-options="min:1,max:100" class="inputform sty1" name="top" id="top" onblur="setChartProp2(this)" value="'+(o.chartJson.xcol&&o.chartJson.xcol.top?o.chartJson.xcol.top:"")+'">(默认值30)'}html=html+'</div><div id="set3" class="one">';if(ctp=="gauge"||ctp=="pie"){}else{html=html+'<span class="inputtext">纵轴标题：</span><input type="text" class="inputform" name="ytitle" id="ytitle" value="'+(o.kpiJson&&o.kpiJson.length>0?o.kpiJson[0].kpi_name:"")+'" onblur="setChartProp2(this)"> <span class="inputtext"></span>'}html=html+' <span class="inputtext">显示单位：</span><input type="text" class="inputform sty1" onblur="setChartProp2(this)" name="yunit" id="yunit" value="'+(o.kpiJson&&o.kpiJson.length>0&&o.kpiJson[0].unit?o.kpiJson[0].unit:"")+'">(元、次、分钟等)<br><span class="inputtext">格式化：</span>'+curTmpInfo.property.ftmstr("yfmt","inputform",o.kpiJson&&o.kpiJson.length>0&&o.kpiJson[0].fmt?o.kpiJson[0].fmt:"",true);if(ctp=="pie"||ctp=="scatter"||ctp=="bubble"||ctp=="radar"||ctp=="map"){}else{html=html+'<span class="inputtext" style="width:100px;"></span> <span class="inputtext">最小值：</span><input type="text" class="inputform sty1" name="ymin" id="ymin" onblur="setChartProp2(this)" value="'+(o.kpiJson&&o.kpiJson.length>0&&o.kpiJson[0].min?o.kpiJson[0].min:"")+'">'}if(ctp=="gauge"){html=html+'<span class="inputtext" style="width:100px;"></span> <span class="inputtext">最大值：</span><input type="text" class="inputform sty1" name="ymax" id="ymax" onblur="setChartProp2(this)" value="'+(o.kpiJson&&o.kpiJson.length>0&&o.kpiJson[0].ymax?o.kpiJson[0].ymax:"")+'">'}html=html+'<br><span class="inputtext">比 例：</span><select onchange="setChartProp2(this)"  class="inputform" id="rate"><option value=""></option><option value="1">1</option><option value="10000">10000(万)</option><option value="1000000">1000000(百万)</option><option value="100000000">100000000(亿)</option></select></div>';if((curTmpInfo.chart.chartJson.type=="column"||curTmpInfo.chart.chartJson.type=="line")&&curTmpInfo.chart.chartJson.typeIndex=="2"){html=html+'<div id="set4" class="one"><span class="inputtext">第二纵轴标题：</span><input type="text" onblur="setChartProp2(this)" value="'+(o.kpiJson&&o.kpiJson.length>1&&o.kpiJson[1]!=null?o.kpiJson[1].kpi_name:"")+'" id="kpi_name2" name="kpi_name2" class="inputform"><span class="inputtext"></span> <span class="inputtext">显示单位：</span><input type="text" class="inputform sty1" onblur="setChartProp2(this)" name="yunit2" id="yunit2" value="'+(o.kpiJson&&o.kpiJson.length>1&&o.kpiJson[1]!=null&&o.kpiJson[1].unit?o.kpiJson[1].unit:"")+'">(元、次、分钟等)<br><span class="inputtext">格式化：</span>'+curTmpInfo.property.ftmstr("yfmt2","inputform",o.kpiJson&&o.kpiJson.length>1&&o.kpiJson[1]!=null&&o.kpiJson[1].fmt?o.kpiJson[1].fmt:"",true)+'<br/><span class="inputtext">比 例：</span><select onchange="setChartProp2(this)"  class="inputform" id="rate2"><option value=""></option><option value="1">1</option><option value="10000">10000(万)</option><option value="1000000">1000000(百万)</option><option value="100000000">100000000(亿)</option></select></div>'}html=html+"</div></div>";$(tab).html(html);if(o.kpiJson&&o.kpiJson.length>0&&o.kpiJson[0]!=null&&o.kpiJson[0].rate){$("#charttabs #rate").val(o.kpiJson[0].rate)}if(o.kpiJson&&o.kpiJson.length>1&&o.kpiJson[1]!=null&&o.kpiJson[1].rate){$("#charttabs #rate2").val(o.kpiJson[1].rate)}$("#charttabs #ymin,#charttabs #tickInterval, #charttabs #routeXaxisLable, #charttabs #top").numberbox();$(".chart_set .selleft ul li").bind("click",function(){var cid=$(this).attr("cid");$(".chart_set .selleft ul li").removeClass("select");$(this).addClass("select");$(".chart_set .selright .one").css("display","none");$("#set"+cid).css("display","block")});if(curTmpInfo.chart.kpiJson&&curTmpInfo.chart.chartJson.type!="scatter"&&curTmpInfo.chart.chartJson.type!="bubble"&&curTmpInfo.chart.kpiJson.length>0){chartview("chartsetdiv")}if(curTmpInfo.chart.chartJson.type=="scatter"&&curTmpInfo.chart.kpiJson&&curTmpInfo.chart.kpiJson[0]!=null&&curTmpInfo.chart.kpiJson[1]!=null){chartview("chartsetdiv")}if(curTmpInfo.chart.chartJson.type=="bubble"&&curTmpInfo.chart.kpiJson&&curTmpInfo.chart.kpiJson[0]!=null&&curTmpInfo.chart.kpiJson[1]!=null&&curTmpInfo.chart.kpiJson[2]!=null){chartview("chartsetdiv")}}if(index==1){var tab=$("#pdailog #charttabs").tabs("getSelected");var dsid=curTmpInfo.chart.datasetid;if(curTmpInfo.chart.income=="cube"){dsid=curTmpInfo.chart.cubeid}var html=crtChartDataHtml(dsid);$(tab).html(html);changeChartData();if(curTmpInfo.chart.kpiJson&&curTmpInfo.chart.chartJson.type!="scatter"&&curTmpInfo.chart.chartJson.type!="bubble"&&curTmpInfo.chart.kpiJson.length>0){chartview()}if(curTmpInfo.chart.chartJson.type=="scatter"&&curTmpInfo.chart.kpiJson&&curTmpInfo.chart.kpiJson[0]!=null&&curTmpInfo.chart.kpiJson[1]!=null){chartview()}if(curTmpInfo.chart.chartJson.type=="bubble"&&curTmpInfo.chart.kpiJson&&curTmpInfo.chart.kpiJson[0]!=null&&curTmpInfo.chart.kpiJson[1]!=null&&curTmpInfo.chart.kpiJson[2]!=null){chartview()}$("#charttabs #xcol, #charttabs #ycol, #charttabs #y2col, #charttabs #y3col, #charttabs #scol").droppable({accept:"#charttabs #datacol div",onDragEnter:function(e,source){$(this).css("border-color","#ff0000");$(source).draggable("proxy").find("span").removeClass("tree-dnd-no");$(source).draggable("proxy").find("span").addClass("tree-dnd-yes")},onDragLeave:function(e,source){$(this).css("border-color","#7F9DB9");$(source).draggable("proxy").find("span").addClass("tree-dnd-no");$(source).draggable("proxy").find("span").removeClass("tree-dnd-yes")},onDrop:function(e,source){$(this).css("border-color","#7F9DB9");var node=$("#charttabs #datacol").tree("getNode",source);curTmpInfo.chart.income=node.attributes.income;if($(this).attr("id")=="ycol"||$(this).attr("id")=="y2col"||$(this).attr("id")=="y3col"){if(node.attributes.vtype!="Double"&&node.attributes.vtype!="Int"){msginfo("放入本区域的字段必须是数字类型。");return}if(node.attributes.income=="cube"&&node.attributes.from!="kpi"){msginfo("放入本区域的字段必须是指标。");return}if(!curTmpInfo.chart.kpiJson){curTmpInfo.chart.kpiJson=[null,null,null]}curTmpInfo.chart.chartJson.ycol={type:"kpi"};var json={kpi_id:node.id,colname:(node.attributes.calc==1?node.attributes.expression:node.attributes.colname),kpi_name:node.text,rate:1,aggre:(node.attributes.aggre?node.attributes.aggre:"sum"),alias:node.id,fmt:node.attributes.fmt,unit:node.attributes.unit,calc:node.attributes.calc};var ixd="";if($(this).attr("id")=="y2col"){curTmpInfo.chart.kpiJson[1]=json;ixd="2"}else{if($(this).attr("id")=="y3col"){curTmpInfo.chart.kpiJson[2]=json;ixd="3"}else{curTmpInfo.chart.kpiJson[0]=json}}$(this).html('<span title="聚合方式" onclick="chartAggreType(this)" style="margin-top:2px;" class="grouptype"></span><span class="charttxt" style="width:72px;">'+json.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, \''+json.kpi_id+"','y"+ixd+"col','"+json.kpi_name+"')\"></span>")}else{if($(this).attr("id")=="xcol"){if(node.attributes.income=="cube"&&node.attributes.from!="dim"){msginfo("放入本区域的字段必须是维度。");return}curTmpInfo.chart.chartJson.xcol={id:node.id,dimdesc:node.text,type:(node.attributes.type?node.attributes.type:"frd"),colname:(node.attributes.dimkey&&node.attributes.dimkey!=""?node.attributes.dimkey:node.id),colnamedesc:(node.attributes.dimtxt&&node.attributes.dimtxt!=""?node.attributes.dimtxt:node.id),dim_name:node.text,tname:node.attributes.tname,dimord:node.attributes.dimord,ordcol:node.attributes.ordcol};$(this).html('<span class="charttxt">'+curTmpInfo.chart.chartJson.xcol.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, \''+curTmpInfo.chart.chartJson.xcol.id+"','xcol', '"+curTmpInfo.chart.chartJson.xcol.dimdesc+"')\"></span>")}else{if($(this).attr("id")=="scol"){if(node.attributes.income=="cube"&&node.attributes.from!="dim"){msginfo("放入本区域的字段必须是维度。");return}curTmpInfo.chart.chartJson.scol={id:node.id,dimdesc:node.text,type:(node.attributes.type?node.attributes.type:"frd"),colname:(node.attributes.dimkey&&node.attributes.dimkey!=""?node.attributes.dimkey:node.id),colnamedesc:(node.attributes.dimtxt&&node.attributes.dimtxt!=""?node.attributes.dimtxt:node.id),dim_name:node.text,tname:node.attributes.tname,dimord:node.attributes.dimord,ordcol:node.attributes.ordcol};$(this).html('<span class="charttxt">'+curTmpInfo.chart.chartJson.scol.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, \''+curTmpInfo.chart.chartJson.scol.id+"','scol', '"+curTmpInfo.chart.chartJson.scol.dimdesc+"')\"></span>")}}}if(curTmpInfo.chart.kpiJson&&curTmpInfo.chart.chartJson.type!="scatter"&&curTmpInfo.chart.chartJson.type!="bubble"&&curTmpInfo.chart.kpiJson.length>0){$("#pdailog #comlit").linkbutton("enable");chartview()}if(curTmpInfo.chart.chartJson.type=="scatter"&&curTmpInfo.chart.kpiJson&&curTmpInfo.chart.kpiJson[0]!=null&&curTmpInfo.chart.kpiJson[1]!=null){$("#pdailog #comlit").linkbutton("enable");chartview()}if(curTmpInfo.chart.chartJson.type=="bubble"&&curTmpInfo.chart.kpiJson&&curTmpInfo.chart.kpiJson[0]!=null&&curTmpInfo.chart.kpiJson[1]!=null&&curTmpInfo.chart.kpiJson[2]!=null){$("#pdailog #comlit").linkbutton("enable");chartview()}}})}}})}function chartsort(c){var b=curTmpInfo.tp;var a=curTmpInfo.chart;if(b=="xcol"){delete a.kpiJson[0].sort;a.chartJson.xcol.dimord=c}if(b=="ycol"){a.kpiJson[0].sort=c;delete a.chartJson.xcol.dimord}if(b=="scol"){delete a.kpiJson[0].sort;a.chartJson.scol.dimord=c}chartview()}function chartview(o,e,q,d){if(curTmpInfo.chart.kpiJson==undefined||curTmpInfo.chart.kpiJson.length==0){return}var s=curTmpInfo.chart;var r=JSON.stringify(s.chartJson);var f=JSON.stringify(s.kpiJson);var b=JSON.stringify(pageInfo.param);var g=s.income;var a={};var h={};var c={};if(g=="cube"){a=fundCubeById(s.cubeid);if(a.from=="olap"){h={}}else{h=findDatasetById(a.datasetid)}c=findDatasourceById(h.dsid)}else{h=findDatasetById(curTmpInfo.chart.datasetid);c=findDatasourceById(h.dsid)}$.ajax({type:"POST",url:q?q:"Chart!view.action",dataType:"html",data:{chartJson:r,kpiJson:f,datasource:JSON.stringify(c),dataset:JSON.stringify(h),cube:JSON.stringify(a),params:b},success:function(p){if(e){e(p,d)}else{if(o){$("#charttabs #"+o).html(p)}else{$("#charttabs div.chartctx").html(p)}}},error:function(p){}})}function delChartKpiOrDim(a){if(a){curTmpInfo.chart.chartJson?curTmpInfo.chart.chartJson.xcol={}:"";$("#charttabs #xcol").html('<span class="charttip">拖拽字段到这里</span>');curTmpInfo.chart.chartJson?curTmpInfo.chart.chartJson.ycol={}:"";delete curTmpInfo.chart.kpiJson;$("#charttabs #ycol").html('<span class="charttip">拖拽字段到这里</span>');$("#charttabs #y2col").html('<span class="charttip">拖拽字段到这里</span>');$("#charttabs #y3col").html('<span class="charttip">拖拽字段到这里</span>');$("#charttabs div.chartctx").html("图形预览区域");curTmpInfo.chart.chartJson?curTmpInfo.chart.chartJson.scol={}:"";$("#charttabs #scol").html('<span class="charttip">拖拽字段到这里</span>');$("#pdailog #comlit").linkbutton("disable");return}var c=curTmpInfo.tp;var b="";if(c=="xcol"){b=curTmpInfo.chart.chartJson.xcol.colname;curTmpInfo.chart.chartJson.xcol={};$("#charttabs #xcol").html('<span class="charttip">拖拽字段到这里</span>');chartview()}if(c=="ycol"){b=curTmpInfo.chart.kpiJson[0].col_name;curTmpInfo.chart.chartJson.ycol={};curTmpInfo.chart.kpiJson[0]=null;$("#charttabs #ycol").html('<span class="charttip">拖拽字段到这里</span>');$("#charttabs div.chartctx").html("图形预览区域");$("#pdailog #comlit").linkbutton("disable")}if(c=="y2col"){b=curTmpInfo.chart.kpiJson[0].col_name;curTmpInfo.chart.chartJson.ycol={};curTmpInfo.chart.kpiJson[1]=null;$("#charttabs #y2col").html('<span class="charttip">拖拽字段到这里</span>');$("#charttabs div.chartctx").html("图形预览区域");$("#pdailog #comlit").linkbutton("disable")}if(c=="y3col"){b=curTmpInfo.chart.kpiJson[0].col_name;curTmpInfo.chart.chartJson.ycol={};curTmpInfo.chart.kpiJson[2]=null;$("#charttabs #y3col").html('<span class="charttip">拖拽字段到这里</span>');$("#charttabs div.chartctx").html("图形预览区域");$("#pdailog #comlit").linkbutton("disable")}if(c=="scol"){b=curTmpInfo.chart.chartJson.scol.colname;curTmpInfo.chart.chartJson.scol={};$("#charttabs #scol").html('<span class="charttip">拖拽字段到这里</span>');chartview()}$("#charttabs #datacol div[colname='"+b+"']").show()}function chartAggreType(a){curTmpInfo.usetype="chart";$("#aggretypemenu").children().each(function(c,d){$("#aggretypemenu").menu("setIcon",{target:$(this),iconCls:"icon-blank"})});$("#aggretypemenu").menu("setIcon",{target:$("#aggre_"+curTmpInfo.chart.kpiJson[0].aggre),iconCls:"icon-ok"});var b=$(a).offset();$("#aggretypemenu").menu("show",{left:b.left,top:b.top+20})}function kpiAggreType(f){if(curTmpInfo.usetype=="chart"){curTmpInfo.chart.kpiJson[0].aggre=f;chartview()}else{if(curTmpInfo.usetype=="cross"){var c=curTmpInfo.compId;var e=curTmpInfo.kpiId;var a=findCompById(c);for(var b=0;b<a.kpiJson.length;b++){if(a.kpiJson[b].kpi_id==e){a.kpiJson[b].aggre=f;break}}}else{if(curTmpInfo.usetype=="table"){$(curTmpInfo.tdobj).parent().attr("aggre",f);curTmpInfo.tdobj=null}else{if(curTmpInfo.usetype=="staticCross"){var c=curTmpInfo.compId;var a=findCompById(c);var d=curTmpInfo.scrossTable.findCrossField(curTmpInfo.kpiId,a,curTmpInfo.pos);d.aggre=f}}}}curTmpInfo.isupdate=true}function chartmenu(b,e,d,a){curTmpInfo.tp=d;var c=$(b).offset();$("#chartoptmenu").menu("show",{left:c.left,top:c.top+20})}function chartcss(){$(".chartselect .selleft ul li").bind("click",function(){var d=$(this).attr("cid");$(".chartselect .selleft ul li").removeClass("select");$(this).addClass("select");$(".chartselect .selright .one").css("display","none");$("#pdailog #schart"+d).css("display","block");$(".chartselect .selright .one span.charttype").removeClass("select");$("#pdailog #schart"+d+" span[index='1']").addClass("select");var c=$("#pdailog #schart"+d).attr("tp");curTmpInfo.chart.chartJson.type=c;curTmpInfo.chart.chartJson.typeIndex="1"});var b=1;if(curTmpInfo.chart.chartJson.type=="line"){b=1}else{if(curTmpInfo.chart.chartJson.type=="column"){b=2}else{if(curTmpInfo.chart.chartJson.type=="pie"){b=3}else{if(curTmpInfo.chart.chartJson.type=="radar"){b=5}else{if(curTmpInfo.chart.chartJson.type=="gauge"){b=4}else{if(curTmpInfo.chart.chartJson.type=="scatter"){b=6}else{if(curTmpInfo.chart.chartJson.type=="bubble"){b=7}else{if(curTmpInfo.chart.chartJson.type=="bar"){b=8}else{if(curTmpInfo.chart.chartJson.type=="area"){b=9}}}}}}}}}$(".chartselect .selleft ul li[cid='"+b+"']").addClass("select");$(".chartselect .selright .one").css("display","none");$("#pdailog #schart"+b).css("display","block");var a=curTmpInfo.chart.chartJson.typeIndex;if(!a){a="1"}$("#pdailog #schart"+b+" span[index='"+a+"']").addClass("select");$(".chartselect .selright .one span.charttype").bind("click",function(){$(".chartselect .selright .one span.charttype").removeClass("select");$(this).addClass("select");var c=curTmpInfo.chart.chartJson;curTmpInfo.chart.chartJson.typeIndex=$(this).attr("index")})}function insertLabel(b){var a="";var c={id:newGuid(),type:"label",name:"标签组件",desc:a};var d=addComp(c,b,true);$("#layout_"+b).append(d);regCompEvent(c);initCompDropEvent(c.id);editLabel(c,b)}function editLabel(b,a){var c='<input type="text" id="editlb" name="editlb" value="'+b.desc+'" style="width:98%; border:none;">';$("#"+b.id+" div.ctx").html(c);$("#"+b.id+" #editlb").bind("blur",function(){$("#"+b.id+" div.ctx").html($(this).val());b.desc=$(this).val()}).focus()}function selcolumn(a){insertText2focus(document.getElementById("txtctx"),"[$"+a+"] ")}function insertText(g,a){var f="";var b=findCompById(curTmpInfo.compId);if(g=="update"&&b.datasetId){var e=findDatasetById(b.datasetId);for(var d=0;d<e.cols.length;d++){f=f+"<span onclick=\"selcolumn('"+e.cols[d].name+'\')" class="column">'+(e.cols[d].dispName==""?e.cols[d].name:e.cols[d].dispName)+"</span> "}}f=f+"";$("#pdailog").dialog({title:"请输入文本内容 - 文本组件",width:600,height:(g=="update"?390:360),closed:false,cache:false,modal:true,toolbar:null,content:'<div style="margin:8px; line-height:20px;"><div align="right">通过&lt;font color=&quot;#ffff00&quot; size=&quot;x&quot;&gt;标签定义文本颜色、大小信息。</div><textarea name="txtctx" id="txtctx" style="width: 550px; height: 240px;"></textarea>'+(g=="update"?'<div class="actColumn">动态字段：'+f+"</div>":"")+"</div>",buttons:[{text:"确定",handler:function(){if(g=="insert"){var h=$("#txtctx").val();var q={id:newGuid(),type:"text",name:"文本组件",desc:h};var r=addComp(q,a,true);$("#layout_"+a).append(r.replace(/\n/g,"<br>"));regCompEvent(q);initCompDropEvent(q.id)}if(g=="update"){var h=$("#txtctx").val();var p=curTmpInfo.compId;var o=findCompById(p);o.desc=h;$("#"+p+" div.ctx").html(h.replace(/\n/g,"<br>"))}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});if(g=="update"){var c=curTmpInfo.compId;var b=findCompById(c);$("#txtctx").val(b.desc)}$("#txtctx").focus()}function compevent(){var p=curTmpInfo.compId;var y=findCompById(p);if(y.type=="chart"||y.type=="cross"||y.type=="table"){}else{return}var f;var z;if(y.type=="chart"){f=y.chartJson.link;z=y.chartJson.linkAccept}else{f=y.link;z=y.linkAccept}var w=function(B,o){var A=false;for(j=0;j<B.length;j++){if(o==B[j]){A=true;break}}return A};var s="";var d=f&&f.target?f.target.split(","):[];for(i=0;i<curTmpInfo.comps.length;i++){var r=curTmpInfo.comps[i];if(r.type=="chart"||r.type=="cross"||r.type=="table"){if(r.id!=p){s=s+'<input type="checkbox" id="linkcomp" name="linkcomp" value="'+r.id+'" '+(w(d,r.id)?"checked":"")+">"+r.name+"<br/>"}}}s=s+"";var h=function(A){var o="";for(j=0;j<A.cols.length;j++){o=o+'<option value="'+A.cols[j].name+'" '+(z&&z.col==A.cols[j].name?"selected":"")+">"+A.cols[j].name+"("+A.cols[j].name+")</option>"}return o};var v=function(o){var A="";for(j=0;j<o.dim.length;j++){if(o.dim[j].tp=="group"){var B=o.dim[j].children;for(k=0;k<B.length;k++){A=A+'<option value="'+B[k].id+'" '+(z&&z.col==B[k].id?"selected":"")+">"+B[k].name+"("+B[k].id+")</option>"}}else{A=A+'<option value="'+o.dim[j].id+'" '+(z&&z.col==o.dim[j].id?"selected":"")+">"+o.dim[j].name+"("+o.dim[j].id+")</option>"}}return A};var a='<select id="acceptCol" name="acceptCol" class="inputform"><option value=""></option>';if(y.type=="chart"){if(y.income=="dset"){var e=findDatasetById(y.datasetid);a=a+h(e)}else{if(y.income=="cube"){var t=fundCubeById(y.cubeid);a=a+v(t)}}}else{if(y.type=="cross"){var t=fundCubeById(y.cubeId);if(t==null){msginfo("组件还未映射数据、不能定义事件。");return}a=a+v(t)}else{if(y.type=="table"){var e=findDatasetById(y.datasetid);if(e==null){msginfo("组件还未映射数据、不能定义事件。");return}a=a+h(e)}}}a=a+"</select>";var q="";if(y.type=="table"){q='<span class="inputtext">点 击 列：</span><select id="sendCol" name="sendCol" class="inputform"><option value=""></option>';var g=document.getElementById("T"+p).rows;for(i=0;i<g.length;i++){var c=g[i].cells;if(!$(c[0]).hasClass("gridtab-td")){continue}for(j=0;j<c.length;j++){var b=$(c[j]);var x=b.children("div");q=q+'<option value="'+x.attr("cid")+'" '+(f&&f.alias==x.attr("cid")?"selected":"")+">"+x.text()+"</option>"}}q=q+"</select><br/>"}var u='<div id="compevent_tab" style="height:auto; width:auto;"><div title="事件发起"><div style="line-height:inherit" class="textpanel">'+q+'<table width="100%" cellspacing="0" cellpadding="0" border="0"><tr><td width="10%" valign="top"><span class="inputtext">联动组件：</span></td><td>'+s+'</td></tr></table><br/><a href="javascript:;" id="cleanPostEvent">清除事件发起</a></div></div><div title="事件接收"><div class="textpanel"><span class="inputtext">接收字段：</span>'+a+'<br/><span class="inputtext">默认值：</span><input type="text" name="dftval" id="dftval" class="inputform" value="'+(z&&z.dftval?z.dftval:"")+'"><br/><span class="inputtext">默认值类型：</span><select name="valtype" id="valtype" class="inputform"><option value=""></option><option value="number" '+(z&&z.valType=="number"?"selected":"")+'>数字类型</option><option value="string" '+(z&&z.valType=="string"?"selected":"")+'>字符类型</option></select><br/><a href="javascript:;" id="cleanAcceptEvent">清除事件接收</a></div></div></div>';$("#pdailog").dialog({title:"组件事件设置",width:300,height:(y.type=="table"?290:250),closed:false,cache:false,modal:true,toolbar:null,content:u,buttons:[{text:"确定",handler:function(){var E=$("#pdailog #compevent_tab").tabs("getSelected");var o=$("#pdailog #compevent_tab").tabs("getTabIndex",E);if(o==0){var B="";var D="";$("#compevent_tab input[name='linkcomp']:checked").each(function(H,I){var J=$(this).val();var K=findCompById(J);var L=K.type=="table"?"gridReport":K.type;B=B+J+",";D=D+L+","});var A=$("#compevent_tab #sendCol").val();if(B==""){$("#pdailog").dialog("close");return}B=B.substring(0,B.length-1);D=D.substring(0,D.length-1);if(y.type=="chart"){y.chartJson.link={target:B,type:D,alias:A}}else{y.link={target:B,type:D,alias:A}}}else{var C=$("#compevent_tab #acceptCol").val();var G=$("#compevent_tab #dftval").val();var F=$("#compevent_tab #valtype").val();if(C==""&&G==""){$("#pdailog").dialog("close");return}if(C==""){msginfo("接收字段是必选项！");return}if(G==""){msginfo("默认值是必填项！");$("#compevent_tab #dftval").select();return}if(F==""){msginfo("默认值类型是必选项！");return}if(y.type=="chart"){y.chartJson.linkAccept={col:C,dftval:G,valType:F}}else{y.linkAccept={col:C,dftval:G,valType:F}}}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #compevent_tab").tabs({border:false,fit:true});$("#compevent_tab #cleanPostEvent").bind("click",function(){$("#compevent_tab input[name='linkcomp']:checked").each(function(o,A){$(this).attr("checked",false)});$("#compevent_tab #sendCol").val("");if(y.type=="chart"){delete y.chartJson.link}else{delete y.link}});$("#compevent_tab #cleanAcceptEvent").bind("click",function(){$("#compevent_tab #acceptCol").val("");$("#compevent_tab #dftval").val("");$("#compevent_tab #valtype").val("");if(y.type=="chart"){delete y.chartJson.linkAccept}else{delete y.linkAccept}})}function movecomp(){var a=curTmpInfo.layoutId;var b=curTmpInfo.compId;$("#"+b).draggable("enable")}function checkCompErrInfo(){var h=[];for(j=0;pageInfo.vars&&j<pageInfo.vars.length;j++){var q=pageInfo.vars[j];if(q.valtype=="dtz"&&findDatasetById(q.datasetid)==null){h.push({name:"变量",msg:"变量关联的数据集已经不存在了，请修改。"})}}for(j=0;pageInfo.dataset&&j<pageInfo.dataset.length;j++){var c=pageInfo.dataset[j];if(c.error){h.push({name:c.name,msg:"数据集SQL存在问题，请修改。"})}}var e=function(t){var p=fundCubeById(t);if(p==null){h.push({name:f.name,msg:"组件关联的立方体已经不存在，请重新关联。"});return}if(p.from=="olap"){return}var s=findDatasetById(p.datasetid);if(s==null){h.push({name:f.name,msg:"组件关联的数据集已经不存在，请重新关联。"})}else{var r=findDatasourceById(s.dsid);if(s.dsid!=""&&r==null){h.push({name:f.name,msg:"组件关联的数据源已经不存在，请重新关联。"})}}};var b=function(p){var s=findDatasetById(p);if(s==null){h.push({name:f.name,msg:"组件关联的数据集已经不存在，请重新关联。"})}else{var r=findDatasourceById(s.dsid);if(s.dsid!=""&&r==null){h.push({name:f.name,msg:"组件关联的数据源已经不存在，请重新关联。"})}}};for(var d=0;curTmpInfo.comps&&d<curTmpInfo.comps.length;d++){var f=curTmpInfo.comps[d];if(f.type=="table"){if(!f.income){h.push({name:f.name,msg:"组件还未绑定数据集，请从数据集或立方体中拖拽数据列到表格单元格中。"})}if(f.income=="dataset"&&f.datasetid){b(f.datasetid)}else{if(f.income=="cube"&&f.cubeid){e(f.cubeid)}}}else{if(f.type=="chart"){if(!f.chartJson||!f.chartJson.xcol){h.push({name:f.name,msg:"图形横轴还未设置数据字段。"})}if(!f.kpiJson||f.kpiJson.length==0){h.push({name:f.name,msg:"图形纵轴还未设置数据字段。"})}if(f.datasetid){b(f.datasetid)}}else{if(f.type=="cross"){if(!f.cubeId){h.push({name:f.name,msg:"组件还未绑定数据，请从立方体中拖拽度量或维到交叉表中。"})}if(!f.kpiJson||f.kpiJson.length==0){h.push({name:f.name,msg:"组件中还未配置度量，请从立方体中拖拽度量到交叉表中。"})}if(f.cubeId){e(f.cubeId)}}else{if(f.type=="staticCross"){if(!f.cubeId){h.push({name:f.name,msg:"组件还未绑定数据，请从立方体中拖拽度量或维到固定表中。"})}if(f.tableJson.cols.length==0){h.push({name:f.name,msg:"组件还未配置列表头。"})}if(f.tableJson.rows.length==0){h.push({name:f.name,msg:"组件还未配置行表头。"})}if(f.cubeId){e(f.cubeId)}}}}}}for(d=0;pageInfo.param&&d<pageInfo.param.length;d++){var a=pageInfo.param[d];if(a.option&&a.option.datasetid){var o=a.option.datasetid;var g=findDatasetById(o);if(g==null){h.push({name:"参数错误",msg:"参数"+a.desc+"关联的数据集已经不存在了。"})}}}return h}function insertText2focus(e,f){e.focus();if(document.selection){var d=document.selection.createRange();d.text=f}else{if(typeof e.selectionStart=="number"&&typeof e.selectionEnd=="number"){var c=e.selectionStart,b=e.selectionEnd,g=c,a=e.value;e.value=a.substring(0,c)+" "+f+a.substring(b,a.length);g+=f.length;e.selectionStart=e.selectionEnd=g}else{e.value+=f}}}function copycomp(){var b=curTmpInfo.compId;var a=findCompById(b);curTmpInfo.copycomp=a}function pastecomp(income){if(!curTmpInfo.copycomp){return}var json=eval("("+JSON.stringify(curTmpInfo.copycomp)+")");var oldCompId=json.id;json.id=newGuid();delete curTmpInfo.copycomp;var layoutId=curTmpInfo.layoutId;var compId=curTmpInfo.compId;var str=addComp(json,layoutId,true);if(income=="comp"){$(str).insertAfter("#"+oldCompId)}else{$("#layout_"+layoutId).append(str)}if(json.type=="label"){regCompEvent(json)}else{if(json.type=="text"){regCompEvent(json)}else{if(json.type=="pic"){regCompEvent(json)}else{if(json.type=="chart"){regCompEvent(json);$("#"+json.id+" div.ctx img").attr("src",$("#"+oldCompId+" div.ctx img").attr("src"))}else{if(json.type=="table"){regTableEvent(json.id);regTableDrop(json.id)}else{if(json.type=="cross"){regCompEvent(json);regCrossDropEvent(json)}else{if(json.type=="staticCross"){regCompEvent(json);curTmpInfo.scrossTable.regDropEvent(json);curTmpInfo.scrossTable.cellSelect(json.id)}}}}}}}initCompDropEvent(json.id)}function formatNumber(h,q){if(q.indexOf("%")>0){h=h*100}var b=q?q.split("."):[""];var p="";var u=0;if(b.length>1){u=b[1].length}var d=1;for(g=0;g<u;g++){d=d*10}h=h*d;h=Math.round(h);h=h/d;var t=h?h.toString().split("."):["0"];var s=t[0];var c=b[0];var g=s.length-1;var v=false;for(var o=c.length-1;o>=0;o--){switch(c.substr(o,1)){case"#":if(g>=0){p=s.substr(g--,1)+p}break;case"0":if(g>=0){p=s.substr(g--,1)+p}else{p="0"+p}break;case",":v=true;p=","+p;break}}if(g>=0){if(v){var e=s.length;for(;g>=0;g--){p=s.substr(g,1)+p;if(g>0&&((e-g)%3)==0){p=","+p}}}else{p=s.substr(0,g+1)+p}}p=p+".";s=t.length>1?t[1]:"";c=b.length>1?b[1]:"";g=0;for(var o=0;o<c.length;o++){switch(c.substr(o,1)){case"#":if(g<s.length){p+=s.substr(g++,1)}break;case"0":if(g<s.length){p+=s.substr(g++,1)}else{p+="0"}break}}var a=p.replace(/^,+/,"").replace(/\.$/,"");if(q.indexOf("%")>0){a=a+"%"}return a}function findCompById(e,b){var a=-1;var c=null;for(var d=0;curTmpInfo.comps&&d<curTmpInfo.comps.length;d++){if(curTmpInfo.comps[d].id==e){c=curTmpInfo.comps[d];a=d;break}}if(b&&b==true){return a}else{return c}}if($==undefined){$=jQuery}function newdatactx(){var a=curTmpInfo.id;if(a=="sjy"){newdatasource(false,"new")}else{if(a=="sjj"){newdataset()}else{if(a=="lft"){newcube()}else{if(a=="cs"){newparam("insert")}else{if(a=="var"){newvariables("insert")}}}}}}function existdata(){var a=curTmpInfo.id;if(a=="lft"){newcube2()}else{if(a=="sjy"){newdatasource(false,"exist")}else{alert("暂未支持。")}}}function editmydata(){var a=curTmpInfo.tp;var b=curTmpInfo.id;if(a=="dsource"){newdatasource(true,"new")}else{if(a=="dset"){editdataset()}else{if(a=="param"){newparam("update")}else{if(a=="cube"){newcube(true,b)}else{if(a=="var"){newvariables("update")}}}}}}function newvariables(o){var b;var e=$("#mydatatree").tree("getSelected");if(o=="update"){b=findVarById(e.id)}var f='<select class="inputform" id="dset" name="dset"><option value=""></option>';for(i=0;pageInfo.dataset&&i<pageInfo.dataset.length;i++){var h=pageInfo.dataset[i];f=f+'<option value="'+h.datasetid+'" '+(b&&h.datasetid==b.datasetid?"selected":"")+">"+h.name+"</option>"}f=f+"</select>";var a='<div class="textpanel"><span class="inputtext">变量标识：</span><input type="text" id="varid" name="varid" class="inputform" value="'+(b?b.id:"")+'" '+(o=="update"?"readOnly":"")+'><font color="#ccc">('+(o=="insert"?"请用英文字符":"不能更改")+')</font><br/><span class="inputtext">值类型：</span><input type="radio" id="valtype1" name="valtype" value="jtz" '+(!b||b.valtype=="jtz"?"checked":"")+'><label for="valtype1">静态值</label> <input type="radio" id="valtype2" name="valtype" value="dtz" '+(b&&b.valtype=="dtz"?"checked":"")+'><label for="valtype2">动态值</label><br/><div id="jtzdiv" style="'+(!b||b.valtype=="jtz"?"":"display:none")+'"><span class="inputtext">变量值：</span><input type="text" id="varvalue" name="varvalue" class="inputform" value="'+(b?b.value:"")+'"></div><div id="dtzdiv" style="'+(b&&b.valtype=="dtz"?"":"display:none")+'"><span class="inputtext">数据集：</span>'+f+'<br/><span class="inputtext">字段：</span><select class="inputform" id="cols" name="cols"></select></div></div>';$("#pdailog").dialog({title:o=="insert"?"创建变量":"修改变量",width:400,height:230,closed:false,cache:false,modal:true,content:a,toolbar:null,buttons:[{text:"确定",handler:function(){var r=$("#pdailog #varid").val();var q=$("#pdailog #varvalue").val();var d=$('#pdailog input[name="valtype"]:checked').val();var s=$("#pdailog #dset").val();var p=$("#pdailog #cols").val();if(!p||p==null){p=""}if(r==""){msginfo("请录入变量标识。");$("#pdailog #varid").focus();return}if(ischinese(r)){msginfo("变量标识必须是英文字符。");$("#pdailog #varid").select();return}if(d=="dtz"&&s==""){msginfo("请选择数据集。");return}if(!pageInfo.vars){pageInfo.vars=[]}if(o=="insert"){pageInfo.vars.push({id:r,value:q,valtype:d,datasetid:s,col:p});$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='var']"),data:[{id:r,text:r,state:"open",iconCls:"icon-var",attributes:{showmenu:true,type:"var"}}]})}else{b.id=r;b.value=q;b.valtype=d;b.datasetid=s;b.col=p}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #dset").change(function(){var q=$(this).val();if(q==""){$("#pdailog #cols").html("")}else{var p=findDatasetById(q);var d="";for(j=0;j<p.cols.length;j++){d=d+'<option value="'+p.cols[j].name+'">'+p.cols[j].name+"</option>"}$("#pdailog #cols").html(d)}});$('#pdailog input[name="valtype"]').change(function(){var d=$(this).val();if(d=="jtz"){$("#pdailog #jtzdiv").css("display","block");$("#pdailog #dtzdiv").css("display","none")}else{$("#pdailog #jtzdiv").css("display","none");$("#pdailog #dtzdiv").css("display","block")}});if(b&&b.datasetid){var g=findDatasetById(b.datasetid);var c="";for(j=0;j<g.cols.length;j++){c=c+'<option value="'+g.cols[j].name+'">'+g.cols[j].name+"</option>"}$("#pdailog #cols").html(c)}}function datasetRefParam(a){insertText2focus(document.getElementById("querysql"),"["+a+"] ")}function testReportSql(b){var d=findDatasetById(b);var a=findDatasourceById(d.dsid);var f=pageInfo.param;var c=pageInfo.vars;var e=$("#datasettabs #querysql").val();if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:"SQL测试",width:380,height:270,closed:false,cache:false,modal:true,toolbar:null,content:"<div style='line-height:20px;' id=\"testResult\"></div>",onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"关闭",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div #testResult").load("DataSet!testSql.action",{ds:(a==null?"":JSON.stringify(a)),dataset:JSON.stringify(d),querysql:e,params:f?JSON.stringify(f):"[]",vars:c?JSON.stringify(c):"[]"},function(h,g,o){if(g=="error"){$("#dsColumn_div #testResult").html("系统异常。")}})}function editdataset(){var c=curTmpInfo.id;var b=null;for(var a=0;a<pageInfo.dataset.length;a++){if(pageInfo.dataset[a].datasetid==c){b=pageInfo.dataset[a];break}}$("#pdailog").dialog({title:"编辑数据集",width:800,height:400,closed:false,cache:false,modal:true,toolbar:null,content:'<div id="datasettabs" ><div title="基本信息" ></div><div title="字段信息"><div id="datasetcol"></div></div><div title="数据集筛选"></div><div title="数据预览"></div></div>',onLoad:function(){},buttons:[{text:"确定",handler:function(){b.querysql=$("#querysql").val();b.dsid=$("#dsid").val();b.name=$("#datasetname").val();if(b.name==""){msginfo("请填数据集名称。");$("#datasetname").focus();return}if(b.querysql==""){msginfo("请填写查询字符串。");$("#querysql").focus();return}var u=b;var g=findDatasourceById(u.dsid);var h=pageInfo.param;var t=pageInfo.vars;var s=false;$.ajax({type:"POST",async:false,url:"DataSet!testSql2.action",dataType:"json",data:{ds:g==null?"":JSON.stringify(g),dataset:JSON.stringify(u),querysql:b.querysql,params:h?JSON.stringify(h):"[]",vars:t?JSON.stringify(t):"[]"},success:function(w){b.error=false;var o=function(z){var y=null;for(k=0;k<u.cols.length;k++){if(u.cols[k].name==z){y=u.cols[k];break}}return y};var x=[];for(p=0;p<w.length;p++){var v=o(w[p].name);if(v!=null){x.push(v)}else{x.push(w[p])}}u.cols=x},error:function(o){b.error=true;if(!confirm("SQL存在错误，是否继续？")){s=true}}});if(s){return}var f=$("#mydatatree").tree("getSelected");var r=$("#mydatatree").tree("getChildren",f.target);for(var q=0;q<r.length;q++){$("#mydatatree").tree("remove",r[q].target)}var e=[];for(var p=0;p<u.cols.length;p++){var d=u.cols;e.push({text:(d[p].dispName==""?d[p].name:d[p].dispName),id:d[p].name,iconCls:"icon-dscol",attributes:{drag:"y",datasetid:u.datasetid,type:d[p].type,income:"dataset"}})}$("#mydatatree").tree("append",{parent:f.target,data:e});$("#mydatatree").tree("update",{target:f.target,text:b.name});curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#datasettabs").tabs({border:false,fit:true,tabPosition:"left",plain:false,onLoad:function(){},onSelect:function(q,p){if(p==0){var g=function(){var s='<span class="inputtext ">引用筛选：</span>';for(var t=0;b.param&&t<b.param.length;t++){s=s+'<span class="column" onclick="datasetRefParam(\''+b.param[t].filterid+"')\">"+b.param[t].filterid+"</span>"}$("#datasettabs .actColumn").html(s)};var e=$("#datasettabs").tabs("getSelected");if($(e).html()!=""){g();return}$(e).load("DataSet!crtDataSet.action?showparam=1",{datasetid:b.datasetid},function(){var s=curTmpInfo.id;$("#datasetname").val(b.name);$("#dsid").val(b.dsid);$("#querysql").val(b.querysql);g()})}if(p==1){var r=$("#querysql").val();var d="";for(var h=0;pageInfo.datasource&&h<pageInfo.datasource.length;h++){if(pageInfo.datasource[h].dsid==$("#dsid").val()){d=pageInfo.datasource[h];break}}var e=$("#datasettabs").tabs("getSelected");$(e).html("加载中...");$.ajax({type:"POST",url:"DataSet!queryMeta.action",data:{querysql:r,datsetid:curTmpInfo.id,ds:(d==""?"":JSON.stringify(d))},dataType:"json",error:function(){$(e).html("SQL执行出错，请确实SQL语句是否编写正确！")},success:function(u){var v='<table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';v=v+"<tr><th>字段名</th><th>显示名</th><th>类型</th><th>操作</th></tr>";for(var t=0;t<u.length;t++){m=u[t];if(b.cols){for(var s=0;s<b.cols.length;s++){if(b.cols[s].name==m.name){m=b.cols[s];break}}}v=v+"<tr><td class='kpiData1 grid3-td'>"+m.name+"</td><td class='kpiData1 grid3-td'><div id=\""+m.name+'_dispName">'+m.dispName+"</div></td><td class='kpiData1 grid3-td'><div id=\""+m.name+'_type">'+m.type+"</div></td><td class='kpiData1 grid3-td'><a href=\"javascript:;\" onclick=\"editDsColumn('"+m.name+"', '"+curTmpInfo.id+"')\">编辑</a></td></tr>"}v=v+"</table>";$(e).html(v);if(!b.cols||b.cols.length==0){b.cols=u}}})}if(p==2){reloadDatasetFilter(b,"dset")}if(p==3){var r=$("#querysql").val();var d="";for(var h=0;pageInfo.datasource&&h<pageInfo.datasource.length;h++){if(pageInfo.datasource[h].dsid==$("#dsid").val()){d=pageInfo.datasource[h];break}}var f=pageInfo.param;var o=pageInfo.vars;var e=$("#datasettabs").tabs("getSelected");$(e).html("加载中...");$(e).load("DataSet!queryData.action",{ds:(d==""?"":JSON.stringify(d)),dataset:JSON.stringify(b),querysql:r,params:f?JSON.stringify(f):"[]",vars:o?JSON.stringify(o):"[]"},function(t,s,u){if(s=="error"){$(e).html("SQL执行出错，请确实SQL语句是否编写正确！")}})}}})}function reloadDatasetFilter(d,g){var f="<a href=\"javascript:newdatasetparam(false, '', '"+g+'\');">新增</a><table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';f=f+"<tr><th>引用标识</th><th>筛选字段</th><th>判断条件</th><th>筛选值</th><th>值类型</th><th>操作</th></tr>";var c;if(g=="dset"){c=d.param}else{c=d.param}for(var b=0;c&&b<c.length;b++){var e=c[b];f=f+'<tr><td class="kpiData1 grid3-td">'+e.filterid+'</td><td class="kpiData1 grid3-td">'+(e.tablealias&&e.tablealias!=""?e.tablealias+".":"")+e.col+'</td><td class="kpiData1 grid3-td">'+e.type+'</td><td class="kpiData1 grid3-td">'+(e.usetype!="param"?(e.val+(e.val2==""?"":"/"+e.val2)):"连接到参数")+'</td><td class="kpiData1 grid3-td">'+e.valuetype+'</td><td class="kpiData1 grid3-td"><a href="javascript:newdatasetparam(true,\''+e.id+"','"+g+"');\">编辑</a> <a href=\"javascript:delDatasetFilter('"+e.id+"','"+g+"');\">删除</a></td></tr>"}f=f+"</table>";if(g=="dset"){var a=$("#datasettabs").tabs("getSelected");$(a).html(f)}else{var a=$("#cubetabs").tabs("getSelected");$(a).html(f)}}function delDatasetFilter(b,d){if(confirm("是否确认删除？")){var c=null;if(d=="dset"){c=findDatasetById(curTmpInfo.id)}else{c=fundCubeById(curTmpInfo.id)}var a=-1;for(i=0;i<c.param.length;i++){if(c.param[i].id==b){a=i}}c.param.splice(a,1);reloadDatasetFilter(c,d)}}function chglinkparam(a,c){var b=$(a).attr("tp");if(b=="gdz"){$(a).attr("tp","param");$("#dsColumn_div #linkparam"+(c==2?"2":"")).css("display","inline-block");$("#dsColumn_div #filtervalue"+(c==2?"2":"")).css("display","none")}else{$(a).attr("tp","gdz");$("#dsColumn_div #filtervalue"+(c==2?"2":"")).css("display","inline-block");$("#dsColumn_div #linkparam"+(c==2?"2":"")).css("display","none")}}function newdatasetparam(w,b,r){var q=null;if(r=="dset"){q=findDatasetById(curTmpInfo.id)}else{q=fundCubeById(curTmpInfo.id)}var v=null;if(q.param){for(i=0;i<q.param.length;i++){if(q.param[i].id==b){v=q.param[i]}}}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var p='<select id="filtercolumn" name="filtercolumn" style="width:120px;'+(v!=null&&(v.coltp=="input")?"display:none":"")+'">';if(r=="dset"){for(i=0;i<q.cols.length;i++){p=p+"<option value='"+q.cols[i].name+"' "+(v!=null&&v.col==q.cols[i].name?"selected":"")+">"+(q.cols[i].dispName==""?q.cols[i].name:q.cols[i].dispName)+"</option>"}}else{var a=q;for(i=0;i<a.dim.length;i++){var o=a.dim[i];if(o.tp=="group"){for(j=0;j<o.children.length;j++){var h=o.children[j];p=p+"<option value='"+h.id+"' "+(v!=null&&v.col==h.id?"selected":"")+">"+h.name+"</option>"}}else{p=p+"<option value='"+o.id+"' "+(v!=null&&v.col==o.id?"selected":"")+">"+o.name+"</option>"}}}p=p+"</select>";var g=["=",">","<","!=","between","in","like"];var u='<select id="filtertype" name="filtertype" class="inputform">';for(i=0;i<g.length;i++){u=u+'<option value="'+g[i]+'" '+(v!=null&&v.type==g[i]?"selected":"")+">"+g[i]+"</option>"}u=u+"</select>";var f='<select id="linkparam" name="linkparam" class="inputform" '+(v==null||v.usetype=="gdz"?'style="display:none"':"")+">";for(i=0;pageInfo.param&&i<pageInfo.param.length;i++){if(pageInfo.param[i].type=="casca"){var e=pageInfo.param[i];for(k=0;k<e.children.length;k++){var h=e.children[k];f=f+'<option value="'+h.id+'" '+(v!=null&&h.id==v.linkparam?"selected":"")+">"+h.desc+"</option>"}}else{f=f+'<option value="'+pageInfo.param[i].id+'" '+(v!=null&&pageInfo.param[i].id==v.linkparam?"selected":"")+">"+pageInfo.param[i].desc+"</option>"}}f=f+"</select>";var c='<select id="linkparam2" name="linkparam2" class="inputform" '+(v==null||v.usetype=="gdz"?'style="display:none"':"")+">";for(i=0;pageInfo.param&&i<pageInfo.param.length;i++){if(pageInfo.param[i].type=="casca"){var e=pageInfo.param[i];for(k=0;k<e.children.length;k++){var h=e.children[k];c=c+'<option value="'+h.id+'" '+(v!=null&&h.id==v.linkparam2?"selected":"")+">"+h.desc+"</option>"}}else{c=c+'<option value="'+pageInfo.param[i].id+'" '+(v!=null&&pageInfo.param[i].id==v.linkparam2?"selected":"")+">"+pageInfo.param[i].desc+"</option>"}}c=c+"</select>";var s='<div class="textpanel"><span class="inputtext">筛选标识：</span><input type="text" name="filterid" id="filterid" class="inputform" '+(w?"readOnly":"")+' value="'+(v!=null?v.filterid:"")+'"><font color=\'#ccc\'>(用在SQL中引用)</font><br/><span class="inputtext">筛选字段：</span><input type="text" id="tablealias" style="width:30px;" value="'+(v!=null&&v.tablealias?v.tablealias:"")+'">.'+p+'<input type="text" style="width:120px;'+(v==null||!v.coltp||v.coltp=="select"?"display:none":"")+'" class="inputform" value="'+(v!=null&&v.col?v.col:"")+'" id="filtercolumn2" name="filtercolumn2"><span class="icon-edit link_param2" id="chgcolumntype" tp="'+(v!=null&&v.coltp?v.coltp:"select")+'" title="手写"></span><br/><span class="inputtext">判断条件：</span>'+u+'<br/><span class="inputtext">筛选值：</span><input type="text" name="filtervalue" id="filtervalue" '+(v!=null&&v.usetype=="param"?'style="display:none"':"")+' value="'+(v!=null?v.val:"")+'" class="inputform">'+f+'<span class="link_param icon-param" tp="'+(v!=null&&v.usetype=="param"?"param":"gdz")+'" title="链接到参数" onclick="chglinkparam(this, 1)"></span><div id="selval2" style="'+(v!=null&&(v.type=="between"||v.type=="in")?"display:block":"display:none")+'"><span class="inputtext">筛选值2：</span><input type="text" name="filtervalue2" id="filtervalue2" value="'+(v!=null?v.val2:"")+'" '+(v!=null&&v.usetype=="param"?'style="display:none"':"")+' class="inputform">'+c+'<span class="link_param icon-param" tp="'+(v!=null&&v.usetype=="param"?"param":"gdz")+'" title="链接到参数" onclick="chglinkparam(this, 2)"></span></div><span class="inputtext">筛选值类型：</span><select name="valuetype" id="valuetype" class="inputform"><option value="number" '+(v!=null&&v.valuetype=="number"?"selected":"")+'>数字类型</option><option value="string" '+(v!=null&&v.valuetype=="string"?"selected":"")+'>字符类型</option><option value="datetime" '+((v!=null&&v.valuetype=="datetime"?"selected":""))+">日期类型</option></select></div>";$("#dsColumn_div").dialog({title:(w==false?"添加筛选条件":"编辑筛选条件"),width:380,height:270,closed:false,cache:false,modal:true,toolbar:null,content:s,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){if(!q.param){q.param=[]}if($("#dsColumn_div #filterid").val()==""){msginfo("筛选标识是必填项！");$("#dsColumn_div #filterid").focus();return}if(ischinese($("#dsColumn_div #filterid").val())){msginfo("筛选标识必须是英文字符！");$("#dsColumn_div #filterid").select();return}var d=$("#dsColumn_div #chgcolumntype").attr("tp");if(w==true){v.filterid=$("#dsColumn_div #filterid").val();if(d=="select"){v.col=$("#dsColumn_div #filtercolumn").val()}else{v.col=$("#dsColumn_div #filtercolumn2").val()}v.coltp=d;v.type=$("#dsColumn_div #filtertype").val();v.val=$("#dsColumn_div #filtervalue").val();v.val2=$("#dsColumn_div #filtervalue2").val();v.valuetype=$("#dsColumn_div #valuetype").val();v.linkparam=$("#dsColumn_div #linkparam").val()==null?"":$("#dsColumn_div #linkparam").val();v.linkparam2=$("#dsColumn_div #linkparam2").val()==null?"":$("#dsColumn_div #linkparam2").val();v.usetype=$("#dsColumn_div .link_param").attr("tp");v.tablealias=$("#dsColumn_div #tablealias").val()}else{q.param.push({id:newGuid(),filterid:$("#dsColumn_div #filterid").val(),col:(d=="select"?$("#dsColumn_div #filtercolumn").val():$("#dsColumn_div #filtercolumn2").val()),type:$("#dsColumn_div #filtertype").val(),val:$("#dsColumn_div #filtervalue").val(),val2:$("#dsColumn_div #filtervalue2").val(),valuetype:$("#dsColumn_div #valuetype").val(),linkparam:($("#dsColumn_div #linkparam").val()==null?"":$("#dsColumn_div #linkparam").val()),linkparam2:($("#dsColumn_div #linkparam2").val()==null?"":$("#dsColumn_div #linkparam2").val()),usetype:$("#dsColumn_div .link_param").attr("tp"),tablealias:$("#dsColumn_div #tablealias").val(),coltp:d})}reloadDatasetFilter(q,r);$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div #chgcolumntype").click(function(){var d=$(this).attr("tp");if(d=="select"){$("#dsColumn_div #filtercolumn").css("display","none");$("#dsColumn_div #filtercolumn2").css("display","inline-block");$(this).attr("tp","input")}else{$("#dsColumn_div #filtercolumn2").css("display","none");$("#dsColumn_div #filtercolumn").css("display","inline-block");$(this).attr("tp","select")}});$("#dsColumn_div #filtertype").change(function(){var d=$(this).val();if(d=="between"||d=="in"){$("#dsColumn_div #selval2").css("display","block")}else{$("#dsColumn_div #selval2").css("display","none")}})}function deletemydata(){if(confirm("是否确认删除？")==false){return}var c=curTmpInfo.tp;var d=curTmpInfo.id;if(c=="dsource"){var b=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("remove",b.target);var a=-1;for(i=0;i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==d){a=i;break}}pageInfo.datasource.splice(a,1)}if(c=="dset"){var b=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("remove",b.target);var a=-1;for(i=0;i<pageInfo.dataset.length;i++){if(pageInfo.dataset[i].datasetid==d){a=i;break}}pageInfo.dataset.splice(a,1)}if(c=="param"){var b=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("remove",b.target);var a=-1;for(i=0;i<pageInfo.param.length;i++){if(pageInfo.param[i].id==d){a=i;break}}pageInfo.param.splice(a,1);initviewTree()}if(c=="var"){var b=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("remove",b.target);var a=-1;for(i=0;i<pageInfo.vars.length;i++){if(pageInfo.vars[i].id==d){a=i;break}}pageInfo.vars.splice(a,1)}if(c=="cube"){var b=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("remove",b.target);var a=-1;for(i=0;i<pageInfo.cube.length;i++){if(pageInfo.cube[i].id==d){a=i;break}}pageInfo.cube.splice(a,1)}curTmpInfo.isupdate=true}function sharemydata(){var b=curTmpInfo.tp;var c=curTmpInfo.id;if(b=="dsource"){var a=findDatasourceById(c);$.ajax({type:"POST",url:"../report/DataSource!saveds.action",dataType:"html",data:{dsid:a.dsid,content:JSON.stringify(a)},success:function(d){if(d=="y"){msginfo("数据源共享成功。","suc")}else{msginfo("该数据源已经共享过了。")}}})}else{alert("暂不支持。")}}function newdatasource(d,a){var c=function(){var f;if(d){f=findDatasourceById(curTmpInfo.id)}var e='<div id="dsource_tab" style="height:auto; width:auto;"><div title="JDBC"><form id="datasourceform" name="datasourceform"><input type="hidden" name="connstate" id="connstate"><div class="textpanel"><span class="inputtext">数据源名称：</span><input type="text" id="dsname" name="dsname" class="inputform" value="'+(f&&f.use=="jdbc"?f.dsname:"")+'"><br/><span class="inputtext">数据源类型：</span><select id="linktype" name="linktype" class="inputform"><option value="mysql" '+(f&&f.use=="jdbc"&&f.linktype=="mysql"?"selected":"")+'>MYSQL</option><option value="oracle" '+(f&&f.use=="jdbc"&&f.use=="jdbc"&&f.linktype=="oracle"?"selected":"")+'>ORACLE</option><option value="sqlserver" '+(f&&f.use=="jdbc"&&f.linktype=="sqlserver"?"selected":"")+'>SQL Server</option></select><br/><span class="inputtext">连接字符串：</span><input type="text" id="linkurl" name="linkurl" class="inputform" value="'+(f&&f.use=="jdbc"?f.linkurl:"jdbc:mysql://ip/database?useUnicode=true&characterEncoding=UTF8")+'"><br/><span class="inputtext">连接用户名：</span><input type="text" id="linkname" name="linkname" class="inputform" value="'+(f&&f.use=="jdbc"?f.linkname:"")+'"> <br/><span class="inputtext">连接密码：</span><input type="password" name="linkpwd" id="linkpwd" class="inputform" value="'+(f&&f.use=="jdbc"?encoder(f.linkpwd,"decode"):"")+'"></div></form></div><div data-options="'+(f&&f.use=="jndi"?"selected:true":"")+'" title="JNDI"><div class="textpanel"><span class="inputtext">JNDI名称：</span><input type="text" value="'+(f&&f.use=="jndi"?f.jndiname:"")+'" class="inputform" name="jndiname" id="jndiname"></div></div></div>';$("#pdailog").dialog({title:d?"编辑数据源":"创建数据源",width:310,height:270,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:e,buttons:[{text:"测试连接",handler:function(){var h=$("#dsource_tab").tabs("getSelected");var g=$("#dsource_tab").tabs("getTabIndex",h);if(g==0){var o=$("#datasourceform").serialize();$.ajax({type:"POST",url:"Data!testConn.action",dataType:"json",data:o,success:function(p){if(p.ret){msginfo("测试成功！","suc");$("#datasourceform #connstate").val("y")}else{msginfo("测试失败！")}}})}else{if(g==1){var o={jndiname:$("#dsource_tab #jndiname").val()};$.ajax({type:"POST",url:"Data!testJNDI.action",dataType:"json",data:o,success:function(p){if(p.ret){msginfo("测试成功！","suc");$("#datasourceform #connstate").val("y")}else{msginfo("测试失败！")}}})}}}},{text:"确定",handler:function(){var h=$("#dsource_tab").tabs("getSelected");var g=$("#dsource_tab").tabs("getTabIndex",h);if(g==0){if($("#datasourceform #dsname").val()==""){msginfo("请输入数据源名称！");$("#datasourceform #dsname").focus();return}if($("#datasourceform #connstate").val()!="y"){msginfo("请先测试连接正常再确定！");return}if(d==false){var p={linktype:$("#linktype").val(),linkname:$("#linkname").val(),linkpwd:encoder($("#linkpwd").val(),"encode"),linkurl:$("#linkurl").val(),dsname:$("#datasourceform #dsname").val(),dsid:newGuid(),use:"jdbc"};if(!pageInfo.datasource){pageInfo.datasource=[]}pageInfo.datasource.push(p);$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='sjy']"),data:[{id:p.dsid,text:p.dsname,iconCls:"icon-dsource",attributes:{showmenu:true,type:"dsource"}}]});$("#mydatatree").tree("expand",$("#mydatatree div[node-id='sjy']"));$("#l_tab").tabs("select",1)}else{for(i=0;i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==curTmpInfo.id){datasource=pageInfo.datasource[i];datasource.linktype=$("#linktype").val();datasource.linkname=$("#linkname").val();datasource.linkpwd=encoder($("#linkpwd").val(),"encode");datasource.linkurl=$("#linkurl").val();datasource.dsname=$("#dsname").val();datasource.use="jdbc";var o=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("update",{target:o.target,text:datasource.dsname});break}}}}else{if(g==1){if($("#dsource_tab #jndiname").val()==""){msginfo("请输入JNDI名称！");$("#dsource_tab #jndiname").focus();return}if($("#datasourceform #connstate").val()!="y"){msginfo("请先测试连接正常再确定！");return}if(d==false){var p={jndiname:$("#dsource_tab #jndiname").val(),dsid:newGuid(),use:"jndi"};if(!pageInfo.datasource){pageInfo.datasource=[]}pageInfo.datasource.push(p);$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='sjy']"),data:[{id:p.dsid,text:p.jndiname,iconCls:"icon-dsource",attributes:{showmenu:true,type:"dsource"}}]});$("#mydatatree").tree("expand",$("#mydatatree div[node-id='sjy']"));$("#comp_tab").tabs("select",1)}else{for(i=0;i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==curTmpInfo.id){datasource=pageInfo.datasource[i];datasource.jndiname=$("#jndiname").val();datasource.use="jndi";var o=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("update",{target:o.target,text:datasource.jndiname});break}}}}}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #dsource_tab").tabs({fit:true,border:false});$("#pdailog #linktype").change(function(){var g=$(this).val();if(g=="mysql"){$("#pdailog #linkurl").val("jdbc:mysql://ip/database?useUnicode=true&characterEncoding=UTF8")}else{if(g=="oracle"){$("#pdailog #linkurl").val("jdbc:oracle:thin:@ip:1521:sid")}else{if(g=="sqlserver"){$("#pdailog #linkurl").val("jdbc:jtds:sqlserver://ip:1433/database")}}}})};var b=function(){var e='<table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';e=e+"<tr><th>选择</th><th>名称</th><th>数据库</th><th>连接字符串</th><th>用户名</th></tr>";var f=null;$.ajax({type:"POST",url:"../report/DataSource!list.action",async:false,dataType:"json",data:"",success:function(g){f=g;for(i=0;i<g.length;i++){var h=g[i];e=e+'<tr><td class=\'kpiData1 grid3-td\'><input type="radio" name="seldsid" value="'+h.dsid+"\" /></td><td class='kpiData1 grid3-td'>"+(h.use=="jndi"?h.jndiname:h.dsname)+"</td><td class='kpiData1 grid3-td'>"+(h.linktype?h.linktype:"")+"</td><td class='kpiData1 grid3-td'>"+(h.linkurl?h.linkurl:"")+"</td><td class='kpiData1 grid3-td'>"+(h.linkname?h.linkname:"")+"</td></tr>"}}});e=e+"</table>";$("#pdailog").dialog({title:"选择数据源",width:620,height:320,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:e,buttons:[{text:"确定",handler:function(){var g=$('#pdailog input[name="seldsid"]:checked').val();if(!g||g==null){msginfo("请至少选择一个数据源！");return}var h=null;for(j=0;j<f.length;j++){if(f[j].dsid==g){h=f[j];break}}if(!pageInfo.datasource){pageInfo.datasource=[]}pageInfo.datasource.push(h);$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='sjy']"),data:[{id:h.dsid,text:(h.use&&h.use=="jndi"?h.jndiname:h.dsname),iconCls:"icon-dsource",attributes:{showmenu:true,type:"dsource"}}]});$("#mydatatree").tree("expand",$("#mydatatree div[node-id='sjy']"));$("#comp_tab").tabs("select",1);$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})};if(a=="new"){c()}else{b()}}function newcube2(){var a=function(){$("#pdailog").dialog({title:"选择已有立方体",width:620,height:400,closed:false,cache:false,modal:true,toolbar:null,content:'<div style="margin:5px;float:left;">立方体分类： <input id="subjectCubeSelect" style="width:200px;"></div><div align="right" style="margin:5px;"><input id="subSearchBox" style="width:160px"></input></div><table id="subjectlist" title="" style="width:610px;height:300px;"><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'name\',width:160">名称</th><th data-options="field:\'fl\',width:100">分类</th><th data-options="field:\'note\',width:300">说明</th></tr></thead></table>',buttons:[{text:"确定",handler:function(){var b=$("#subjectlist").datagrid("getChecked");if(b==null||b.length==0){msginfo("请勾选数据。");return}$.ajax({type:"POST",url:"../bireport/DataSet!reportTree.action",data:"selectDsIds="+b[0].defTid,dataType:"json",success:function(f){if(f.length==0){msginfo("分析主题下无立方体。");return}f=f[0];var c={id:newGuid(),dim:[],kpi:[],datasetid:"",name:f.text,from:"olap",tname:f.tname};var e={id:c.id,text:c.name,iconCls:"icon-cube",attributes:{showmenu:true,type:"cube",from:"olap",tname:f.tname},children:[]};for(var p=0;p<f.dim.length;p++){var q=f.dim[p];if(q.tp=="group"){var r={id:q.id,name:q.name,tp:"group",children:[]};c.dim.push(r);var d={id:q.id,text:q.name,iconCls:"icon-group",attributes:{type:"group",showmenu:false,drag:"n",cubeId:c.id},children:[]};e.children.push(d);for(var h=0;h<q.children.length;h++){var g=q.children[h];r.children.push({id:q.children[h].col_name,name:q.children[h].text,dimkey:g.tableColKey==null?"":g.tableColKey,dimtxt:g.tableColName==null?"":g.tableColName,tname:(g.tableName==null?"":g.tableName),dim_type:q.children[h].dim_type,dimord:q.children[h].dimord,ordcol:q.children[h].ordcol});d.children.push({id:q.children[h].col_name,text:q.children[h].text,iconCls:"icon-dim",attributes:{drag:"y",type:"dim",cubeId:c.id,income:"cube",dimkey:g.tableColKey==null?"":g.tableColKey,dimtxt:g.tableColName==null?"":g.tableColName,tname:(g.tableName==null?"":g.tableName),dim_type:q.children[h].dim_type,dimord:q.children[h].dimord,ordcol:q.children[h].ordcol}})}}else{c.dim.push({id:q.col_name,name:q.text,dimkey:q.tableColKey==null?"":q.tableColKey,dimtxt:q.tableColName==null?"":q.tableColName,tname:(q.tableName==null?"":q.tableName),dim_type:q.dim_type,dimord:q.dimord,ordcol:q.ordcol});e.children.push({id:q.col_name,text:q.text,iconCls:"icon-dim",attributes:{drag:"y",type:"dim",cubeId:c.id,income:"cube",dimkey:q.tableColKey==null?"":q.tableColKey,dimtxt:q.tableColName==null?"":q.tableColName,tname:(q.tableName==null?"":q.tableName),dim_type:q.dim_type,dimord:q.dimord,ordcol:q.ordcol}})}}for(var p=0;p<f.kpi.length;p++){var q=f.kpi[p];c.kpi.push({id:q.alias,name:q.text,fmt:q.fmt,unit:q.unit,aggre:q.aggre,calc:q.calc,expression:(q.calc==1?q.col_name:"")});e.children.push({id:q.alias,text:q.aggre+"("+q.text+")",iconCls:"icon-kpi",attributes:{drag:"y",type:"kpi",fmt:q.fmt,unit:q.unit,aggre:q.aggre,cubeId:c.id,income:"cube",dispName:q.text,calc:q.calc,expression:(q.calc==1?q.col_name:"")}})}if(!pageInfo.cube){pageInfo.cube=[]}pageInfo.cube.push(c);$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='lft']"),data:e});$("#mydatatree").tree("expand",$("#mydatatree div[node-id='lft']"))}});$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#subjectCubeSelect").combotree({url:"../report/SubjectManager!tree.action",onClick:function(b){$("#subjectlist").datagrid("load",{id:b.id,t:Math.random()})}});$("#subSearchBox").searchbox({searcher:function(c,b){$("#subjectlist").datagrid("load",{id:"0",key:c,t:Math.random()})},prompt:"请输入查询关键字."});$("#subjectlist").datagrid({singleSelect:true,collapsible:false,pagination:true,pageSize:20,border:true,url:"../report/SubjectManager!listSubject.action",method:"post",queryParams:{id:"0",t:Math.random()}})};a()}function newcube(c,b){curTmpInfo.id=b;var a=null;if(b){a=fundCubeById(b)}if(a==null&&!pageInfo.dataset){msginfo("创建立方体前，请先创建数据集！");return}$("#pdailog").dialog({title:c==true?"编辑立方体":"创建立方体",width:690,height:400,closed:false,cache:false,modal:true,toolbar:null,content:'<div id="cubetabs" ><div title="数据集" ></div><div title="维度和度量"></div>'+(a!=null&&a.from=="olap"?'<div title="立方体筛选"></div>':"")+"</div>",onLoad:function(){},buttons:[{text:"确定",handler:function(){if($("#pdailog #cubename").val()==""){msginfo("您还未录入立方体名称。");return}if(!pageInfo.cube){pageInfo.cube=[]}if(c){a.datasetid=$("#pdailog #datasetid").val();a.name=$("#pdailog #cubename").val();var w=$("#cuberighttree").tree("getRoot");var h=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("update",{target:h.target,text:a.name});if(w==null){curTmpInfo.isupdate=true;$("#pdailog").dialog("close");return}a.dim=[];a.kpi=[];var p=$("#mydatatree").tree("getChildren",h.target);for(var r=0;r<p.length;r++){$("#mydatatree").tree("remove",p[r].target)}var u=[];var q=null;var x=null;var s=$("#cuberighttree").tree("getChildren",w.target);for(r=0;r<s.length;r++){var z=s[r];if(z.attributes&&(z.attributes.tp=="dim"||z.attributes.tp=="group")){if(q!=null){var y=$("#cuberighttree").tree("getParent",z.target);if(!y.attributes||y.attributes.tp!="group"){q=null;x=null}}if(z.attributes.tp=="group"){var g={id:z.id,name:z.attributes.dispName,tp:"group",children:[]};a.dim.push(g);x=g.children}else{var f=x==null?a.dim:x;f.push({id:z.id,name:z.text,dimkey:z.attributes.dimkey,dimtxt:z.attributes.dimtxt})}if(z.attributes.tp=="group"){var g={id:z.id,text:z.text,iconCls:"icon-group",attributes:{showmenu:false,drag:"n",type:"group",cubeId:a.id},children:[]};u.push(g);q=g.children}else{var f=q==null?u:q;f.push({id:z.id,text:z.text,iconCls:"icon-dim",attributes:{drag:"y",type:"dim",cubeId:a.id,income:"cube",dimkey:z.attributes.dimkey,dimtxt:z.attributes.dimtxt}})}}else{if(z.attributes&&z.attributes.tp=="kpi"){var v=z.attributes;a.kpi.push({id:z.id,name:v.dispName,fmt:v.fmt,unit:v.unit,aggre:v.aggre,expression:v.expression,calc:v.calc});u.push({id:z.id,text:v.aggre+"("+v.dispName+")",iconCls:(v.calc==1?"icon-ckpi":"icon-kpi"),attributes:{drag:"y",type:"kpi",expression:v.expression,calc:v.calc,fmt:v.fmt,unit:v.unit,aggre:v.aggre,cubeId:a.id,income:"cube",dispName:v.dispName}})}}}$("#mydatatree").tree("append",{parent:h.target,data:u})}else{var w=$("#cuberighttree").tree("getRoot");var h=$("#mydatatree").tree("getSelected");if(w==null){msginfo("您还未设置立方体的维和度量。");return}var d={id:newGuid(),dim:[],kpi:[],datasetid:$("#pdailog #datasetid").val(),name:$("#pdailog #cubename").val()};var e=[];var s=$("#cuberighttree").tree("getChildren",w.target);var q=null;var x=null;for(r=0;r<s.length;r++){var z=s[r];if(z.attributes&&(z.attributes.tp=="dim"||z.attributes.tp=="group")){if(q!=null){var y=$("#cuberighttree").tree("getParent",z.target);if(!y.attributes||y.attributes.tp!="group"){q=null;x=null}}if(z.attributes.tp=="group"){var g={id:z.id,name:z.attributes.dispName,tp:"group",children:[]};d.dim.push(g);x=g.children}else{var f=x==null?d.dim:x;f.push({id:z.id,name:z.text,dimkey:z.attributes.dimkey,dimtxt:z.attributes.dimtxt})}if(z.attributes.tp=="group"){var g={id:z.id,text:z.text,iconCls:"icon-group",attributes:{type:"group",showmenu:false,drag:"n",cubeId:d.id},children:[]};e.push(g);q=g.children}else{var f=q==null?e:q;f.push({id:z.id,text:z.text,iconCls:"icon-dim",attributes:{drag:"y",type:"dim",cubeId:d.id,income:"cube",dimkey:z.attributes.dimkey,dimtxt:z.attributes.dimtxt}})}}else{if(z.attributes&&z.attributes.tp=="kpi"){var v=z.attributes;d.kpi.push({id:z.id,name:z.attributes.dispName,expression:v.expression,calc:v.calc,fmt:z.attributes.fmt,unit:z.attributes.unit,aggre:z.attributes.aggre});e.push({id:z.id,text:z.attributes.aggre+"("+z.attributes.dispName+")",iconCls:(v.calc==1?"icon-ckpi":"icon-kpi"),attributes:{drag:"y",type:"kpi",expression:v.expression,calc:v.calc,fmt:z.attributes.fmt,unit:z.attributes.unit,aggre:z.attributes.aggre,cubeId:d.id,income:"cube",dispName:z.attributes.dispName}})}}}$("#mydatatree").tree("append",{parent:h.target,data:[{id:d.id,text:d.name,iconCls:"icon-cube",attributes:{showmenu:true,type:"cube"},children:e}]});pageInfo.cube.push(d)}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#cubetabs").tabs({border:false,fit:true,tabPosition:"left",plain:false,onSelect:function(v,u){var q='<div style="margin:10px;" style="">';if(u==0){var g=$("#cubetabs").tabs("getSelected");if($(g).html()!=""){return}var o="";for(i=0;pageInfo.dataset&&i<pageInfo.dataset.length;i++){var h=pageInfo.dataset[i];if(c){o=o+(a!=null&&a.datasetid==h.datasetid?'<option value="'+h.datasetid+'">'+h.name+"</option>":"")}else{o=o+'<option value="'+h.datasetid+'" '+(a!=null&&a.datasetid==h.datasetid?"selected":"")+">"+h.name+"</option>"}}q=q+'<span class="inputtext">立方体名称：</span><input type="text" class="inputform" name="cubename" id="cubename" value="'+(a==null?"":a.name)+'"><br><br/>';if(a!=null&&a.from=="olap"){q=q+"(PS：立方体数据来源于多维分析的数据模型，相关信息不能修改)"}else{q=q+'<span class="inputtext">数据集：</span><select class="inputform" id="datasetid" name="datasetid">'+o+"</select>"+(c?"(不可更改)":"")}q=q+"</div>";$(g).html(q)}else{if(u==2){reloadDatasetFilter(a,"cube")}else{if(u==1){if(a!=null&&a.from=="olap"){$("#cubetabs").tabs("getSelected").html("(PS：立方体数据来源于多维分析的数据模型，相关信息不能修改)");return}var r="";var t=findDatasetById($("#cubetabs #datasetid").val());var s=t.cols;for(i=0;i<s.length;i++){r=r+"<li data-options=\"id:'"+s[i].name+"',iconCls:'icon-dscol',attributes:{tp:'node',dispName:'"+(s[i].dispName==""?s[i].name:s[i].dispName)+"'}\"><span>"+(s[i].dispName==""?s[i].name:s[i].dispName)+"</span></li>"}var w="";if(a!=null){w=w+"<ul>";for(i=0;i<a.dim.length;i++){if(a.dim[i].tp=="group"){w=w+"<li data-options=\"id:'"+a.dim[i].id+"',iconCls:'icon-group',attributes:{tp:'group',dispName:'"+a.dim[i].name+"',drag:true}\">";w=w+"<span>"+a.dim[i].name+"</span>";w=w+"<ul>";for(k=0;k<a.dim[i].children.length;k++){var p=a.dim[i].children[k];w=w+"<li data-options=\"id:'"+p.id+"',iconCls:'icon-dim',attributes:{tp:'dim',drag:true,dimkey:'"+p.dimkey+"',dimtxt:'"+(p.dimtxt?p.dimtxt:"")+"'}\"><span>"+p.name+"</span></li>"}w=w+"</ul>";w=w+"</li>"}else{w=w+"<li data-options=\"id:'"+a.dim[i].id+"',iconCls:'icon-dim',attributes:{tp:'dim',drag:true,dimkey:'"+a.dim[i].dimkey+"',dimtxt:'"+(a.dim[i].dimtxt?a.dim[i].dimtxt:"")+"'}\"><span>"+a.dim[i].name+"</span></li>"}}w=w+"</ul>"}var x="";if(a!=null){x=x+"<ul>";for(i=0;i<a.kpi.length;i++){x=x+"<li data-options=\"id:'"+a.kpi[i].id+"',iconCls:'"+(a.kpi[i].calc==1?"icon-ckpi":"icon-kpi")+"',attributes:{tp:'kpi',drag:true,dispName:'"+a.kpi[i].name+"',"+(a.kpi[i].calc==1?"calc:1,":"")+"expression:'"+(a.kpi[i].expression?a.kpi[i].expression:"")+"',unit:'"+(a.kpi[i].unit?a.kpi[i].unit:"")+"',fmt:'"+(a.kpi[i].fmt?a.kpi[i].fmt:"")+"',aggre:'"+(a.kpi[i].aggre?a.kpi[i].aggre:"")+"'}\"><span>"+a.kpi[i].aggre+"("+a.kpi[i].name+")</span></li>"}x=x+"</ul>"}var f='<ul id="cuberighttree"><li data-options="iconCls:\'icon-cube\'"><span>数据立方体</span><ul><li data-options="iconCls:\'icon-dim\'" id="cubewd"><span>维度</span>'+w+'</li><li data-options="iconCls:\'icon-kpi\'" id="cubedl"><span>度量</span>'+x+"</li></ul></li></ul>";q=q+'<div class="cubeleft"><div class="cubetitle">待选数据字段：</div><ul id="cubelefttree"><li data-options="iconCls:\'icon-dataset2\',attributes:{tp:\'root\'}"><span>'+t.name+"</span><ul>"+r+'</ul></li></ul></div><div class="cubecenter"><p style="height:100px;"></p><input type="button" onclick="ds2cube()" value=">" title="选择"><br><input type="button" title="移除" value="<" onclick="cube2ds()"></div><div class="cuberight"><div class="cubetitle">维度和度量：</div>'+f+'</div><div style="width:60px;" class="cubecenter"><a href="javascript:;" id="crtdimgroup" data-options="plain:true,iconCls:\'icon-add\'">分组</a><a  href="javascript:editCalcKpi(false);" id="crtcalckpi" data-options="plain:true,iconCls:\'icon-add\'">度量</a><a href="javascript:editcubecol();" id="dim_editbtn" data-options="plain:true,iconCls:\'icon-edit\'">编辑</a><a href="javascript:cube2ds();" id="dim_delbtn" data-options="plain:true,iconCls:\'icon-cancel\'">删除</a></div>';q=q+"</div>";var g=$("#cubetabs").tabs("getSelected");$(g).html(q);$("#dim_editbtn,#dim_delbtn,#crtdimgroup,#crtcalckpi").linkbutton();$("#crtdimgroup").bind("click",function(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var y='<div class="textpanel"><span class="inputtext">分组名称：</span><input type="text" value="" id="groupname" name="groupname" class="inputform"></div>';$("#dsColumn_div").dialog({title:"创建维度分组",width:300,height:150,closed:false,cache:false,modal:true,toolbar:null,content:y,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var z=$("#dsColumn_div #groupname").val();if(z==""){msginfo("请填写分组名称！");$("#dsColumn_div #groupname").focus();return}var B=newGuid();var A={id:B,text:z,iconCls:"icon-group",attributes:{tp:"group",dispName:z,drag:true}};$("#cuberighttree").tree("append",{parent:$("#cuberighttree div[node-id='cubewd']"),data:[A]});$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]})});$("#cubelefttree").tree({dnd:false,onBeforeDrag:function(y){if(y.attributes==undefined){return false}return true},onDragEnter:function(z,y){return false}});$("#cuberighttree").tree({dnd:true,onBeforeDrag:function(y){if(y.attributes&&y.attributes.drag){return true}else{return false}},onDragEnter:function(B,A){var z=$("#cuberighttree").tree("getNode",B);if(!z.attributes||z.attributes.drag==false){return false}if(A.attributes.tp=="kpi"&&z.attributes.tp=="dim"){return false}if(z.attributes.tp=="kpi"&&A.attributes.tp=="dim"){return false}if(A.attributes.tp=="group"&&z.attributes.tp=="kpi"){return false}var y=$("#cuberighttree").tree("getParent",B);if(A.attributes.tp=="group"&&y.attributes&&y.attributes.tp=="group"){return false}return true},onBeforeDrop:function(C,B,y){var A=$("#cuberighttree").tree("getNode",C);if(!A.attributes||A.attributes.drag==false){return false}if(A.attributes.tp=="kpi"&&y=="append"){return false}if(A.attributes.tp=="dim"&&y=="append"){return false}if(B.attributes.tp=="kpi"&&A.attributes.tp=="dim"){return false}if(A.attributes.tp=="kpi"&&B.attributes.tp=="dim"){return false}if(B.attributes.tp=="group"&&A.attributes.tp=="kpi"){return false}var z=$("#cuberighttree").tree("getParent",C);if(B.attributes.tp=="group"&&z.attributes&&z.attributes.tp=="group"){return false}if(B.attributes.tp=="group"&&A.attributes.tp=="group"&&y=="append"){return false}return true},onDblClick:function(){editcubecol()}});var e=function(A){var z=null;for(j=0;j<a.dim.length;j++){if(a.dim[j].tp=="group"){var y=a.dim[j].children;for(k=0;k<y.length;k++){if(y[k].id==A){z=y[k];break}}if(z!=null){break}}else{if(a.dim[j].id==A){z=a.dim[j];break}}}if(z==null){for(j=0;j<a.kpi.length;j++){if(a.kpi[j].id==A){z=a.kpi[j]}}}return z};if(a!=null){var d=$("#cubelefttree").tree("getChildren",$("#cubelefttree").tree("getRoot").target);for(i=0;i<d.length;i++){if(e(d[i].id)!=null){$(d[i].target).attr("hide","y").hide()}}}}}}}})}function editCalcKpi(b,f){var g;if(b){g=$("#cuberighttree").tree("getSelected")}var h=["sum","avg","count","max","min"];var c="";for(i=0;i<h.length;i++){c=c+'<option value="'+h[i]+'" '+(g&&h[i]==g.attributes.aggre?"selected":"")+">"+h[i]+"</option>"}var d="";var e=$("#cuberighttree").tree("getChildren",$("#cuberighttree  div[node-id='cubedl']"));for(i=0;i<e.length;i++){var a=e[i].attributes;if(a.calc!=1){d=d+'<span name="'+e[i].id+'" aggre="'+a.aggre+'" class="column">'+a.dispName+"</span> "}}var o='<div class="textpanel"><span class="inputtext">显示名称：</span><input type="text" class="inputform" name="kpiname" id="kpiname" value="'+(g?g.attributes.dispName:"")+'"><br/><table cellspacing="0" cellpadding="0"><tbody><tr><td valign="top"><span class="inputtext">表 达 式：</span></td><td><textarea rows="2" style="height:52px;" cols="40" id="expression" name="expression">'+(g?g.attributes.expression:"")+'</textarea></td></tr></tbody></table><div class="actColumn">'+d+'</div><span class="inputtext">计算方式：</span><select id="kpiaggre" name="kpiaggre" class="inputform">'+c+'</select><br><span class="inputtext">度量单位：</span><input type="text" value="'+(g?g.attributes.unit:"")+'" class="inputform" name="kpiunit" id="kpiunit"><br/><span class="inputtext">格式化：</span>'+curTmpInfo.property.ftmstr("kpifmt","inputform",(g?g.attributes.fmt:""))+"<br/></div>";if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:b?"编辑":"创建表达式度量",width:420,height:330,closed:false,cache:false,modal:true,toolbar:null,content:o,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var p=$("#dsColumn_div #kpiname").val();var r=$("#dsColumn_div #expression").val();if(p==""){msginfo("请填写度量名称。");$("#dsColumn_div #kpiname").focus();return}if(r==""){msginfo("请填写度量表达式。");$("#dsColumn_div #expression").focus();return}if(b){g.attributes.aggre=$("#dsColumn_div #kpiaggre").val();g.attributes.fmt=$("#dsColumn_div #kpifmt").val();g.attributes.unit=$("#dsColumn_div #kpiunit").val();g.attributes.dispName=p;g.attributes.expression=r;$("#cuberighttree").tree("update",{target:g.target,text:g.attributes.aggre+"("+p+")"})}else{var s=newGuid();var q={id:s,text:$("#dsColumn_div #kpiaggre").val()+"("+p+")",attributes:{tp:"kpi",calc:1,drag:true,aggre:$("#dsColumn_div #kpiaggre").val(),expression:r,dispName:p,fmt:$("#dsColumn_div #kpifmt").val(),unit:$("#dsColumn_div #kpiunit").val()},iconCls:"icon-ckpi"};$("#cuberighttree").tree("append",{parent:$("#cuberighttree  div[node-id='cubedl']"),data:[q]})}$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div .actColumn .column").bind("click",function(){var p=$(this).attr("name");var q=$(this).attr("aggre");insertText2focus(document.getElementById("expression"),q+"("+p+") ")})}function editcubecol(){var h=$("#cuberighttree").tree("getSelected");if(h==null){msginfo("您还未选择需要编辑的度量或维度。");return}var a=h.id;if(!a||!h.attributes){return}if(h.attributes.tp=="kpi"&&h.attributes.calc==1){editCalcKpi(true,a);return}var o="";var g=["sum","avg","count","max","min"];var d="";if(h.attributes.tp=="dim"){var f=$("#cubelefttree").tree("getRoot");var e=$("#cubelefttree").tree("getChildren",f.target);var b="";var c='<option value=""></option>';for(i=0;i<e.length;i++){b=b+'<option value="'+e[i].id+'" '+(e[i].id==h.attributes.dimkey?"selected":"")+">"+e[i].attributes.dispName+"</option>";c=c+'<option value="'+e[i].id+'" '+(e[i].id==h.attributes.dimtxt?"selected":"")+">"+e[i].attributes.dispName+"</option>"}o='<div class="textpanel"><span class="inputtext">维度名称：</span><input type="text" id="dimname" name="dimname" class="inputform" value="'+h.text+'"><br/><span class="inputtext">KEY字段：</span><select id="dimkey" class="inputform">'+b+'</select><br><span class="inputtext">Text字段：</span><select id="dimtxt" class="inputform">'+c+"</select><br></div>"}else{if(h.attributes.tp=="kpi"){for(i=0;i<g.length;i++){d=d+'<option value="'+g[i]+'" '+(g[i]==h.attributes.aggre?"selected":"")+">"+g[i]+"</option>"}o='<div class="textpanel"><span class="inputtext">度量名称：</span><input type="text" id="kpiname" name="kpiname" class="inputform" value="'+h.attributes.dispName+'"><br/><span class="inputtext">对应字段：</span>'+h.id+'<br/><span class="inputtext">计算方式：</span><select id="kpiaggre" name="kpiaggre" class="inputform">'+d+'</select> <br><span class="inputtext">度量单位：</span><input type="text" id="kpiunit" name="kpiunit" class="inputform" value="'+(h.attributes.unit?h.attributes.unit:"")+'"> <br><span class="inputtext">格式化：</span>'+curTmpInfo.property.ftmstr("kpifmt","inputform",h.attributes.fmt?h.attributes.fmt:"")+"</div>"}else{if(h.attributes.tp=="group"){o='<div class="textpanel"><span class="inputtext">分组名称：</span><input type="text" id="groupname" name="groupname" value="'+h.attributes.dispName+'" class="inputform"></div>'}}}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:"编辑度量及维度",width:350,height:240,closed:false,cache:false,modal:true,toolbar:null,content:o,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){if(h.attributes.tp=="kpi"){$("#cuberighttree").tree("update",{target:h.target,text:$("#dsColumn_div #kpiaggre").val()+"("+$("#dsColumn_div #kpiname").val()+")"});h.attributes.aggre=$("#dsColumn_div #kpiaggre").val();h.attributes.fmt=$("#dsColumn_div #kpifmt").val();h.attributes.unit=$("#dsColumn_div #kpiunit").val();h.attributes.dispName=$("#dsColumn_div #kpiname").val()}else{if(h.attributes.tp=="group"){h.attributes.dispName=$("#dsColumn_div #groupname").val();$("#cuberighttree").tree("update",{target:h.target,text:$("#dsColumn_div #groupname").val()})}else{if(h.attributes.tp=="dim"){$("#cuberighttree").tree("update",{target:h.target,text:$("#dsColumn_div #dimname").val()});h.attributes.dimkey=$("#dsColumn_div #dimkey").val();h.attributes.dimtxt=$("#dsColumn_div #dimtxt").val()}}}$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function cube2ds(){var c=$("#cuberighttree").tree("getSelected");if(c==null){msginfo("您还未选择需要删除的度量或维度。");return}var b=$("#cubelefttree").tree("getParent",c.target);if(!(b!=null&&(b.text=="度量"||b.text=="维度"))){return}var e=c.id;var a=$("#cubelefttree").tree("getRoot");var d=$("#cubelefttree").tree("getChildren",a.target);for(i=0;i<d.length;i++){if(d[i].id==e){$(d[i].target).attr("hide","n").show();break}}$("#cuberighttree").tree("remove",c.target)}function ds2cube(){var b=$("#cubelefttree").tree("getSelected");if(b==null){msginfo("您还未从左边选择字段。");return}if($(b.target).attr("hide")=="y"){return}var a=$("#cuberighttree").tree("getSelected");if(a==null){msginfo("您还未选择右边度量或维度。");return}if(a.text=="度量"){$("#cuberighttree").tree("append",{parent:a.target,data:{id:b.id,text:"sum("+b.text+")",attributes:{tp:"kpi",drag:true,aggre:"sum",dispName:b.text},iconCls:"icon-kpi"}});$(b.target).attr("hide","y").hide()}else{if(a.text=="维度"){$("#cuberighttree").tree("append",{parent:a.target,data:{id:b.id,text:b.text,attributes:{tp:"dim",drag:true,dimkey:b.id},iconCls:"icon-dim"}});$(b.target).attr("hide","y").hide()}}}function newdataset(){$("#pdailog").dialog({title:"创建数据集",width:650,height:400,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},buttons:[{text:"确定",handler:function(){var d=$("#pdailog #querysql").val();var a=$("#pdailog #datasetname").val();var c=$("#pdailog #dsid").val();if(a==""){msginfo("请填写数据集名称。");$("#datasetname").focus();return}if(d==""){msginfo("请填写查询字符串。");$("#querysql").focus();return}if(!pageInfo.dataset){pageInfo.dataset=[]}var e="";for(i=0;pageInfo.datasource&&i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==c){e=pageInfo.datasource[i]}}var b={querysql:d,name:a,dsid:c,datasetid:newGuid()};$.ajax({type:"POST",url:"DataSet!queryMeta.action",data:{querysql:d,ds:(e==""?"":JSON.stringify(e))},dataType:"json",success:function(f){b.cols=f;pageInfo.dataset.push(b);initmydatatree(true);curTmpInfo.isupdate=true;$("#pdailog").dialog("close")},error:function(){alert("查询字符串(sql)语句出错了,请检查。")}})}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","DataSet!crtDataSet.action?showparam=0")}function editDsColumn(e,d){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var g=null;for(var c=0;c<pageInfo.dataset.length;c++){if(pageInfo.dataset[c].datasetid==d){g=pageInfo.dataset[c];break}}var b=null;for(var c=0;c<g.cols.length;c++){if(g.cols[c].name==e){b=g.cols[c];break}}var f="";for(var c=0;c<dataType.length;c++){f=f+'<option value="'+dataType[c]+'" '+(b.type==dataType[c]?"selected":"")+">"+dataType[c]+"</option>"}var a='<div class="textpanel"><span class="inputtext">字段名：</span>'+b.name+'<br/><span class="inputtext">显示名：</span><input type="text" name="coldispname" id="coldispname" value="'+b.dispName+'" class="inputform"><br/><span class="inputtext">类型：</span><select id="coltype" class="inputform">'+f+"</select></div>";$("#dsColumn_div").dialog({title:"编辑字段信息",width:350,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){b.dispName=$("#dsColumn_div #coldispname").val();b.type=$("#dsColumn_div #coltype").val();curTmpInfo.isupdate=true;$("#datasettabs #"+b.name+"_dispName").text(b.dispName);$("#datasettabs #"+b.name+"_type").text(b.type);$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]})}if($==undefined){$=jQuery}var kpirate=[{text:"1",value:"1"},{text:"千",value:"1000"},{text:"万",value:"10000"},{text:"百万",value:"1000000"},{text:"亿",value:"100000000"}];var colorJson=[{text:"无",value:""},{text:"黑色",value:"#000000"},{text:"白色",value:"#FFFFFF"},{text:"红色",value:"#FF0000"},{text:"鲜绿色",value:"#00FF00"},{text:"蓝色",value:"#0000FF"},{text:"黄色",value:"#FFFF00"},{text:"粉红色",value:"#FF00FF"},{text:"青绿色",value:"#00FFFF"},{text:"深红色",value:"#800000"},{text:"绿色",value:"#008000"},{text:"深蓝色",value:"#000080"},{text:"深黄色",value:"#808000"},{text:"紫罗兰",value:"#800080"},{text:"青色",value:"#008080"},{text:"灰－25％",value:"#C0C0C0"},{text:"灰－50％",value:"#808080"},{text:"海螺色",value:"#9999FF"},{text:"梅红色",value:"#993366"},{text:"象牙色",value:"#FFFFCC"},{text:"浅青绿",value:"#CCFFFF"},{text:"深紫色",value:"#660066"},{text:"珊瑚红",value:"#FF8080"},{text:"海蓝色",value:"#0066CC"},{text:"冰蓝",value:"#CCCCFF"},{text:"深蓝色",value:"#000080"},{text:"粉红色",value:"#FF00FF"},{text:"黄色",value:"#FFFF00"},{text:"青绿色",value:"#00FFFF"},{text:"紫罗兰",value:"#800080"},{text:"深红色",value:"#800000"},{text:"青色",value:"#008080"},{text:"蓝色",value:"#0000FF"},{text:"天蓝色",value:"#00CCFF"},{text:"浅青绿",value:"#CCFFFF"},{text:"浅绿色",value:"#CCFFCC"},{text:"浅黄色",value:"#FFFF99"},{text:"淡蓝色",value:"#99CCFF"},{text:"玫瑰红",value:"#FF99CC"},{text:"淡紫色",value:"#CC99FF"},{text:"茶色",value:"#FFCC99"},{text:"浅蓝色",value:"#3366FF"},{text:"水绿色",value:"#33CCCC"},{text:"酸橙色",value:"#99CC00"},{text:"金色",value:"#FFCC00"},{text:"浅橙色",value:"#FF9900"},{text:"橙色",value:"#FF6600"},{text:"蓝－灰",value:"#666699"},{text:"灰－40％",value:"#969696"},{text:"深青",value:"#003366"},{text:"海绿",value:"#339966"},{text:"深绿",value:"#003300"},{text:"橄榄色",value:"#333300"},{text:"褐色",value:"#993300"},{text:"梅红色",value:"#993366"},{text:"靛蓝色",value:"#333399"},{text:"灰－80％",value:"#333333"}];function setProp(a,c){var b=findCompById(c);var d=findLayoutById(a);if(b.type=="text"){curTmpInfo.property.setTextProp(b,d)}else{if(b.type=="label"){curTmpInfo.property.setLabelProp(b,d)}else{if(b.type=="chart"){curTmpInfo.property.setChartProp(b,d)}else{if(b.type=="cross"){curTmpInfo.property.setCrossProp(b,d)}else{if(b.type=="table"){curTmpInfo.property.setTableProp(b,d)}else{if(b.type=="pic"){curTmpInfo.property.setPicProp(b,d)}else{if(b.type=="staticCross"){curTmpInfo.property.setStaticCrossProp(b,d)}}}}}}}}function compProperties(){this.fmtJson=[{text:"整数",value:"#,###"},{text:"小数(保留一位)",value:"#,###.0"},{text:"小数(保留两位)",value:"#,###.00"},{text:"小数(保留四位)",value:"#,###.0000"},{text:"百分比",value:"#,##0.00%"}],this.setTableProp=function(a,d){var e=$("#T"+a.id+" td.tdselect");if(e.children("div.tabletdcol").size()>0){e=e.children("div.tabletdcol")}$("#reportJLayout").layout("panel","east").panel("setTitle","表格属性面板");if(!a.style){a.style={}}var c=a.style;var b=[{name:"数据集",col:"datasetid",value:(a.datasetid&&findDatasetById(a.datasetid)!=null?findDatasetById(a.datasetid).name:""),group:"数据映射"},{name:"高度",col:"height",value:(e.attr("height")?e.attr("height"):""),group:"单元格属性",editor:"numberbox"},{name:"宽度",col:"pwidth",value:(e.attr("pwidth")?e.attr("pwidth"):""),group:"单元格属性",editor:"numberbox"},{name:"位置",col:"palign",value:(e.attr("palign")?e.attr("palign"):""),group:"单元格属性",editor:{type:"combobox",options:{data:[{value:"left",text:"left"},{value:"center",text:"center"},{value:"right",text:"right"}]}}},{name:"格式化",col:"fmt",value:e.attr("type")=="Double"||e.attr("type")=="Int"?(e.attr("fmt")?e.attr("fmt"):""):"(无)",group:"单元格属性",editor:e.attr("type")=="Double"||e.attr("type")=="Int"?{type:"combobox",options:{data:curTmpInfo.property.fmtJson}}:undefined},{name:"背景颜色",col:"bgcolor",value:(e.attr("bgcolor")?e.attr("bgcolor"):""),group:"单元格属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(f){return'<div style="background-color:'+f.value+'">'+f.text+"</div>"}}}},{name:"字体大小",col:"fontsize",value:(e.attr("fontsize")?e.attr("fontsize"):""),group:"文本字体",editor:"numberbox"},{name:"字体颜色",col:"fontcolor",value:(e.attr("fontcolor")?e.attr("fontcolor"):""),group:"文本字体",editor:{type:"combobox",options:{data:colorJson,formatter:function(f){return'<div style="background-color:'+f.value+'">'+f.text+"</div>"}}}},{name:"是否粗体",col:"fontweight",value:(e.attr("fontweight")?e.attr("fontweight"):""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否斜体",col:"italic",value:(e.attr("italic")?e.attr("italic"):""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否下划线",col:"underscore",value:(e.attr("underscore")?e.attr("underscore"):""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"边框大小",col:"bordersize",value:(c.bordersize?c.bordersize:""),group:"表格边框",editor:"numberbox"},{name:"边框类型",col:"bordertype",value:(c.bordertype?c.bordertype:""),group:"表格边框",editor:{type:"combobox",options:{data:[{text:"实线",value:"solid"},{text:"虚线",value:"dotted"}]}}},{name:"边框颜色",col:"bordercolor",value:(c.bordercolor?c.bordercolor:""),group:"表格边框",editor:{type:"combobox",options:{data:colorJson,formatter:function(f){return'<div style="background-color:'+f.value+'">'+f.text+"</div>"}}}},{name:"内边距(padding)",col:"padding",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+a.id+"', 'padding')\">设置</a></div>",group:"表格边框"},{name:"外边距(margin)",col:"margin",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+a.id+"','margin')\">设置</a></div>",group:"表格边框"},{name:"组件名称",col:"name",value:(a.name?a.name:""),group:"表格属性",editor:"text"},{name:"是否分页",col:"isfy",value:(a.isfy?a.isfy:""),group:"表格属性",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"每页显示记录数",col:"pagesize",value:(a.pagesize?a.pagesize:""),group:"表格属性",editor:"numberbox"},{name:"组件宽度",col:"compwidth",value:(c.compwidth?c.compwidth:""),group:"表格属性",editor:"numberbox"},{name:"组件高度",col:"compheight",value:(c.compheight?c.compheight:""),group:"表格属性",editor:"numberbox"},{name:"是否锁定表头",col:"lockhead",value:(a.lockhead?a.lockhead:""),group:"表格属性",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否显示表尾",col:"isfooter",value:(a.isfooter?a.isfooter:""),group:"表格属性",editor:{type:"checkbox",options:{on:true,off:false}}}];if(e.hasClass("gridtab-th")){b.push({name:"启用排序",col:"order",value:(e.attr("order")?e.attr("order"):""),group:"单元格属性",editor:{type:"checkbox",options:{on:true,off:false}}})}$("#propertytable").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,onAfterEdit:function(p,h,g){var o=h.value;var f=h.col;if(f=="isfooter"||f=="isfy"||f=="pagesize"||f=="lockhead"||f=="name"){a[f]=o}else{if(f=="bordersize"||f=="bordertype"||f=="bordercolor"||f=="padding"||f=="margin"||f=="compwidth"||f=="compheight"){c[f]=o}else{e.attr(f,o)}}if(f=="palign"){e.css("text-align",o)}},data:b})},this.setStaticCrossProp=function(e,d){$("#reportJLayout").layout("panel","east").panel("setTitle","固定表属性面板");var p=$("#"+e.id+" div.cellselect");var o=p.parent().attr("id");var g=$("#"+e.id+" div.cellselect").parents("#d2_rowDims").size()>0?"row":"col";var c=curTmpInfo.scrossTable.findCrossField(o,e,g);if(!e.style){e.style={}}var r=e.style;var b=[];var f=e.head;b.push({name:"立方体",col:"cubeid",value:(fundCubeById(e.cubeId)&&fundCubeById(e.cubeId)!=null?fundCubeById(e.cubeId).name:""),group:"数据映射"});if(c!=null){var a=fundCubeById(e.cubeId);var q=curTmpInfo.scrossTable.findCubeDim(a,c.col);if(!c.style){c.style={}}var h="";if(c.type=="kpi"){h="指标"}else{if(c.type=="none"){h="NONE"}else{h="维度"}}b.push({name:"类型",col:"type",value:h,group:"数据映射"});b.push({name:"值映射",col:"value",value:(c.type=="kpi"?c.col:(c.type=="none"?"":q.name+"("+(c.value?c.value:"未设置")+")")),group:"数据映射"});b.push({name:"显示名称",col:"desc",value:(c.desc),group:"单元格属性",editor:"text"});b.push({name:"高度",col:"height",value:(c.style.height?c.style.height:""),group:"单元格属性",editor:"numberbox"});b.push({name:"宽度",col:"width",value:(c.style.width?c.style.width:""),group:"单元格属性",editor:"numberbox"});b.push({name:"背景颜色",col:"bgcolor",value:(c.style.bgcolor?c.style.bgcolor:""),group:"单元格属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(s){return'<div style="background-color:'+s.value+'">'+s.text+"</div>"}}}});b.push({name:"字体大小",col:"fontsize",value:(c.style.fontsize?c.style.fontsize:""),group:"单元格字体",editor:"numberbox"});b.push({name:"字体颜色",col:"fontcolor",value:(c.style.fontcolor?c.style.fontcolor:""),group:"单元格字体",editor:{type:"combobox",options:{data:colorJson,formatter:function(s){return'<div style="background-color:'+s.value+'">'+s.text+"</div>"}}}});b.push({name:"是否粗体",col:"fontweight",value:(c.style.fontweight?c.style.fontweight:""),group:"单元格字体",editor:{type:"checkbox",options:{on:true,off:false}}});b.push({name:"是否斜体",col:"italic",value:(c.style.italic?c.style.italic:""),group:"单元格字体",editor:{type:"checkbox",options:{on:true,off:false}}});b.push({name:"是否下划线",col:"underscore",value:(c.style.underscore?c.style.underscore:""),group:"单元格字体",editor:{type:"checkbox",options:{on:true,off:false}}})}if(c==null&&p.attr("id")=="jcbt"){b.push({name:"显示内容",col:"hdesc",value:(f.desc?f.desc:""),group:"表头属性",editor:"text"});b.push({name:"高度",col:"height",value:(f.style.height?f.style.height:""),group:"表头属性",editor:"numberbox"});b.push({name:"宽度",col:"width",value:(f.style.width?f.style.width:""),group:"表头属性",editor:"numberbox"});b.push({name:"背景颜色",col:"bgcolor",value:(f.style.bgcolor?f.style.bgcolor:""),group:"表头属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(s){return'<div style="background-color:'+s.value+'">'+s.text+"</div>"}}}});b.push({name:"字体大小",col:"fontsize",value:(f.style.fontsize?f.style.fontsize:""),group:"表头属性",editor:"numberbox"});b.push({name:"字体颜色",col:"fontcolor",value:(f.style.fontcolor?f.style.fontcolor:""),group:"表头属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(s){return'<div style="background-color:'+s.value+'">'+s.text+"</div>"}}}});b.push({name:"是否粗体",col:"fontweight",value:(f.style.fontweight?f.style.fontweight:""),group:"表头属性",editor:{type:"checkbox",options:{on:true,off:false}}});b.push({name:"是否斜体",col:"italic",value:(f.style.italic?f.style.italic:""),group:"表头属性",editor:{type:"checkbox",options:{on:true,off:false}}});b.push({name:"是否下划线",col:"underscore",value:(f.style.underscore?f.style.underscore:""),group:"表头属性",editor:{type:"checkbox",options:{on:true,off:false}}})}b.push({name:"组件名称",col:"name",value:(e.name?e.name:""),group:"固定表属性",editor:"text"});b.push({name:"边框大小",col:"bordersize",value:(r.bordersize?r.bordersize:""),group:"固定表属性",editor:"numberbox"});b.push({name:"边框类型",col:"bordertype",value:(r.bordertype?r.bordertype:""),group:"固定表属性",editor:{type:"combobox",options:{data:[{text:"实线",value:"solid"},{text:"虚线",value:"dotted"}]}}});b.push({name:"边框颜色",col:"bordercolor",value:(r.bordercolor?r.bordercolor:""),group:"固定表属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(s){return'<div style="background-color:'+s.value+'">'+s.text+"</div>"}}}});b.push({name:"内边距(padding)",col:"padding",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+e.id+"', 'padding')\">设置</a></div>",group:"固定表属性"});b.push({name:"外边距(margin)",col:"margin",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+e.id+"','margin')\">设置</a></div>",group:"固定表属性"});$("#propertytable").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,onAfterEdit:function(w,u,t){var v=u.value;var s=u.col;if(s=="name"){e.name=v}else{if(s=="bordersize"||s=="bordertype"||s=="bordercolor"||s=="padding"||s=="margin"){r[s]=v}else{if(s=="desc"||s=="hdesc"){if(s=="desc"){c[s]=v;p.find("span.txt").text(v)}else{f.desc=v;p.text(v)}}else{if(c==null&&p.attr("id")=="jcbt"){f.style[s]=v}else{c.style[s]=v}}}}},data:b})},this.setCrossProp=function(f,e){$("#reportJLayout").layout("panel","east").panel("setTitle","交叉表属性面板");if(!f.style){f.style={}}var q=f.style;var c=[];var b=$("#"+f.id+" table.crosstab2 td.tdselect");var a=null;var p=null;c.push({name:"立方体",col:"cubeid",value:(fundCubeById(f.cubeId)&&fundCubeById(f.cubeId)!=null?fundCubeById(f.cubeId).name:""),group:"数据映射"});if(b.find("div").size()>0){var g=b.find("div").attr("id");if(b.parents("#d_kpi").size()>0){var o=f.kpiJson;for(var d=0;d<o.length;d++){if(o[d].kpi_id==g){a=o[d];break}}p="kpi"}else{if(b.parents("#d_rowDims").size()>0||b.parents("#d_colDims").size()>0){var h=null;if(b.parents("#d_colDims").size()){p="col";h=f.tableJson.cols}else{p="row";h=f.tableJson.rows}for(var d=0;d<h.length;d++){if(h[d].id==g){a=h[d];break}}}else{if(b.parents("#d_rowHead").size()>0){p="head";for(var d=0;d<f.head.length;d++){if(f.head[d].id==g){a=f.head[d];break}}}else{if(b.parents("#d_kpiHead").size()>0){p="kpiHead";for(var d=0;d<f.kpiHead.length;d++){if(f.kpiHead[d].id==g){a=f.kpiHead[d];break}}}}}}if(!a.style){a.style={}}if(p=="col"||p=="row"){c.push({name:"KEY字段",col:"colkey",value:(a.colname),group:"数据映射"});c.push({name:"Text字段",col:"colval",value:(a.colnamedesc),group:"数据映射"});c.push({name:"显示名称",col:"dimdesc",value:(a.dimdesc),group:(p=="col"?"列":"行")+"维度属性",editor:"text"});c.push({name:"排序",col:"dimord",value:(a.dimord?a.dimord:""),group:(p=="col"?"列":"行")+"维度属性",editor:{type:"combobox",options:{data:[{text:"正序",value:"asc"},{text:"倒叙",value:"desc"},{text:"",value:""}]}}});c.push({name:"取TOP",col:"top",value:(a.top?a.top:""),group:(p=="col"?"列":"行")+"维度属性",editor:"numberbox"})}else{if(p=="kpi"){c.push({name:"字段",col:"colname",value:(a.colname),group:"数据映射"});c.push({name:"显示名称",col:"kpi_name",value:(a.kpi_name),group:"度量属性",editor:"text"});c.push({name:"度量单位",col:"unit",value:(a.unit?a.unit:""),group:"度量属性",editor:"text"});c.push({name:"格式化",col:"fmt",value:a.fmt,group:"度量属性",editor:{type:"combobox",options:{data:curTmpInfo.property.fmtJson}}});c.push({name:"排序",col:"sort",value:(a.sort?a.sort:""),group:"度量属性",editor:{type:"combobox",options:{data:[{text:"正序",value:"asc"},{text:"倒叙",value:"desc"},{text:"",value:""}]}}})}else{c.push({name:"显示名称",col:"desc",value:(a.desc),group:"单元格属性",editor:"text"})}}c.push({name:"高度",col:"height",value:(a.style.height?a.style.height:""),group:"单元格属性",editor:"numberbox"});if(p=="head"||p=="kpiHead"){c.push({name:"宽度",col:"width",value:(a.style.width?a.style.width:""),group:"单元格属性",editor:"numberbox"})}if(p=="kpiHead"){c.push({name:"启用排序",col:"kpiOrder",value:(a.kpiOrder?a.kpiOrder:""),group:"单元格属性",editor:{type:"checkbox",options:{on:true,off:false}}})}c.push({name:"背景颜色",col:"bgcolor",value:(a.style.bgcolor?a.style.bgcolor:""),group:"单元格属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(r){return'<div style="background-color:'+r.value+'">'+r.text+"</div>"}}}});c.push({name:"字体大小",col:"fontsize",value:(a.style.fontsize?a.style.fontsize:""),group:"单元格字体",editor:"numberbox"});c.push({name:"字体颜色",col:"fontcolor",value:(a.style.fontcolor?a.style.fontcolor:""),group:"单元格字体",editor:{type:"combobox",options:{data:colorJson,formatter:function(r){return'<div style="background-color:'+r.value+'">'+r.text+"</div>"}}}});c.push({name:"是否粗体",col:"fontweight",value:(a.style.fontweight?a.style.fontweight:""),group:"单元格字体",editor:{type:"checkbox",options:{on:true,off:false}}});c.push({name:"是否斜体",col:"italic",value:(a.style.italic?a.style.italic:""),group:"单元格字体",editor:{type:"checkbox",options:{on:true,off:false}}});c.push({name:"是否下划线",col:"underscore",value:(a.style.underscore?a.style.underscore:""),group:"单元格字体",editor:{type:"checkbox",options:{on:true,off:false}}})}c.push({name:"组件名称",col:"name",value:(f.name?f.name:""),group:"交叉表属性",editor:"text"});c.push({name:"组件宽度",col:"compwidth",value:(f.compwidth?f.compwidth:""),group:"交叉表属性",editor:"numberbox"});c.push({name:"组件高度",col:"compheight",value:(f.compheight?f.compheight:""),group:"交叉表属性",editor:"numberbox"});c.push({name:"是否锁定表头",col:"lockhead",value:(f.lockhead?f.lockhead:""),group:"交叉表属性",editor:{type:"checkbox",options:{on:true,off:false}}});c.push({name:"边框大小",col:"bordersize",value:(q.bordersize?q.bordersize:""),group:"交叉表属性",editor:"numberbox"});c.push({name:"边框类型",col:"bordertype",value:(q.bordertype?q.bordertype:""),group:"交叉表属性",editor:{type:"combobox",options:{data:[{text:"实线",value:"solid"},{text:"虚线",value:"dotted"}]}}});c.push({name:"边框颜色",col:"bordercolor",value:(q.bordercolor?q.bordercolor:""),group:"交叉表属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(r){return'<div style="background-color:'+r.value+'">'+r.text+"</div>"}}}});c.push({name:"内边距(padding)",col:"padding",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+f.id+"', 'padding')\">设置</a></div>",group:"交叉表属性"});c.push({name:"外边距(margin)",col:"margin",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+f.id+"','margin')\">设置</a></div>",group:"交叉表属性"});$("#propertytable").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,onAfterEdit:function(v,t,s){var u=t.value;var r=t.col;if(r=="name"||r=="lockhead"||r=="compwidth"||r=="compheight"){f[r]=u}else{if(r=="bordersize"||r=="bordertype"||r=="bordercolor"||r=="padding"||r=="margin"){q[r]=u}else{if(r=="dimdesc"||r=="dimord"||r=="top"||r=="kpi_name"||r=="unit"||r=="fmt"||r=="sort"||r=="desc"||r=="kpiOrder"){a[r]=u;if(r=="kpi_name"){b.find("span.txt").text(u)}else{if(r=="dimdesc"){b.find("span.txt").text(u)}else{if(r=="desc"){b.find("div").text(u)}}}}else{a.style[r]=u}}}},data:c})},this.setChartProp=function(a,c){$("#reportJLayout").layout("panel","east").panel("setTitle","图形属性面板");if(!a.style){a.style={}}var b=a.style;$("#propertytable").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,onAfterEdit:function(h,f,e){var g=f.value;var d=f.col;if(d=="width"){a.chartJson.width=g;$("#"+a.id+" div.ctx img").attr("width",a.chartJson.width)}else{if(d=="height"){a.chartJson.height=g;$("#"+a.id+" div.ctx img").attr("height",a.chartJson.height)}else{if(d=="name"){a.name=g}else{if(d=="align"){a.chartJson.align=g;$("#"+a.id+" .ctx").css("text-align",g)}else{a.style[d]=g}}}}},data:[{name:"组件名称",col:"name",value:(a.name?a.name:""),group:"图形属性",editor:"text"},{name:"高度",col:"height",value:(a.chartJson.height?a.chartJson.height:""),group:"图形属性",editor:"numberbox"},{name:"宽度",col:"width",value:(a.chartJson.width?a.chartJson.width:""),group:"图形属性",editor:"numberbox"},{name:"位置",col:"align",value:(a.chartJson.align?a.chartJson.align:"center"),group:"图形属性",editor:{type:"combobox",options:{data:[{value:"left",text:"left"},{value:"center",text:"center"},{value:"right",text:"right"}]}}},{name:"边框颜色",col:"bordercolor",value:(b.bordercolor?b.bordercolor:""),group:"图形边框",editor:{type:"combobox",options:{data:colorJson,formatter:function(d){return'<div style="background-color:'+d.value+'">'+d.text+"</div>"}}}},{name:"边框大小",col:"bordersize",value:(b.bordersize?b.bordersize:""),group:"图形边框",editor:"numberbox"},{name:"边框类型",col:"bordertype",value:(b.bordertype?b.bordertype:""),group:"图形边框",editor:{type:"combobox",options:{data:[{text:"实线",value:"solid"},{text:"虚线",value:"dotted"}]}}},{name:"内边距(padding)",col:"padding",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+a.id+"', 'padding')\">设置</a></div>",group:"图形边框"},{name:"外边距(margin)",col:"margin",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+a.id+"','margin')\">设置</a></div>",group:"图形边框"}]})},this.setPicProp=function(a,c){$("#reportJLayout").layout("panel","east").panel("setTitle","图片属性面板");if(!a.style){a.style={}}var b=a.style;$("#propertytable").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,onAfterEdit:function(p,f,e){var h=f.value;var d=f.col;if(d=="name"){a.name=h}else{if(d=="width"){a.style.width=h;$("#"+a.id+" div.ctx img").attr("width",a.style.width)}else{if(d=="height"){a.style.height=h;$("#"+a.id+" div.ctx img").attr("height",a.style.height)}else{a.style[d]=h;var g=$("#"+a.id+" .ctx");if(d=="align"){g.css("text-align",h)}}}}},data:[{name:"组件名称",col:"name",value:(a.name?a.name:""),group:"图片属性",editor:"text"},{name:"高度",col:"height",value:(b.height?b.height:""),group:"图片属性",editor:"numberbox"},{name:"宽度",col:"width",value:(b.width?b.width:""),group:"图片属性",editor:"numberbox"},{name:"位置",col:"align",value:(b.align?b.align:"left"),group:"图片属性",editor:{type:"combobox",options:{data:[{value:"left",text:"left"},{value:"center",text:"center"},{value:"right",text:"right"}]}}},{name:"边框颜色",col:"bordercolor",value:(b.bordercolor?b.bordercolor:""),group:"图片边框",editor:{type:"combobox",options:{data:colorJson,formatter:function(d){return'<div style="background-color:'+d.value+'">'+d.text+"</div>"}}}},{name:"边框大小",col:"bordersize",value:(b.bordersize?b.bordersize:""),group:"图片边框",editor:"numberbox"},{name:"边框类型",col:"bordertype",value:(b.bordertype?b.bordertype:""),group:"图片边框",editor:{type:"combobox",options:{data:[{text:"实线",value:"solid"},{text:"虚线",value:"dotted"}]}}},{name:"内边距(padding)",col:"padding",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+a.id+"', 'padding')\">设置</a></div>",group:"图片边框"},{name:"外边距(margin)",col:"margin",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+a.id+"','margin')\">设置</a></div>",group:"图片边框"}]})},this.setTextProp=function(a,e){var c=[];for(var b=0;pageInfo.dataset&&b<pageInfo.dataset.length;b++){c.push({value:pageInfo.dataset[b].datasetid,text:pageInfo.dataset[b].name})}if(!a.style){a.style={}}var d=a.style;$("#reportJLayout").layout("panel","east").panel("setTitle","文本属性面板");$("#propertytable").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,onAfterEdit:function(r,h,g){var q=h.value;var f=h.col;if(q){if(f=="compdata"){a.datasetId=q;return}else{if(f=="name"){a.name=q}}a.style[f]=q;var p=$("#"+a.id+" .ctx");if(f=="fontheight"){p.css("height",q+"px")}else{if(f=="fontsize"){p.css("font-size",q+"px")}else{if(f=="align"){p.css("text-align",q)}else{if(f=="fontcolor"){p.css("color",q)}else{if(f=="fontweight"){if(q=="true"){p.css("font-weight","bold")}else{p.css("font-weight","normal")}}else{if(f=="italic"){if(q=="true"){p.css("font-style","italic")}else{p.css("font-style","normal")}}else{if(f=="underscore"){if(q=="true"){p.css("text-decoration","underline")}else{p.css("text-decoration","inherit")}}else{if(f=="bgcolor"){p.css("background-color",q)}else{if(f=="lineheight"){p.css("line-height",q+"px")}}}}}}}}}}else{delete a.style[f];var p=$("#"+a.id+" .ctx");if(f=="bgcolor"){p.css("background-color","inherit")}else{if(f=="fontheight"){p.css("height","auto")}else{if(f=="lineheight"){p.css("line-height","inherit")}}}}},data:[{name:"数据集",col:"compdata",value:(a.datasetId?a.datasetId:""),group:"数据映射",editor:{type:"combobox",options:{data:c}}},{name:"组件名称",col:"name",value:(a.name?a.name:""),group:"文本属性",editor:"text"},{name:"高度",col:"fontheight",value:(d.fontheight?d.fontheight:""),group:"文本属性",editor:"numberbox"},{name:"位置",col:"align",value:(d.align?d.align:""),group:"文本属性",editor:{type:"combobox",options:{data:[{value:"",text:"无"},{value:"left",text:"left"},{value:"center",text:"center"},{value:"right",text:"right"}]}}},{name:"背景颜色",col:"bgcolor",value:(d.bgcolor?d.bgcolor:""),group:"文本属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(f){return'<div style="background-color:'+f.value+'">'+f.text+"</div>"}}}},{name:"行高(lineHeight)",col:"lineheight",value:(d.lineheight?d.lineheight:""),group:"文本属性",editor:"numberbox"},{name:"样式",col:"cstyle",value:(d.cstyle?d.cstyle:""),group:"文本属性",editor:{type:"combobox",options:{data:curTmpInfo.property.getcustomStyle()}}},{name:"字体大小",col:"fontsize",value:(d.fontsize?d.fontsize:""),group:"文本字体",editor:"numberbox"},{name:"字体颜色",col:"fontcolor",value:(d.fontcolor?d.fontcolor:""),group:"文本字体",editor:{type:"combobox",options:{data:colorJson,formatter:function(f){return'<div style="background-color:'+f.value+'">'+f.text+"</div>"}}}},{name:"是否粗体",col:"fontweight",value:(d.fontweight?d.fontweight:""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否斜体",col:"italic",value:(d.italic?d.italic:""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否下划线",col:"underscore",value:(d.underscore?d.underscore:""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"边框颜色",col:"bordercolor",value:(d.bordercolor?d.bordercolor:""),group:"文本边框",editor:{type:"combobox",options:{data:colorJson,formatter:function(f){return'<div style="background-color:'+f.value+'">'+f.text+"</div>"}}}},{name:"边框大小",col:"bordersize",value:(d.bordersize?d.bordersize:""),group:"文本边框",editor:"numberbox"},{name:"边框类型",col:"bordertype",value:(d.bordertype?d.bordertype:""),group:"文本边框",editor:{type:"combobox",options:{data:[{text:"实线",value:"solid"},{text:"虚线",value:"dotted"}]}}},{name:"内边距(padding)",col:"padding",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+a.id+"', 'padding')\">设置</a></div>",group:"文本边框"},{name:"外边距(margin)",col:"margin",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+a.id+"','margin')\">设置</a></div>",group:"文本边框"}]})},this.setLabelProp=function(a,c){if(!a.style){a.style={}}var b=a.style;$("#reportJLayout").layout("panel","east").panel("setTitle","标签属性面板");$("#propertytable").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,onAfterEdit:function(p,f,e){var h=f.value;var d=f.col;if(h){a.style[d]=h;var g=$("#"+a.id+" .ctx");if(d=="name"){a.name=h}else{if(d=="fontheight"){g.css("height",h+"px")}else{if(d=="fontsize"){g.css("font-size",h+"px")}else{if(d=="align"){g.css("text-align",h)}else{if(d=="fontcolor"){g.css("color",h)}else{if(d=="fontweight"){if(h=="true"){g.css("font-weight","bold")}else{g.css("font-weight","normal")}}else{if(d=="italic"){if(h=="true"){g.css("font-style","italic")}else{g.css("font-style","normal")}}else{if(d=="underscore"){if(h=="true"){g.css("text-decoration","underline")}else{g.css("text-decoration","inherit")}}else{if(d=="bgcolor"){g.css("background-color",h)}}}}}}}}}}else{delete a.style[d];var g=$("#"+a.id+" .ctx");if(d=="bgcolor"){g.css("background-color","inherit")}else{if(d=="fontheight"){g.css("height","auto")}}}},data:[{name:"组件名称",col:"name",value:(a.name?a.name:""),group:"标签属性",editor:"text"},{name:"高度",col:"fontheight",value:(b.fontheight?b.fontheight:""),group:"标签属性",editor:"numberbox"},{name:"位置",col:"align",value:(b.align?b.align:""),group:"标签属性",editor:{type:"combobox",options:{data:[{value:"",text:"无"},{value:"left",text:"left"},{value:"center",text:"center"},{value:"right",text:"right"}]}}},{name:"背景颜色",col:"bgcolor",value:(b.bgcolor?b.bgcolor:""),group:"标签属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(d){return'<div style="background-color:'+d.value+'">'+d.text+"</div>"}}}},{name:"样式",col:"cstyle",value:(b.cstyle?b.cstyle:""),group:"标签属性",editor:{type:"combobox",options:{data:curTmpInfo.property.getcustomStyle()}}},{name:"字体大小",col:"fontsize",value:(b.fontsize?b.fontsize:""),group:"标签字体",editor:"numberbox"},{name:"字体颜色",col:"fontcolor",value:(b.fontcolor?b.fontcolor:""),group:"标签字体",editor:{type:"combobox",options:{data:colorJson,formatter:function(d){return'<div style="background-color:'+d.value+'">'+d.text+"</div>"}}}},{name:"是否粗体",col:"fontweight",value:(b.fontweight?b.fontweight:""),group:"标签字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否斜体",col:"italic",value:(b.italic?b.italic:""),group:"标签字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否下划线",col:"underscore",value:(b.underscore?b.underscore:""),group:"标签字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"边框颜色",col:"bordercolor",value:(b.bordercolor?b.bordercolor:""),group:"标签边框",editor:{type:"combobox",options:{data:colorJson,formatter:function(d){return'<div style="background-color:'+d.value+'">'+d.text+"</div>"}}}},{name:"边框大小",col:"bordersize",value:(b.bordersize?b.bordersize:""),group:"标签边框",editor:"numberbox"},{name:"边框类型",col:"bordertype",value:(b.bordertype?b.bordertype:""),group:"标签边框",editor:{type:"combobox",options:{data:[{text:"实线",value:"solid"},{text:"虚线",value:"dotted"}]}}},{name:"内边距(padding)",col:"padding",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+a.id+"', 'padding')\">设置</a></div>",group:"标签边框"},{name:"外边距(margin)",col:"margin",value:"<div align='center'><a href='javascript:;' onclick=\"curTmpInfo.property.setDistance('"+a.id+"','margin')\">设置</a></div>",group:"标签边框"}]})},this.setLabelStyle=function(b){var c="";var a=b.style;if(a){if(a.fontheight){c=c+"height:"+a.fontheight+"px;"}if(a.fontsize){c=c+"font-size:"+a.fontsize+"px;"}if(a.align){c=c+"text-align:"+a.align+";"}if(a.fontcolor){c=c+"color:"+a.fontcolor+";"}if(a.fontweight){c=c+"font-weight:bold;"}if(a.italic){c=c+"font-style:italic;"}if(a.underscore){c=c+"text-decoration: underline;"}if(a.bgcolor){c=c+"background-color:"+a.bgcolor+";"}if(a.lineheight){c=c+"line-height:"+a.lineheight+"px;"}}return c},this.setLayoutProp=function(b){if(!pageInfo.style){pageInfo.style={}}var a=pageInfo.style;$("#reportJLayout").layout("panel","east").panel("setTitle","页面属性面板");$("#propertytable").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,onAfterEdit:function(g,e,d){var f=e.value;var c=e.col;if(f){pageInfo.style[c]=f;if(c=="type"){if(f=="PC"){$("#layout_table").css("width","100%")}else{if(f=="PHONE"){$("#layout_table").css("width","400px")}else{if(f=="PAD"){$("#layout_table").css("width","800px")}}}}}else{delete pageInfo.style[c]}},data:[{name:"页面类型",col:"type",value:(a.type?a.type:""),group:"页面属性",editor:{type:"combobox",options:{data:[{text:"PC",value:"PC"},{text:"手机",value:"PHONE"},{text:"平板",value:"PAD"}]}}},{name:"宽度",col:"width",value:(a.width?a.width:""),group:"页面属性",editor:"numberbox"},{name:"高度",col:"height",value:(a.height?a.height:""),group:"页面属性",editor:"numberbox"},{name:"边框颜色",col:"bordercolor",value:(a.bordercolor?a.bordercolor:""),group:"布局器",editor:{type:"combobox",options:{data:colorJson,formatter:function(c){return'<div style="background-color:'+c.value+'">'+c.text+"</div>"}}}},{name:"边框大小",col:"bordersize",value:(a.bordersize?a.bordersize:""),group:"布局器",editor:"numberbox"},{name:"边框类型",col:"bordertype",value:(a.bordertype?a.bordertype:""),group:"布局器",editor:{type:"combobox",options:{data:[{text:"实线",value:"solid"},{text:"虚线",value:"dotted"}]}}},{name:"内边距(padding)",col:"padding",value:(a.padding?a.padding:""),group:"布局器",editor:"numberbox"},{name:"外边距(margin)",col:"margin",value:(a.margin?a.margin:""),group:"布局器",editor:"numberbox"},{name:"背景颜色",col:"bgcolor",value:(a.bgcolor?a.bgcolor:""),group:"布局器",editor:{type:"combobox",options:{data:colorJson,formatter:function(c){return'<div style="background-color:'+c.value+'">'+c.text+"</div>"}}}}]})},this.ftmstr=function(e,b,a,d){var c='<select id="'+e+'" name="'+e+'" class="'+b+'" '+(d?'onchange="setChartProp2(this)"':"")+">";c=c+'<option value=""></option><option '+(a=="#,###"?"selected":"")+' value="#,###">整数</option><option '+(a=="#,###.0"?"selected":"")+' value="#,###.0">小数(保留1位)</option><option '+(a=="#,###.00"?"selected":"")+' value="#,###.00">小数(保留2位)</option><option '+(a=="0.00%"?"selected":"")+' value="0.00%">百分比</option>';c=c+"</select>";return c},this.setDistance=function(c,f){var b=findCompById(c);if(!b.style){b.style={}}var e=f=="margin"?b.style.margin:b.style.padding;var d;if(e){d=e.split(",")}var a='<div class="textpanel"><span class="inputtext">全部相同：</span><input type="checkbox" id="setall" value="y"><br/><span class="inputtext">Top：</span><input type="text" value="'+(d&&d.length>0?d[0]:"")+'" style="100px;" name="top" id="top">px<br/><span class="inputtext">Right：</span><input type="text" value="'+(d&&d.length>1?d[1]:"")+'" style="100px;" name="right" id="right">px</br><span class="inputtext">Bottom：</span><input type="text" value="'+(d&&d.length>2?d[2]:"")+'" style="100px;" name="bottom" id="bottom">px<br/><span class="inputtext">Left：</span><input type="text" style="100px;"name="left" id="left" value="'+(d&&d.length>3?d[3]:"")+'">px<br/><a id="clearset" href="javascript:;">清除设置</a></div>';$("#pdailog").dialog({title:"设置"+(f=="margin"?"外边距(margin)":"内边距(padding)"),width:330,height:270,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},buttons:[{text:"确定",handler:function(){var p=$("#pdailog #top").val();var h=$("#pdailog #right").val();var g=$("#pdailog #bottom").val();var o=$("#pdailog #left").val();if(p==""&&h==""&&g==""&&o==""){$("#pdailog").dialog("close");return}if(f=="margin"){b.style.margin=p+","+h+","+g+","+o}else{b.style.padding=p+","+h+","+g+","+o}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #top,#pdailog #left,#pdailog #right,#pdailog #bottom").numberbox({min:0,max:500});$("#pdailog #setall").change(function(){if(this.checked){var g=Number($("#pdailog #top").val());$("#pdailog #left").val(g);$("#pdailog #bottom").val(g);$("#pdailog #right").val(g)}});$("#pdailog #clearset").click(function(){$("#pdailog #top").val("");$("#pdailog #right").val("");$("#pdailog #bottom").val("");$("#pdailog #left").val("");if(f=="margin"){delete b.style.margin}else{delete b.style.padding}})},this.colorSelect=function(c,b){var a="";for(i=0;i<colorJson.length;i++){a=a+"<span class='colorbtn' color='"+colorJson[i].value+"' style='background-color:"+colorJson[i].value+"'></span>"}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:"颜色选择器",width:300,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")}});$("#dsColumn_div span.colorbtn").mousemove(function(){}).mouseout(function(){}).click(function(){var d=$(this).attr("color");$(c).val(d);$(b).css("background-color",d);$("#dsColumn_div").dialog("close")})},this.cssfileExist=function(b){var a=false;for(i=0;pageInfo.cssfiles&&i<pageInfo.cssfiles.length;i++){var c=pageInfo.cssfiles[i];if(c.name=b){a=true;break}}return a},this.importcss=function(){var a='<div style="border-bottom:solid 1px #CCCCCC;border-top:solid 1px #CCCCCC;"><table id="csslist" title="" style="width:410px;height:220px;"><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'name\',width:220">页面名称</th><th data-options="field:\'dt\',width:130">修改时间</th></tr></thead></table></div>';$("#pdailog").dialog({title:"导入CSS样式文件",width:426,height:290,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"确定",handler:function(){var c=$("#pdailog #csslist").datagrid("getSelected");if(c==null){msginfo("请选择样式文件!");return}if(!pageInfo.cssfiles){pageInfo.cssfiles=[]}if(curTmpInfo.property.cssfileExist(c.name)){msginfo("引用的样式文件已经存在。");return}var d={id:newGuid(),name:c.name};pageInfo.cssfiles.push(d);var b=$("#mystyletree").tree("getRoot");$("#mystyletree").tree("append",{parent:b.target,data:{id:d.id,text:d.name}});curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #csslist").datagrid({singleSelect:true,collapsible:false,border:false,url:"Css!listcss.action",method:"post",queryParams:{t:Math.random()}})},this.exportcss=function(){var b=$("#mystyletree").tree("getSelected");if(b.iconCls=="icon-ustyle"){return}if(!pageInfo.userstyle||pageInfo.userstyle.length==0){msginfo("无能够导出的样式。");return}var a='<div style="border-bottom:solid 1px #CCCCCC;border-top:solid 1px #CCCCCC;"><table id="csslist" title="" style="width:410px;height:220px;"><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'name\',width:220">页面名称</th><th data-options="field:\'dt\',width:130">修改时间</th></tr></thead></table></div><div style="margin:5px;"><span class="inputtext">样式文件名称：</span><input type="text" name="cssfilename" id="cssfilename" style="width:120px;" >.css</div>';$("#pdailog").dialog({title:"导出为样式文件",width:430,height:320,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"确定",handler:function(){var c=$("#pdailog #cssfilename").val();if(c==""){msginfo("请填写样式文件名称！");return}$.ajax({type:"POST",url:"Css!savecss.action",dataType:"json",data:{fileName:c,style:JSON.stringify(pageInfo.userstyle)},success:function(d){msginfo("导出样式成功！","suc");curTmpInfo.isupdate=true;$("#pdailog").dialog("close")},error:function(){msginfo("导出样式失败。")}})}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #csslist").datagrid({singleSelect:true,collapsible:false,border:false,url:"Css!listcss.action",method:"post",queryParams:{t:Math.random()},onSelect:function(c,f){var d=f.name.split(".");var e="";for(i=0;i<d.length-1;i++){e=e+d[i];if(i!=d.length-2){e=e+"."}}$("#pdailog #cssfilename").val(e)}})},this.crtStyleTree=function(){var b=[{text:"报表样式",id:"styles",iconCls:"icon-styles",attributes:{},children:[]}];for(i=0;pageInfo.userstyle&&i<pageInfo.userstyle.length;i++){var a=pageInfo.userstyle[i];b[0].children.push({id:a.id,text:a.styletype=="reportele"?a.styleobj:"."+a.stylename,iconCls:"icon-ustyle"})}for(i=0;pageInfo.cssfiles&&i<pageInfo.cssfiles.length;i++){var a=pageInfo.cssfiles[i];b[0].children.push({id:a.id,text:a.name})}$("#mystyletree").tree({data:b,onContextMenu:function(d,c){d.preventDefault();$("#mystyletree").tree("select",c.target);if(c.iconCls=="icon-ustyle"){$("#mystyletree").menu("disableItem",$("#crtstyles"));$("#mystyletree").menu("enableItem",$("#modstyles"));$("#mystyletree").menu("enableItem",$("#delstyles"));$("#mystyletree").menu("disableItem",$("#expstyles"))}else{if(c.iconCls=="icon-styles"){$("#mystyletree").menu("enableItem",$("#crtstyles"));$("#mystyletree").menu("disableItem",$("#modstyles"));$("#mystyletree").menu("disableItem",$("#delstyles"));$("#mystyletree").menu("enableItem",$("#expstyles"))}else{$("#mystyletree").menu("disableItem",$("#crtstyles"));$("#mystyletree").menu("disableItem",$("#modstyles"));$("#mystyletree").menu("enableItem",$("#delstyles"));$("#mystyletree").menu("disableItem",$("#expstyles"))}}$("#stylesmenu").menu("show",{left:d.pageX,top:d.pageY})}})},this.selectpicdailog=function(a){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:"图片选择",width:500,height:300,closed:false,cache:false,modal:true,toolbar:null,href:"Chart!listPics.action",onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},onLoad:function(){$("span.selpics a").click(function(){var b=$(this).attr("path");$(a).val(b);$("#dsColumn_div").dialog("close")})}})},this.getcustomStyle=function(){var a=[];for(k=0;pageInfo.userstyle&&k<pageInfo.userstyle.length;k++){if(pageInfo.userstyle[k].styletype=="custom"){var b=pageInfo.userstyle[k];a.push({text:b.stylename,value:b.stylename})}}return a},this.findStyleById=function(b){var a=null;for(k=0;pageInfo.userstyle&&k<pageInfo.userstyle.length;k++){if(pageInfo.userstyle[k].id==b){a=pageInfo.userstyle[k];break}}return a},this.delStyle=function(){var b=$("#mystyletree").tree("getSelected");if(b.iconCls=="icon-styles"){return}if(confirm("是否确认删除？")){if(b.iconCls=="icon-ustyle"){var a=-1;for(k=0;pageInfo.userstyle&&k<pageInfo.userstyle.length;k++){if(pageInfo.userstyle[k].id==b.id){a=k;break}}pageInfo.userstyle.splice(a,1)}else{var a=-1;for(k=0;pageInfo.cssfiles&&k<pageInfo.cssfiles.length;k++){if(pageInfo.cssfiles[k].id==b.id){a=k;break}}pageInfo.cssfiles.splice(a,1)}$("#mystyletree").tree("remove",b.target)}},this.crtStyle=function(p){var g=$("#mystyletree").tree("getSelected");var x;if(p){var e=g.id;x=this.findStyleById(e)}var o=["body","mainPage","params","layout","layout-td","table","table-head","table-detail","table-foot","table-tr-row1","table-tr-row2"];var y="";for(i=0;i<o.length;i++){y=y+"<option value='"+o[i]+"' "+(x&&x.styleobj==o[i]?"selected":"")+">"+o[i]+"</option>"}var f="<div class=\"textpanel\"><input type='radio' id='styletype' name='styletype' value='reportele' "+(x&&x.styletype=="reportele"?"checked":"")+">报表对象样式 <br/><span class='inputtext'></span>对象列表：<select id='styleobj' name='styleobj' class='inputform'>"+y+"</select><br/><input type='radio' id='styletype' name='styletype' value='custom' "+(x&&x.styletype=="custom"?"checked":"")+">自定义样式 <br/><span class=\"inputtext\"></span>样式名称：<input type='text' id='stylename' name='stylename' class='inputform' value='"+(x?x.stylename:"")+"'></div>";var u=["黑体","宋体","仿宋","楷体","微软雅黑","隶书","幼圆"];var b="<option value=''></option>";for(i=0;i<u.length;i++){b=b+"<option value='"+u[i]+"' "+(x&&x.family==u[i]?"selected":"")+">"+u[i]+"</option>"}var z=["100","200","300","600","900","Bold","Bolder","Normal"];var a="<option value=''></option>";for(i=0;i<z.length;i++){a=a+'<option value="'+z[i]+'" '+(x&&x.weight==z[i]?"selected":"")+">"+z[i]+"</option>"}var v='<div class="textpanel"><span class="inputtext">字体：</span><select id="family" name="family" class="inputform">'+b+'</select><br/><span class="inputtext">颜色：</span><input type=\'text\' id="color" name="color" class="inputform2" value=\''+(x?x.color:"")+"'><span class='colorselbtn' style='"+(x?"background-color:"+x.color:"")+"' onclick=\"curTmpInfo.property.colorSelect('#pdailog #color', this)\"></span><br/><span class=\"inputtext\">大小：</span><input type='text' id='size' name='size' class='inputform2' value='"+(x?x.size:"")+"'>px<br/><span class=\"inputtext\">weight：</span><select id='weight' name='weight' class='inputform'>"+a+"</select><br/><span class=\"inputtext\">style：</span><select id='style' name='style' class='inputform'><option value=''></option><option value='Normal' "+(x&&x.style=="Normal"?"selected":"")+">Normal</option><option value='Italic' "+(x&&x.style=="Italic"?"selected":"")+">Italic</option></select><br/><span class=\"inputtext\">decoration：</span><input type='radio' id='decoration' name='decoration' value='underline' "+(x&&x.decoration=="underline"?"checked":"")+">underline <input type='radio' id='decoration' name='decoration' value='overline' "+(x&&x.decoration=="overline"?"checked":"")+">overline <input type='radio' id='decoration' name='decoration' value='line-through' "+(x&&x.decoration=="line-through"?"checked":"")+">line-through <input type='radio' id='decoration' name='decoration' value=''>无</div>";var t="<option value=''></option>";var h=["no-repeat","repeat","repeat-x","repeat-y"];for(i=0;i<h.length;i++){t=t+'<option value="'+h[i]+'" '+(x&&x.repeat==h[i]?"selected":"")+">"+h[i]+"</option>"}var s="<div class=\"textpanel\"><span class=\"inputtext\">背景颜色：</span><input id='bgcolor' name='bgcolor' class='inputform2' value='"+(x?x.bgcolor:"")+"'><span class='colorselbtn' style='"+(x?"background-color:"+x.bgcolor:"")+"' onclick=\"curTmpInfo.property.colorSelect('#pdailog #bgcolor', this)\"></span><br/><span class=\"inputtext\">背景图片：</span><input type=\"text\" id='bgimg' name='bgimg' class='inputform2' value='"+(x?x.bgimg:"")+"'><input type='button' value='选择' onclick=\"curTmpInfo.property.selectpicdailog('#pdailog #bgimg')\"><br/><span class=\"inputtext\">Repeat：</span><select id='repeat' name='repeat' class='inputform'>"+t+"</select><br/><span class=\"inputtext\">attachment：</span><select id=\"attachment\" name='attachment' class='inputform'><option value=''></option><option value='fixed' "+(x&&x.attachment=="fixed"?"selected":"")+">fixed</option><option value='scroll' "+(x&&x.attachment=="scroll"?"selected":"")+">scroll</option></select><br/><span class=\"inputtext\">position-x：</span><select id=\"positionx\" name='positionx' class='inputform'><option value=''></option><option value='left' "+(x&&x.positionx=="left"?"selected":"")+">left</option><option value='center' "+(x&&x.positionx=="center"?"selected":"")+">center</option><option value='right' "+(x&&x.positionx=="right"?"selected":"")+">right</option></select><br/><span class=\"inputtext\">position-y：</span><select id=\"positiony\" name='positiony' class='inputform'><option value=''></option><option value='top' "+(x&&x.positiony=="top"?"selected":"")+">top</option><option value='center' "+(x&&x.positiony=="center"?"selected":"")+">center</option><option value='bottom' "+(x&&x.positiony=="bottom"?"selected":"")+">bottom</option></select><br/></div>";var q="<div class=\"textpanel\"><span class=\"inputtext\">line-height：</span><input type='text' id='lineheight' name='lineheight' class='inputform2' value='"+(x?x.lineheight:"")+"'>px<br/><span class=\"inputtext\">letter-spacing：</span><input type='text' id='letterspacing' name='letterspacing' class='inputform2' value='"+(x?x.letterspacing:"")+"'>px<br/><span class=\"inputtext\">word-spacing：</span><input type='text' id='wordspacing' name='wordspacing' class='inputform2' value='"+(x?x.wordspacing:"")+"'>px<br/><span class=\"inputtext\">vertical-align：</span><select id='verticalalign' name='verticalalign' class='inputform'><option value=''></option><option value='top' "+(x&&x.verticalalign=="top"?"selected":"")+">top</option><option value='middle' "+(x&&x.verticalalign=="middle"?"selected":"")+">middle</option><option value='bottom' "+(x&&x.verticalalign=="bottom"?"selected":"")+">bottom</option></select><br/><span class=\"inputtext\">text-align：</span><select id='textalign' name='textalign' class='inputform'><option value=''></option><option value='left' "+(x&&x.textalign=="left"?"selected":"")+">left</option><option value='center' "+(x&&x.textalign=="center"?"selected":"")+">center</option><option value='right' "+(x&&x.textalign=="right"?"selected":"")+">right</option></select><br/><span class=\"inputtext\">text-indent：</span><input type='text' id='textindent' name='textindent' class='inputform2' value='"+(x?x.textindent:"")+"'>px<br/><span class=\"inputtext\">display：</span><input type='text' id='display' name='display' class='inputform' value='"+(x?x.display:"")+"'><br/></div>";var r="<div class=\"textpanel\"><span class=\"inputtext\">宽度：</span><input type='text' id='width' name='width' class='inputform' value='"+(x?x.width:"")+"'>px<br/><span class=\"inputtext\">高度：</span><input type='text' id='height' name='height' class='inputform' value='"+(x?x.height:"")+'\'>px<br/><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td><fieldset><legend>内边距(padding)</legend><span class="inputtext">Top：</span><input type=\'text\' id=\'paddingtop\' name=\'paddingtop\' class=\'inputform3\' value="'+(x?x.paddingtop:"")+"\">px/auto<br/><span class=\"inputtext\">Right：</span><input type='text' id='paddingright' name='paddingright' class='inputform3' value='"+(x?x.paddingright:"")+"'>px/auto<br/><span class=\"inputtext\">Bottom：</span><input type='text' id='paddingbottom' name='paddingbottom' class='inputform3' value='"+(x?x.paddingbottom:"")+"'>px/auto<br/><span class=\"inputtext\">Left：</span><input type='text' id='paddingleft' name='paddingleft' class='inputform3' value='"+(x?x.paddingleft:"")+"'>px/auto<br/></fieldset></td><td><fieldset><legend>外边距(margin)</legend><span class=\"inputtext\">Top：</span><input type='text' id='margintop' name='margintop' class='inputform3' value='"+(x?x.margintop:"")+"'>px/auto<br/><span class=\"inputtext\">Right：</span><input type='text' id='marginright' name='marginright' class='inputform3' value='"+(x?x.marginright:"")+"'>px/auto<br/><span class=\"inputtext\">Bottom：</span><input type='text' id='marginbottom' name='marginbottom' class='inputform3' value='"+(x?x.marginbottom:"")+"'>px/auto<br/><span class=\"inputtext\">Left：</span><input type='text' id='marginleft' name='marginleft' class='inputform3' value='"+(x?x.marginleft:"")+"'>px/auto<br/></fieldset></td></tr></table></div>";var c=function(B){var C="<option value=''></option>";var A=["dotted","dashed","solid","double","groove","ridge","inset","outset"];for(i=0;i<A.length;i++){C=C+"<option value='"+A[i]+"' "+(B==A[i]?"selected":"")+">"+A[i]+"</option>"}return C};var d='<div class=\'textpanel\'><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td><fieldset><legend>Style</legend><span class="inputtext">Top：</span><select id=\'bordertop\' name=\'bordertop\' class=\'inputform2\'>'+c(x?x.bordertop:"")+"</select><br/><span class=\"inputtext\">Right：</span><select id='borderright' name='borderright' class='inputform2'>"+c(x?x.borderright:"")+"</select><br/><span class=\"inputtext\">Bottom：</span><select id='borderbottom' name='borderbottom' class='inputform2'>"+c(x?x.borderbottom:"")+"</select><br/><span class=\"inputtext\">Left：</span><select id='borderleft' name='borderleft' class='inputform2'>"+c(x?x.borderleft:"")+"</select><br/></fieldset></td><td> <fieldset><legend>Width</legend><span class=\"inputtext\">Top：</span><input type='text' id='widthtop' name='widthtop' class='inputform2' value='"+(x?x.widthtop:"")+"'>px<br/><span class=\"inputtext\">Right：</span><input type='text' id='widthright' name='widthright' class='inputform2' value='"+(x?x.widthright:"")+"'>px<br/><span class=\"inputtext\">Bottom：</span><input type='text' id='widthbottom' name='widthbottom' class='inputform2' value='"+(x?x.widthbottom:"")+"'>px<br/><span class=\"inputtext\">Left：</span><input type='text' id='widthleft' name='widthleft' class='inputform2' value='"+(x?x.widthleft:"")+"'>px</fieldset> </td></tr><tr><td><fieldset><legend>Color</legend><span class=\"inputtext\">Top：</span><input type='text' id='colortop' name='colortop' class='inputform3' value='"+(x?x.colortop:"")+"'><span class='colorselbtn' onclick=\"curTmpInfo.property.colorSelect('#pdailog #colortop', this)\" style='"+(x?"background-color:"+x.colortop:"")+"'></span><br/><span class=\"inputtext\">Right：</span><input type='text' id='colorright' name='colorright' class='inputform3' value='"+(x?x.colorright:"")+"'><span class='colorselbtn' onclick=\"curTmpInfo.property.colorSelect('#pdailog #colorright', this)\" style='"+(x?"background-color:"+x.colorright:"")+"'></span><br/><span class=\"inputtext\">Bottom：</span><input type='text' id='colorbottom' name='colorbottom' class='inputform3' value='"+(x?x.colorbottom:"")+"'><span class='colorselbtn' onclick=\"curTmpInfo.property.colorSelect('#pdailog #colorbottom', this)\" style='"+(x?"background-color:"+x.colorbottom:"")+"'></span><br/><span class=\"inputtext\">Left：</span><input type='text' id='colorleft' name='colorleft' class='inputform3' value='"+(x?x.colorleft:"")+"'><span class='colorselbtn' onclick=\"curTmpInfo.property.colorSelect('#pdailog #colorleft', this)\" style='"+(x?"background-color:"+x.colorleft:"")+"'></span><br/></fieldset></td><td></td></tr></table></div>";var w='<div id="stylestabs" ><div title="基本信息" >'+f+'</div><div title="字体">'+v+'</div><div title="背景">'+s+'</div><div title="区块">'+q+'</div><div title="方框">'+r+'</div><div title="边框">'+d+"</div></div>";$("#pdailog").dialog({title:p?"编辑样式":"新建样式",width:760,height:420,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:w,buttons:[{text:"确定",handler:function(){var Z=$('#pdailog input[name="styletype"]:checked').val();if(!Z||Z==null){$("#stylestabs").tabs("select",0);msginfo("请选择样式类型。");return}var ak=$("#pdailog #styleobj").val();var ao=$("#pdailog #stylename").val();var I=$("#pdailog #family").val();var af=$("#pdailog #color").val();var J=$("#pdailog #size").val();var ap=$("#pdailog #weight").val();var ar=$("#pdailog #style").val();var K=$('#pdailog input[name="decoration"]:checked').val();var av=$("#pdailog #bgcolor").val();var ai=$("#pdailog #bgimg").val();var ag=$("#pdailog #repeat").val();var Y=$("#pdailog #attachment").val();var N=$("#pdailog #positionx").val();var M=$("#pdailog #positiony").val();var E=$("#pdailog #lineheight").val();var au=$("#pdailog #letterspacing").val();var aa=$("#pdailog #wordspacing").val();var S=$("#pdailog #verticalalign").val();var W=$("#pdailog #textalign").val();var F=$("#pdailog #textindent").val();var ad=$("#pdailog #display").val();var A=$("#pdailog #width").val();var B=$("#pdailog #height").val();var L=$("#pdailog #paddingtop").val();var ae=$("#pdailog #paddingright").val();var aq=$("#pdailog #paddingbottom").val();var ab=$("#pdailog #paddingleft").val();var D=$("#pdailog #margintop").val();var P=$("#pdailog #marginright").val();var H=$("#pdailog #marginbottom").val();var V=$("#pdailog #marginleft").val();var aj=$("#pdailog #bordertop").val();var G=$("#pdailog #borderright").val();var an=$("#pdailog #borderbottom").val();var at=$("#pdailog #borderleft").val();var R=$("#pdailog #widthtop").val();var C=$("#pdailog #widthright").val();var am=$("#pdailog #widthbottom").val();var al=$("#pdailog #widthleft").val();var U=$("#pdailog #colortop").val();var O=$("#pdailog #colorright").val();var Q=$("#pdailog #colorbottom").val();var T=$("#pdailog #colorleft").val();var ar={id:newGuid(),styletype:Z,styleobj:ak,stylename:ao,family:I,color:af,size:J,weight:ap,style:ar,decoration:K,bgcolor:av,bgimg:ai,repeat:ag,attachment:Y,positionx:N,positiony:M,lineheight:E,letterspacing:au,wordspacing:aa,verticalalign:S,textalign:W,textindent:F,display:ad,width:A,height:B,paddingtop:L,paddingright:ae,paddingbottom:aq,paddingleft:ab,margintop:D,marginright:P,marginbottom:H,marginleft:V,bordertop:aj,borderright:G,borderbottom:an,borderleft:at,widthtop:R,widthright:C,widthbottom:am,widthleft:al,colortop:U,colorright:O,colorbottom:Q,colorleft:T};if(!pageInfo.userstyle){pageInfo.userstyle=[]}if(p){var X=$("#mystyletree").tree("getSelected").id;ar.id=X;for(j=0;j<pageInfo.userstyle.length;j++){if(pageInfo.userstyle[j].id==X){pageInfo.userstyle[j]=ar;break}}var ah=$("#mystyletree").tree("getSelected");$("#mystyletree").tree("update",{target:ah.target,text:ar.styletype=="reportele"?ar.styleobj:"."+ar.stylename})}else{pageInfo.userstyle.push(ar);var ac=$("#mystyletree").tree("getRoot");$("#mystyletree").tree("append",{parent:ac.target,data:[{id:ar.id,text:ar.styletype=="reportele"?ar.styleobj:"."+ar.stylename,iconCls:"icon-ustyle"}]})}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#stylestabs").tabs({border:false,fit:true,tabPosition:"left",plain:false})}}if($==undefined){$=jQuery}function crtCrossTable(b){var g="";for(i=0;i<b.kpiJson.length;i++){g=g+'<td width="'+((100/b.kpiJson.length)+"%")+'"><div id="'+b.kpiJson[i].kpi_id+'" class="crskpi"><span title="聚合方式" onclick="crossAggreType(this, \''+b.kpiJson[i].kpi_id+"', '"+b.id+'\')" class="grouptype"></span><span class="txt">'+b.kpiJson[i].kpi_name+"</span></div></td>"}var e="";for(i=0;i<b.tableJson.rows.length;i++){e=e+'<td width="'+((100/b.tableJson.rows.length)+"%")+'"><div id="'+b.tableJson.rows[i].id+'" class="crskpi"><span class="crossdim"></span><span class="txt">'+b.tableJson.rows[i].dimdesc+"</span></div></td>"}var a="";for(i=0;i<b.tableJson.cols.length;i++){a=a+'<tr><td><div id="'+b.tableJson.cols[i].id+'" class="crskpi"><span class="crossdim"></span><span class="txt">'+b.tableJson.cols[i].dimdesc+"</span></div></td></tr>"}var d="";for(i=0;b.head&&i<b.head.length;i++){d=d+'<td width="'+((100/b.head.length)+"%")+'"><div id="'+b.head[i].id+'" class="crskpi">'+b.head[i].desc+"</div></td>"}var f="";if(b.kpiHead&&b.kpiHead.length>0){f='<table width="100%" border="0" cellspacing="0" cellpadding="0" class="crosstab2"><tr>';for(i=0;b.kpiHead&&i<b.kpiHead.length;i++){f=f+'<td width="'+((100/b.kpiHead.length)+"%")+'"><div id="'+b.kpiHead[i].id+'" class="crskpi">'+b.kpiHead[i].desc+"</div></td>"}f=f+"</tr></table>"}var c='<table class=\'d_table\'><tr><td class=\'crosstb\' valign="bottom"><div id="d_rowHead"><table width="100%" border="0" cellspacing="0" cellpadding="0" class="crosstab2"><tr>'+(d==""?"<td> &nbsp; </td>":d)+"</tr></table></div></td><td class='crosstb'><div id=\"d_colDims\" "+(a==""?"class='tabhelpr'":"")+'><table width="100%" border="0" cellspacing="0" cellpadding="0" class="crosstab2">'+(a!=""?a:"<tr><td>将立方体维度拖到此处作为列标签</td></tr>")+'</table></div><div id="d_kpiHead">'+f+"</div></td></tr><tr><td class='crosstb' ><div id=\"d_rowDims\" "+(e==""?"class='tabhelpr'":"")+'><table width="100%" border="0" cellspacing="0" cellpadding="0" class="crosstab2"><tr>'+(e!=""?e:"<td>将立方体维度拖到此处作为行标签</td>")+"</tr></table></div></td> <td class='crosstb'> <div id=\"d_kpi\" "+(g==""?"class='tabhelpr'":"")+'><table class="crosstab2" width="100%" border="0" cellspacing="0" cellpadding="0"><tr>'+(g!=""?g:"<td>将立方体度量拖到此处查询数据</td>")+"</tr></table></div> </td></tr></table>";return c}function insertCrossReport(a){var b={id:newGuid(),type:"cross",name:"交叉报表",kpiJson:[],tableJson:{cols:[],rows:[]}};var c=addComp(b,a,true);$("#layout_"+a).append(c);regCompEvent(b);initCompDropEvent(b.id);regCrossDropEvent(b)}function regCrossCellSelect(a){var b=function(){$("#layout_table .comp_table").each(function(){var c=$(this).attr("type");$(this).css("border",(c=="table"||c=="cross"?"0":"1")+"px solid #cccccc")});$("#"+a).css("border","1px solid #999999")};$("#"+a+" table.crosstab2 td").unbind("click").unbind("contextmenu").bind("click",function(){$("#"+a+" table.crosstab2 td").removeClass("tdselect");if($(this).find("div").size()==0){return false}$(this).addClass("tdselect");setProp($("#"+a).parent().attr("id").split("_")[1],a);b();return false}).bind("contextmenu",function(q){$("#"+a+" table.crosstab2 td").removeClass("tdselect");if($(this).find("div").size()==0){return false}var c=$(this).addClass("tdselect");setProp($("#"+a).parent().attr("id").split("_")[1],a);b();curTmpInfo.compId=a;var s="";if(c.parents("#d_rowDims").size()>0){s="row"}else{if(c.parents("#d_colDims").size()>0){s="col"}else{if(c.parents("#d_rowHead").size()>0){s="head"}else{if(c.parents("#d_kpiHead").size()>0){s="kpiHead"}else{s="kpi"}}}}curTmpInfo.layoutId=$("#"+a).parent().attr("id").split("_")[1];var r=c.find("div").attr("id");curTmpInfo.tp=s;curTmpInfo.colId=r;var p=findCompById(a);var h=false;var t=null;if(s=="row"){t=p.tableJson.rows}else{if(s=="col"){t=p.tableJson.cols}}if(t==null){var d=$("#crossmenu").menu("getItem",$("#m_aggre"));$("#crossmenu").menu("disableItem",d.target)}else{var d=$("#crossmenu").menu("getItem",$("#m_aggre"));$("#crossmenu").menu("enableItem",d.target);for(var g=0;g<t.length;g++){if(t[g].id==r){if(t[g].issum=="y"){h=true;break}}}if(h){var d=$("#crossmenu").menu("getItem",$("#m_aggre"));$("#crossmenu").menu("setIcon",{target:d.target,iconCls:"icon-ok"})}else{var d=$("#crossmenu").menu("getItem",$("#m_aggre"));$("#crossmenu").menu("setIcon",{target:d.target,iconCls:"icon-blank"})}}if(s=="col"){$("#crossmenu").menu("setText",{target:$("#crossmenu #m_left"),text:"上移"});$("#crossmenu").menu("setText",{target:$("#crossmenu #m_right"),text:"下移"})}else{$("#crossmenu").menu("setText",{target:$("#crossmenu #m_left"),text:"左移"});$("#crossmenu").menu("setText",{target:$("#crossmenu #m_right"),text:"右移"})}var f=$(this).offset();$("#crossmenu").menu("show",{left:q.pageX,top:q.pageY});return false})}function resetTableWidth(b){var a=$("#"+b+" table td").size();$("#"+b+" table td").attr("width",(100/Number(a))+"%")}function regCrossDropEvent(a){var b=false;$("#"+a.id+" #d_colDims, #"+a.id+" #d_rowDims, #"+a.id+" #d_kpi").droppable({accept:"#mydatatree .tree-node",onDragEnter:function(f,d){f.preventDefault();f.stopPropagation();var c=$("#datasettree").tree("getNode",d);var g=c.attributes.type;if(g=="dim"&&($(this).attr("id")=="d_colDims"||$(this).attr("id")=="d_rowDims")){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");b=true}else{b=false}if(g=="kpi"&&$(this).attr("id")=="d_kpi"){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");b=false}},onDragLeave:function(d,c){d.preventDefault();d.stopPropagation();if($(this).attr("id")=="d_kpi"&&b==true){}else{$(c).draggable("proxy").find("span").addClass("tree-dnd-no");$(c).draggable("proxy").find("span").removeClass("tree-dnd-yes")}},onDrop:function(o,h){o.preventDefault();o.stopPropagation();var g=$("#datasettree").tree("getNode",h);var p=g.attributes.type;var d=a;if(g.attributes.income=="dataset"){msginfo("数据集字段不能拖入交叉表中。");return}if(!d.cubeId){d.cubeId=g.attributes.cubeId;var c=fundCubeById(d.cubeId);d.tname=c.tname;d.from=c.from}else{if(d.cubeId!=g.attributes.cubeId){msginfo("组件只能映射一个立方体。");return}}if(p=="kpi"&&$(this).attr("id")=="d_kpi"){if($(this).hasClass("tabhelpr")){$(this).removeClass("tabhelpr")}if(!isKpiExist(g.id,d.kpiJson)){d.kpiJson.push({kpi_id:g.id,kpi_name:g.attributes.dispName,alias:g.id,colname:(g.attributes.calc==1?g.attributes.expression:g.id),aggre:g.attributes.aggre,fmt:g.attributes.fmt,unit:g.attributes.unit,rate:1,calc:g.attributes.calc});if(d.kpiJson.length==1){$(this).find("table td").html("").append('<div id="'+g.id+'" class="crskpi"><span title="聚合方式" onclick="crossAggreType(this, \''+g.id+"', '"+d.id+'\')" class="grouptype"></span><span class="txt">'+g.attributes.dispName+"</span></div>")}else{$(this).find("table td").last().after('<td><div id="'+g.id+'" class="crskpi"><span title="聚合方式" onclick="crossAggreType(this, \''+g.id+"', '"+d.id+'\')" class="grouptype"></span><span class="txt">'+g.attributes.dispName+"</span></div></td>")}if(!d.kpiHead){d.kpiHead=[]}d.kpiHead.push({id:"k_"+g.id,desc:g.attributes.dispName});if($("#"+d.id+" #d_kpiHead table").size()==0){$("#"+d.id+" #d_kpiHead").append('<table width="100%" border="0" cellspacing="0" cellpadding="0" class="crosstab2"><tr><td><div id="k_'+g.id+'" class="crskpi">'+g.attributes.dispName+"</div></td></tr></table>")}else{$("#"+d.id+" #d_kpiHead table td").last().after('<td><div id="k_'+g.id+'" class="crskpi">'+g.attributes.dispName+"</div></td>")}resetTableWidth("d_kpiHead");resetTableWidth("d_kpi");regCrossCellSelect(d.id)}else{msginfo("指标已经存在。");return}curTmpInfo.isupdate=true}else{if(p=="dim"){if($(this).attr("id")=="d_colDims"){if(!isDimExist(g.id,d.tableJson.cols)&&!isDimExist(g.id,d.tableJson.rows)){if($(this).hasClass("tabhelpr")){$(this).removeClass("tabhelpr")}var f=$("#datasettree").tree("getParent",g.target);d.tableJson.cols.push({id:g.id,dimdesc:g.text,type:(g.attributes.dim_type?g.attributes.dim_type:"frd"),colname:(g.attributes.dimkey&&g.attributes.dimkey!=""?g.attributes.dimkey:g.id),colnamedesc:(g.attributes.dimtxt&&g.attributes.dimtxt!=""?g.attributes.dimtxt:g.id),iscas:(f.attributes&&f.attributes.type=="group"?"y":"n"),tname:g.attributes.tname,dimord:g.attributes.dimord,ordcol:g.attributes.ordcol});if(d.tableJson.cols.length==1){$(this).find("table td").html("").append('<div id="'+g.id+'" class="crskpi"><span class="crossdim"></span><span class="txt">'+g.text+"</span></div>")}else{$(this).find("table tr").last().after('<tr><td><div id="'+g.id+'" class="crskpi"><span class="crossdim"></span><span class="txt">'+g.text+"</span></div></td></tr>")}regCrossCellSelect(d.id)}else{msginfo("维度已经存在。");return}curTmpInfo.isupdate=true}if($(this).attr("id")=="d_rowDims"){if(!isDimExist(g.id,d.tableJson.cols)&&!isDimExist(g.id,d.tableJson.rows)){if($(this).hasClass("tabhelpr")){$(this).removeClass("tabhelpr")}var f=$("#datasettree").tree("getParent",g.target);d.tableJson.rows.push({id:g.id,dimdesc:g.text,type:(g.attributes.dim_type?g.attributes.dim_type:"frd"),colname:(g.attributes.dimkey&&g.attributes.dimkey!=""?g.attributes.dimkey:g.id),colnamedesc:(g.attributes.dimtxt&&g.attributes.dimtxt!=""?g.attributes.dimtxt:g.id),iscas:(f.attributes&&f.attributes.type=="group"?"y":"n"),tname:g.attributes.tname,dimord:g.attributes.dimord,ordcol:g.attributes.ordcol});if(!d.head){d.head=[]}d.head.push({id:"h_"+g.id,desc:g.text});if(d.tableJson.rows.length==1){$(this).find("table td").html("").append('<div id="'+g.id+'" class="crskpi"><span class="crossdim"></span><span class="txt">'+g.text+"</span></div>");$("#"+d.id+" #d_rowHead table td").html("").append('<div id="h_'+g.id+'" class="crskpi">'+g.text+"</div>")}else{$(this).find("table td").last().after('<td><div id="'+g.id+'" class="crskpi"><span class="crossdim"></span><span class="txt">'+g.text+"</span></div></td>");$("#"+d.id+" #d_rowHead table td").last().after('<td><div id="h_'+g.id+'" class="crskpi">'+g.text+"</div></td>")}regCrossCellSelect(d.id);resetTableWidth("d_rowHead");resetTableWidth("d_rowDims")}else{msginfo("维度已经存在。");return}curTmpInfo.isupdate=true}}}}})}function crossxxbt(){var d=curTmpInfo.compId;var c=findCompById(d);var b='<div class="textpanel"> <input type="checkbox" name="xxbt" id="xxbt" value="1" '+(c.lineHead?"checked":"")+'> 是否启用斜线表头 <br/><br/><div align="center" id="headctx"></div><div align="center" style="margin:5px;'+(!c.lineHead?"display:none":"")+'" id="kpiset"><input type="checkbox" name="hidekpi" id="hidekpi" value="1" '+(c.lineHead&&!c.lineHead.showkpi?"checked":"")+">隐藏指标项</div></div>";$("#pdailog").dialog({title:"斜线表头",width:400,height:280,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"确定",handler:function(){$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});var a=function(e){var g=[];var f=[];for(i=0;c.tableJson.cols&&i<c.tableJson.cols.length;i++){g.push(c.tableJson.cols[i].dimdesc)}if(e){g.push("指标")}for(i=0;c.head&&i<c.head.length;i++){f.push(c.head[i].desc)}c.lineHead={width:200,height:50,top:g,bottom:f,showkpi:e};$("#pdailog #headctx").load("CrossHead.action",{border:"true",json:JSON.stringify(c.lineHead)})};if(c.lineHead){a(c.lineHead.showkpi)}$("#pdailog #xxbt").change(function(){if(this.checked){$("#pdailog #kpiset").css("display","block");a(true)}else{delete c.lineHead;$("#pdailog #kpiset").css("display","none");$("#pdailog #headctx").html("")}});$("#pdailog #hidekpi").change(function(){if(!c.lineHead){return}if(this.checked){a(false)}else{a(true)}})}function crosszz(){var d=curTmpInfo.compId;var a=findCompById(d);var c=a.tableJson.cols;var f=a.tableJson.cols=a.tableJson.rows;var e=a.tableJson.rows=c;var b=[];for(i=0;i<e.length;i++){b.push({id:"h_"+e[i].id,desc:e[i].dimdesc})}a.head=b;$("#"+d+" #d_rowDims table tr").remove();var g="<tr>";if(!e||e.length==0){$("#"+d+" #d_rowDims").addClass("tabhelpr");g=g+"<td>将立方体维度拖到此处作为行标签</td>"}else{$("#"+d+" #d_rowDims").removeClass("tabhelpr");for(i=0;i<e.length;i++){g=g+'<td><div class="crskpi" id="'+e[i].id+'"><span class="crossdim"></span><span class="txt">'+e[i].dimdesc+"</span></div></td>"}}g=g+"</tr>";$("#"+d+" #d_rowDims table").html(g);$("#"+d+" #d_colDims table tr").remove();g="";if(!f||f.length==0){$("#"+d+" #d_colDims").addClass("tabhelpr");g=g+"<tr><td>将立方体维度拖到此处作为列标签</td></tr>"}else{$("#"+d+" #d_colDims").removeClass("tabhelpr");for(i=0;i<f.length;i++){g=g+'<tr><td><div class="crskpi" id="'+f[i].id+'"><span class="crossdim"></span><span class="txt">'+f[i].dimdesc+"</span></div></td></tr>"}}$("#"+d+" #d_colDims table").html(g);$("#"+d+" #d_rowHead table tr").remove();g="<tr>";for(i=0;i<a.head.length;i++){g=g+'<td><div class="crskpi" id="'+a.head[i].id+'">'+a.head[i].desc+"</div></td>"}g=g+"</tr>";$("#"+d+" #d_rowHead table").html(g);resetTableWidth("d_rowHead");resetTableWidth("d_rowDims");regCrossCellSelect(d)}function crossdrill(){var g=curTmpInfo.compId;var c=findCompById(g);if(c.tableJson.rows.length!=1){msginfo("表格行标签只有一个维度的时候才能配置表格钻取。");return}var f;if(!c.drillDim){c.drillDim=[]}else{f=c.drillDim[0]}var b=fundCubeById(c.cubeId);var p='<option value="">--不启用--</option>';for(i=0;i<b.dim.length;i++){var e=b.dim[i];if(e.tp=="group"){for(j=0;j<e.children.length;j++){var a=e.children[j];if(isDimExist(a.id,c.tableJson.cols)||isDimExist(a.id,c.tableJson.rows)){continue}p=p+'<option value="'+a.id+'" '+(f&&f.code==a.id?"selected":"")+">"+a.name+"</option>"}}else{if(isDimExist(e.id,c.tableJson.cols)||isDimExist(e.id,c.tableJson.rows)){continue}p=p+'<option value="'+e.id+'" '+(f&&f.code==e.id?"selected":"")+">"+e.name+"</option>"}}var o=c.tableJson.rows[0];var h='<div class="textpanel">当前表格行维度：'+o.dimdesc+'<br/> <span class="inputtext">钻取维度：</span><select id="drillDim" name="drillDim" class="inputform">'+p+"</select></div>";$("#pdailog").dialog({title:"表格钻取配置",width:310,height:200,closed:false,cache:false,modal:true,content:h,buttons:[{text:"确定",handler:function(){var d=$("#pdailog #drillDim").val();if(d==""){delete c.drillDim}else{var q=curTmpInfo.scrossTable.findCubeDim(b,d);c.drillDim[0]={name:q.name,code:q.id,type:q.dim_type,colname:q.dimkey,colnamedesc:q.dimtxt,dimord:q.dimord,tname:q.tname}}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})}function editCross(){var p=curTmpInfo.colId;var u=curTmpInfo.compId;var o=curTmpInfo.tp;var b=curTmpInfo.dimname;var g=findCompById(u);var a=null;if(o=="kpi"){var t=g.kpiJson;for(var f=0;f<t.length;f++){if(t[f].kpi_id==p){a=t[f];break}}}else{if(o=="col"||o=="row"){var q=null;if(o=="col"){q=g.tableJson.cols}else{q=g.tableJson.rows}for(var f=0;f<q.length;f++){if(q[f].id==p){a=q[f];break}}}else{if(o=="head"){var s=g.head;for(var f=0;f<s.length;f++){if(s[f].id==p){a=s[f];break}}}else{if(o=="kpiHead"){var d=g.kpiHead;for(var f=0;f<d.length;f++){if(d[f].id==p){a=d[f];break}}}}}}var r=["sum","avg","count","max","min"];var e="";if(o=="kpi"){for(f=0;f<r.length;f++){e=e+'<option value="'+r[f]+'" '+(r[f]==a.aggre?"selected":"")+">"+r[f]+"</option>"}}var v='<div class="textpanel">'+(o!="head"&&o!="kpiHead"?'<span class="inputtext">对应字段：</span>'+(o=="kpi"?a.kpi_id:a.id)+"<br/>":"")+'<span class="inputtext">类型：</span> '+(o=="kpi"?"度量":(o=="head"||o=="kpiHead"?"表头":"维度"))+'<br/><span class="inputtext">显示名：</span> <input type="text" class="inputform" name="dispName" id="dispName" value="'+(o=="kpi"?a.kpi_name:(o=="head"||o=="kpiHead"?a.desc:a.dimdesc))+'"> <br/>';if(o=="col"||o=="row"){v=v+'<span class="inputtext">排序：</span><select id="dimord" name="dimord" class="inputform"><option value=""></option><option '+(a.dimord=="asc"?"selected":"")+' value="asc">正序</option><option '+(a.dimord=="desc"?"selected":"")+' value="desc">倒序</option></select> <br>'}else{if(o=="kpi"){v=v+'<span class="inputtext">计算方式：</span><select id="kpiaggre" name="kpiaggre" class="inputform">'+e+"</select> <br>";v=v+'<span class="inputtext">度量单位：</span><input type="text" id="kpiunit" name="kpiunit" class="inputform" value="'+(a.unit?a.unit:"")+'"> <br>';v=v+'<span class="inputtext">格式化：</span>'+curTmpInfo.property.ftmstr("kpifmt","inputform",(a.fmt?a.fmt:""));v=v+'<br><span class="inputtext">排序：</span><select id="sort" name="sort" class="inputform"><option value=""></option><option '+(a.sort=="asc"?"selected":"")+' value="asc">正序</option><option '+(a.sort=="desc"?"selected":"")+' value="desc">倒序</option></select> <br>'}}if(o=="head"||o=="kpiHead"||o=="kpi"){}else{v=v+'<span class="inputtext">取TOP：</span><input type="text" id="topval" name="topval" class="inputform" value="'+(a.top?a.top:"")+'"> <br>'}v=v+"</div>";if(o=="kpi"){var h=a.warning;var c=curTmpInfo.scrossTable.createWarningHtml(h);v='<div id="kpi_property"><div title="基本信息">'+v+'</div><div title="数据预警">'+c+'</div><div title="回调函数"><div class="textpanel">function <input type="text" id="funcname" name="funcname" size="5" value="'+(a.funcname?a.funcname:"")+'">(<b>value</b>, <b>col</b>, <b>row</b>, <b>data</b>){<br/><textarea id="code" name="code" cols="40" rows="5">'+(a.code?unescape(a.code):"")+'</textarea><br/>}<br/><a target="_blank" href="../helper/callback.html" id="helper">帮助</a></div></div></div>'}$("#pdailog").dialog({title:"编辑"+(o=="kpi"?"度量":(o=="kpiHead"||o=="head")?"表头":"维度"),width:400,height:(o=="kpi"?330:250),closed:false,cache:false,modal:true,toolbar:null,content:v,onLoad:function(){},buttons:[{text:"确定",handler:function(){if(o=="kpi"){var A=$("#pdailog #kpi_property").tabs("getSelected");var x=$("#pdailog #kpi_property").tabs("getTabIndex",A);if(x==0){a.kpi_name=$("#pdailog #dispName").val();$("#"+g.id+" #"+p+" span.txt").text(a.kpi_name);a.unit=$("#pdailog #kpiunit").val();a.fmt=$("#pdailog #kpifmt").val();a.aggre=$("#pdailog #kpiaggre").val();var z=$("#pdailog #sort").val();if(z!=""){for(var y=0;y<g.kpiJson.length;y++){delete g.kpiJson[y].sort}}a.sort=z}else{if(x==1){var D=$("#pdailog #val1").val();var C=$("#pdailog #val2").val();if(D==""||C==""){delete a.warning;$("#pdailog").dialog("close");return}curTmpInfo.scrossTable.getWarningVal(a)}else{if(x==2){var w=$("#kpi_property #funcname").val();var B=$("#kpi_property #code").val();if(w==""&&B==""){delete a.funcname;delete a.code;$("#pdailog").dialog("close");return}if(w==""){msginfo("函数名是必填项！");$("#kpi_property #funcname").focus();return}if(B==""){msginfo("函数内容是必填项！");$("#kpi_property #code").focus();return}a.funcname=w;a.code=escape(B)}}}}else{if(o=="head"||o=="kpiHead"){a.desc=$("#pdailog #dispName").val();$("#"+g.id+" #"+p+"").text(a.desc)}else{a.dimdesc=$("#pdailog #dispName").val();a.dimord=$("#pdailog #dimord").val();$("#"+g.id+" #"+p+" span.txt").text(a.dimdesc);a.top=$("#pdailog #topval").val()}}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});if(o=="kpi"){$("#pdailog #kpi_property").tabs({fit:true,border:false});$("#pdailog #kpi_property #helper").linkbutton({iconCls:"icon-tip"});curTmpInfo.scrossTable.regWarningEvent()}}function crossmove(g){var f=curTmpInfo.colId;var o=curTmpInfo.compId;var e=curTmpInfo.tp;var a=curTmpInfo.dimname;var d=findCompById(o);var h=null;if(e=="col"){h=d.tableJson.cols}else{if(e=="row"){h=d.tableJson.rows}else{if(e=="kpi"){h=d.kpiJson}else{if(e=="head"){h=d.head}else{if(e=="kpiHead"){h=d.kpiHead}}}}}if(h.length<=1){msginfo("无效移动。");return}var c=function(r,p){var q;if(e=="col"){q=$("#"+o+" #"+p).parent().parent()}else{q=$("#"+o+" #"+p).parent()}if(r=="left"){q.prev().before(q)}else{if(r=="right"){q.next().after(q)}}};for(var b=0;b<h.length;b++){if(h[b].id==f||h[b].kpi_id==f){if(g=="left"){if(b<=0){msginfo("无效移动。");return}else{var g=h[b-1];h[b-1]=h[b];h[b]=g;c("left",f);curTmpInfo.isupdate=true;return}}else{if(g=="right"){if(b>=h.length-1){msginfo("无效移动。");return}else{var g=h[b+1];h[b+1]=h[b];h[b]=g;c("right",f);curTmpInfo.isupdate=true;return}}}break}}}function crossDimAggre(){var c=curTmpInfo.colId;var e=curTmpInfo.compId;var h=curTmpInfo.tp;var b=findCompById(e);var g=null;if(h=="col"){g=b.tableJson.cols}else{g=b.tableJson.rows}var f=null;for(var d=0;d<g.length;d++){if(g[d].id==c){f=g[d]}}if(f.issum=="y"){f.issum="n";delete f.aggre;curTmpInfo.isupdate=true;return}var a='<div style=\'line-height:30px; margin:20px 20px 20px 40px;\'>聚合方式：<select id="dimaggre" name="dimaggre"><option value="sum">求和</option><option value="count">计数</option><option value="avg">平均</option><option value="max">最大</option><option value="min">最小</option><option value="var">方差</option><option value="sd">标准差</option><option value="middle">中位数</option></select></div>';$("#pdailog").dialog({title:"维度计算",width:280,height:180,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",handler:function(){if(f.issum=="y"){f.issum="n";delete f.aggre}else{f.issum="y";f.aggre=$("#pdailog #dimaggre").val()}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})}function crossdelete(){var a=curTmpInfo.colId;var q=curTmpInfo.compId;var d=findCompById(q);var e=curTmpInfo.tp;if(e=="kpi"){var p=d.kpiJson;var h=-1;for(var c=0;c<p.length;c++){if(p[c].kpi_id==a){h=c;break}}p.splice(h,1);if(p.length==0){$("#"+q+" #d_kpi").addClass("tabhelpr").find("table.crosstab2 td").html("将度量拖到此处查询数据")}else{$("#"+q+" #"+a).parent().remove()}var o=-1;for(var c=0;c<d.kpiHead.length;c++){if(d.kpiHead[c].id=="k_"+a){o=c;break}}d.kpiHead.splice(o,1);if(d.kpiHead.length==0){$("#"+q+" #d_kpiHead").html("")}else{$("#"+q+" #k_"+a).parent().remove()}}if(e=="head"){var g=-1;for(var b=0;b<d.head.length;b++){if(d.head[b].id==a){g=b;break}}d.head.splice(g,1);if(d.head.length==0){$("#"+q+" #d_rowHead table.crosstab2 td").html("")}else{$("#"+q+" #"+a).parent().remove()}a=a.replace("h_","");var f=d.tableJson.rows;var h=-1;for(var c=0;c<f.length;c++){if(f[c].id==a){h=c;break}}f.splice(h,1);if(f.length==0){$("#"+q+" #d_rowDims").addClass("tabhelpr").find("table.crosstab2 td").html("将维度拖到此处作为行标签")}else{$("#"+q+" #"+a).parent().remove()}}if(e=="col"||e=="row"){var f=null;if(e=="col"){f=d.tableJson.cols}else{f=d.tableJson.rows}var h=-1;for(var c=0;c<f.length;c++){if(f[c].id==a){h=c;break}}f.splice(h,1);if(f.length==0){if(e=="col"){$("#"+q+" #d_colDims").addClass("tabhelpr").find("table.crosstab2 td").html("将维度拖到此处作为行标签")}else{$("#"+q+" #d_rowDims").addClass("tabhelpr").find("table.crosstab2 td").html("将维度拖到此处作为行标签")}}else{if(e=="row"){$("#"+q+" #"+a).parent().remove()}else{$("#"+q+" #"+a).parent().parent().remove()}}if(e=="row"){var g=-1;for(var b=0;b<d.head.length;b++){if(d.head[b].id=="h_"+a){g=b}}d.head.splice(g,1);if(d.head.length==0){$("#"+q+" #d_rowHead table.crosstab2 td").html("")}else{$("#"+q+" #h_"+a).parent().remove()}}}if(e=="kpiHead"){var o=-1;for(var c=0;c<d.kpiHead.length;c++){if(d.kpiHead[c].id==a){o=c;break}}d.kpiHead.splice(o,1);if(d.kpiHead.length==0){$("#"+q+" #d_kpiHead").html("")}else{$("#"+q+" #"+a).parent().remove()}a=a.replace("k_","");var p=d.kpiJson;var h=-1;for(var c=0;c<p.length;c++){if(p[c].kpi_id==a){h=c;break}}p.splice(h,1);if(p.length==0){$("#"+q+" #d_kpi").addClass("tabhelpr").find("table.crosstab2 td").html("将度量拖到此处查询数据")}else{$("#"+q+" #"+a).parent().remove()}}curTmpInfo.isupdate=true}function crossAggreType(e,f,c){curTmpInfo.usetype="cross";curTmpInfo.compId=c;curTmpInfo.kpiId=f;$("#aggretypemenu").children().each(function(h,o){$("#aggretypemenu").menu("setIcon",{target:$(this),iconCls:"icon-blank"})});var a=findCompById(c);var d="sum";for(var b=0;b<a.kpiJson.length;b++){if(a.kpiJson[b].kpi_id==f){d=a.kpiJson[b].aggre;break}}$("#aggretypemenu").menu("setIcon",{target:$("#aggre_"+d),iconCls:"icon-ok"});var g=$(e).offset();$("#aggretypemenu").menu("show",{left:g.left,top:g.top+20})}function isKpiExist(d,c){var a=false;if(!c||c==null){return a}for(var b=0;b<c.length;b++){if(c[b].kpi_id==d){a=true;break}}return a}function isDimExist(c,d){var a=false;if(!d||d==null){return a}for(var b=0;b<d.length;b++){if(d[b].id==c){a=true;break}}return a}function insertTable(a){var b={id:newGuid(),type:"table",name:"表格组件"};var c=addComp(b,a,true);$("#layout_"+a).append(c);regCompEvent(b);initCompDropEvent(b.id);regTableEvent(b.id);regTableDrop(b.id)}function regTableDrop(a){$("#T"+a+" td").droppable({accept:"#mydatatree .tree-node",onDragEnter:function(d,c){d.preventDefault();d.stopPropagation();var b=$("#mydatatree").tree("getNode",c);var g=b.attributes.income;if(g!="dataset"){return}var f=$(c).draggable("proxy").find("span");if(!f.hasClass("tree-dnd-yes")){f.removeClass("tree-dnd-no");f.addClass("tree-dnd-yes")}},onDragLeave:function(c,b){c.preventDefault();c.stopPropagation();$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$(b).draggable("proxy").find("span").addClass("tree-dnd-no")},onDrop:function(f,d){f.preventDefault();f.stopPropagation();var c=$("#mydatatree").tree("getNode",d);var b=findCompById(a);var h=c.attributes.income;if(h!="dataset"){msginfo("只能将数据集中的字段拖入表格组件中。");return}if(b.income&&h!=b.income){msginfo("组件只能映射一个数据集。");return}if(b.datasetid&&b.datasetid!=c.attributes.datasetid){msginfo("组件只能映射一个数据集。");return}var g=$(this);if(g.hasClass("gridtab-td")){g.html('<div class="tabletdcol" isaggre="n" type="'+c.attributes.type+'" cid="'+c.id+'">'+c.text+"</div>")}else{if(c.attributes.type!="Double"&&c.attributes.type!="Int"){msginfo("放入本区域的字段必须是数字类型。");return}else{g.html('<div class="tabletdcol" isaggre="y" aggre="sum" type="'+c.attributes.type+'" cid="'+c.id+'"><span class="grouptype" onclick="tableAggreType(this, \''+c.id+"', '"+c.attributes.datasetid+'\')" title="聚合方式" style="opacity: 0.6;"></span>'+c.text+"</div>")}}var h=c.attributes.income;b.income=h;if(h=="dataset"){b.datasetid=c.attributes.datasetid}else{if(h=="cube"){b.cubeid=c.attributes.cubeId}}}})}function tableAggreType(b,c,a){curTmpInfo.usetype="table";curTmpInfo.compId=a;curTmpInfo.kpiId=c;curTmpInfo.tdobj=b;$("#aggretypemenu").children().each(function(e,f){$("#aggretypemenu").menu("setIcon",{target:$(this),iconCls:"icon-blank"})});$("#aggretypemenu").menu("setIcon",{target:$("#aggre_"+$(b).parent().attr("aggre")),iconCls:"icon-ok"});var d=$(b).offset();$("#aggretypemenu").menu("show",{left:d.left,top:d.top+20})}function regTableEvent(a){var c=false;var e=null;var b=function(f){$("#T"+a+" td").removeClass("tdselect");$(f).addClass("tdselect");setProp($("#"+a).parent().attr("id").split("_")[1],a)};var d=function(){$("#layout_table .comp_table").each(function(){var f=$(this).attr("type");$(this).css("border",(f=="table"||f=="cross"?"0":"1")+"px solid #cccccc")});$("#"+a).css("border","1px solid #999999")};$("#T"+a+" td").unbind("click").unbind("mousedown").unbind("mouseup").unbind("mousemove").unbind("contextmenu").bind("click",function(f){f.preventDefault();f.stopPropagation();b(this);d()}).bind("mousedown",function(f){c=true;e=this}).bind("mouseup",function(f){c=false}).bind("mousemove",function(f){if(c){selectArea(e,this,a)}}).bind("contextmenu",function(g){g.preventDefault();g.stopPropagation();if($("#T"+a+" td.tdselect").size()<=1){b(this)}d();curTmpInfo.layoutId=$("#"+a).parent().attr("id").split("_")[1];curTmpInfo.compId=a;curTmpInfo.curtabtd=this;if($(this).attr("colspan")>1||$(this).attr("rowspan")>1){$("#tablerightmenu").menu("enableItem",$("#m_unmergeCell"))}else{$("#tablerightmenu").menu("disableItem",$("#m_unmergeCell"))}if($("#T"+a+" td.tdselect").size()>1){$("#tablerightmenu").menu("enableItem",$("#m_mergeCell"));var o=null;var f=true;var h=true;$("#T"+a+" td.tdselect").each(function(p,q){if(p==0){o=$(this).attr("pos").split(",")}else{var r=$(this).attr("pos").split(",");if(r[0]!=o[0]&&f==true){f=false}if(r[1]!=o[1]&&h==true){h=false}}});if(f){$("#tablerightmenu").menu("enableItem",$("#m_insertrow"));$("#tablerightmenu").menu("enableItem",$("#m_deleterow"));$("#tablerightmenu").menu("disableItem",$("#m_insertcol"));$("#tablerightmenu").menu("disableItem",$("#m_deletecol"))}else{if(h){$("#tablerightmenu").menu("enableItem",$("#m_insertcol"));$("#tablerightmenu").menu("enableItem",$("#m_deletecol"));$("#tablerightmenu").menu("disableItem",$("#m_insertrow"));$("#tablerightmenu").menu("disableItem",$("#m_deleterow"))}else{$("#tablerightmenu").menu("enableItem",$("#m_insertrow"));$("#tablerightmenu").menu("enableItem",$("#m_deleterow"));$("#tablerightmenu").menu("enableItem",$("#m_insertcol"));$("#tablerightmenu").menu("enableItem",$("#m_deletecol"))}}}else{$("#tablerightmenu").menu("disableItem",$("#m_mergeCell"));$("#tablerightmenu").menu("enableItem",$("#m_insertrow"));$("#tablerightmenu").menu("enableItem",$("#m_deleterow"));$("#tablerightmenu").menu("enableItem",$("#m_insertcol"));$("#tablerightmenu").menu("enableItem",$("#m_deletecol"))}$("#tablerightmenu").menu("show",{left:g.pageX,top:g.pageY})})}function editcells(){var c=curTmpInfo.compId;var f=$(curTmpInfo.curtabtd);if(f.hasClass("gridtab-td")||f.children("div[isaggre='y']").size()>0){var e=f.children("div");if(!e||!e.attr("cid")){return}var d="";for(var b=0;b<dataType.length;b++){d=d+'<option value="'+dataType[b]+'" '+(e.attr("type")==dataType[b]?"selected":"")+">"+dataType[b]+"</option>"}var a='<div id="property_tab"><div title="基本信息"><div class="textpanel"><span class="inputtext">绑定字段：</span>'+e.attr("cid")+'<br/><span class="inputtext">显示名称：</span><input type="text" class="inputform" name="dispName" id="dispName" value="'+e.text()+'" '+(e.attr("isaggre")=="y"?"readOnly":"")+"><br/>"+(e.attr("isaggre")!="y"?'<span class="inputtext">字段类型：</span><select id="coltype" class="inputform">'+d+"</select>":"")+"</div></div>"+(e.attr("isaggre")!="y"?'<div title="回调函数"><div class="textpanel">function <input type="text" id="funcname" name="funcname" size="5" value="'+(e.attr("funcname")?e.attr("funcname"):"")+'">(<b>value</b>, <b>rowData</b>, <b>column</b>){<br/><textarea id="code" name="code" cols="40" rows="5">'+(e.attr("code")?unescape(e.attr("code")):"")+'</textarea><br/>}<br/><a target="_blank" href="../helper/callback.html" id="helper">帮助</a></div></div>':"")+"</div>";$("#pdailog").dialog({title:"编辑单元格",width:320,height:300,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},buttons:[{text:"确定",handler:function(){var o=$("#pdailog #property_tab").tabs("getSelected");var h=$("#pdailog #property_tab").tabs("getTabIndex",o);if(h==0){if(e.attr("isaggre")!="y"){e.attr("type",$("#pdailog #coltype").val());e.text($("#pdailog #dispName").val())}}else{if(h==1){var g=$("#pdailog #funcname").val();var p=$("#pdailog #code").val();if(g==""){msginfo("请录入函数名称！");$("#pdailog #funcname").focus();return}if(p==""){msginfo("请录入函数内容！");$("#pdailog #code").focus();return}e.attr("funcname",g);e.attr("code",escape(p))}}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #property_tab").tabs({fit:true,border:false});$("#pdailog #property_tab #helper").linkbutton({iconCls:"icon-tip"});return}f.html('<input type="text" id="editcell" name="editcell" value="'+(f.attr("desc")?f.attr("desc"):"")+'" style="width:98%; border:none;">');$("#"+c+" #editcell").bind("blur",function(){f.attr("desc",$(this).val()).html('<div class="tdcells">'+$(this).val()+"</div>")}).focus()}function json2table(b){var c='<table cellspacing="0" cellpadding="0" class="gridtab" id="T'+b.id+'">';for(i=0;true;i++){var a=b.header["tr"+i];if(!a||a.length==0){break}c=c+"<tr>";for(j=0;j<a.length;j++){if(a[j].desc&&a[j].isaggre!="y"){c=c+'<td class="gridtab-th" colspan="'+a[j].colspan+'" rowspan="'+a[j].rowspan+"\" width='"+a[j].dwidth+"%' pos='"+a[j].pos+"' desc=\""+a[j].desc+'" fmt="'+(a[j].fmt?a[j].fmt:"")+'" style="'+((a[j].align?"text-align:"+a[j].align:"text-align:center"))+'" palign="'+(a[j].align?a[j].align:"center")+'" fontsize="'+(a[j].fontsize?a[j].fontsize:"")+'" fontcolor="'+(a[j].fontcolor?a[j].fontcolor:"")+'" height="'+(a[j].height?a[j].height:"")+'" pwidth="'+(a[j].width?a[j].width:"")+'" fontweight="'+(a[j].fontweight?a[j].fontweight:"")+'" italic="'+(a[j].italic?a[j].italic:"")+'" bgcolor="'+(a[j].bgcolor?a[j].bgcolor:"")+'" underscore="'+(a[j].underscore?a[j].underscore:"")+'" order="'+(a[j].order?a[j].order:"")+'" ><div class="tdcells">'+a[j].desc+"</div></td>"}else{if(a[j].isaggre=="y"){c=c+'<td class="gridtab-th" colspan="'+a[j].colspan+'" rowspan="'+a[j].rowspan+"\" width='"+a[j].dwidth+"%' pos='"+a[j].pos+"' ><div cid=\""+a[j].col+'" type="'+a[j].type+'" fmt="'+(a[j].fmt?a[j].fmt:"")+'" style="'+((a[j].align?"text-align:"+a[j].align:"text-align:center"))+'" palign="'+(a[j].align?a[j].align:"center")+'" aggre="'+a[j].aggre+'" isaggre="y" fontsize="'+(a[j].fontsize?a[j].fontsize:"")+'" fontcolor="'+(a[j].fontcolor?a[j].fontcolor:"")+'" fontweight="'+(a[j].fontweight?a[j].fontweight:"")+'" italic="'+(a[j].italic?a[j].italic:"")+'" underscore="'+(a[j].underscore?a[j].underscore:"")+'" bgcolor="'+(a[j].bgcolor?a[j].bgcolor:"")+'" height="'+(a[j].height?a[j].height:"")+'" pwidth="'+(a[j].width?a[j].width:"")+'" order="'+(a[j].order?a[j].order:"")+'" class="tabletdcol"><span style="opacity: 0.6;" title="聚合方式" onclick="tableAggreType(this, \''+a[j].col+"', '"+b.id+'\')" class="grouptype"></span>'+a[j].desc+"</div></td>"}else{c=c+'<td class="gridtab-th" colspan="'+a[j].colspan+'" rowspan="'+a[j].rowspan+"\" width='"+a[j].dwidth+"%' pos='"+a[j].pos+"'>"+(j==0?'<div class="tabhelpr2">表头</div>':"")+"</td>"}}}c=c+"</tr>"}for(i=0;true;i++){var a=b.detail["tr"+i];if(!a||a.length==0){break}c=c+"<tr>";for(j=0;j<a.length;j++){if(a[j].alias){c=c+'<td class="gridtab-td" colspan="'+a[j].colspan+'" rowspan="'+a[j].rowspan+"\" pos='"+a[j].pos+"' ><div cid=\""+a[j].alias+'" fmt="'+(a[j].fmt?a[j].fmt:"")+'" style="'+((a[j].align?"text-align:"+a[j].align:"text-align:left"))+'" palign="'+(a[j].align?a[j].align:"left")+'" type="'+a[j].type+'" fontsize="'+(a[j].fontsize?a[j].fontsize:"")+'" fontcolor="'+(a[j].fontcolor?a[j].fontcolor:"")+'" fontweight="'+(a[j].fontweight?a[j].fontweight:"")+'" italic="'+(a[j].italic?a[j].italic:"")+'" height="'+(a[j].height?a[j].height:"")+'" pwidth="'+(a[j].width?a[j].width:"")+'" bgcolor="'+(a[j].bgcolor?a[j].bgcolor:"")+'" underscore="'+(a[j].underscore?a[j].underscore:"")+'" funcname="'+(a[j].funcname?a[j].funcname:"")+'" code="'+(a[j].code?a[j].code:"")+'" class="tabletdcol">'+a[j].desc+"</div></td>"}else{c=c+'<td class="gridtab-td" colspan="'+a[j].colspan+'" rowspan="'+a[j].rowspan+"\" pos='"+a[j].pos+"' >"+(j==0?'<div class="tabhelpr2">表数据</div>':"")+"</td>"}}c=c+"</tr>"}for(i=0;true;i++){var a=b.footer["tr"+i];if(!a||a.length==0){break}c=c+"<tr>";for(j=0;j<a.length;j++){if(a[j].desc&&a[j].isaggre!="y"){c=c+'<td class="gridtab-th2" colspan="'+a[j].colspan+'" rowspan="'+a[j].rowspan+"\" pos='"+a[j].pos+"' desc=\""+a[j].desc+'" fmt="'+(a[j].fmt?a[j].fmt:"")+'" style="'+((a[j].align?"text-align:"+a[j].align:"text-align:center"))+'" palign="'+(a[j].align?a[j].align:"center")+'" fontsize="'+(a[j].fontsize?a[j].fontsize:"")+'" fontcolor="'+(a[j].fontcolor?a[j].fontcolor:"")+'" fontweight="'+(a[j].fontweight?a[j].fontweight:"")+'" italic="'+(a[j].italic?a[j].italic:"")+'" underscore="'+(a[j].underscore?a[j].underscore:"")+'" bgcolor="'+(a[j].bgcolor?a[j].bgcolor:"")+'" height="'+(a[j].height?a[j].height:"")+'" pwidth="'+(a[j].width?a[j].width:"")+'"><div class="tdcells">'+a[j].desc+"</div></td>"}else{if(a[j].isaggre=="y"){c=c+'<td class="gridtab-th2" colspan="'+a[j].colspan+'" rowspan="'+a[j].rowspan+"\" pos='"+a[j].pos+"' ><div cid=\""+a[j].col+'" type="'+a[j].type+'" fmt="'+(a[j].fmt?a[j].fmt:"")+'" style="'+((a[j].align?"text-align:"+a[j].align:"text-align:center"))+'" palign="'+(a[j].align?a[j].align:"center")+'" fontsize="'+(a[j].fontsize?a[j].fontsize:"")+'" fontcolor="'+(a[j].fontcolor?a[j].fontcolor:"")+'" fontweight="'+(a[j].fontweight?a[j].fontweight:"")+'" italic="'+(a[j].italic?a[j].italic:"")+'" underscore="'+(a[j].underscore?a[j].underscore:"")+'" bgcolor="'+(a[j].bgcolor?a[j].bgcolor:"")+'" height="'+(a[j].height?a[j].height:"")+'" pwidth="'+(a[j].width?a[j].width:"")+'" aggre="'+a[j].aggre+'" isaggre="y" class="tabletdcol"><span style="opacity: 0.6;" title="聚合方式" onclick="tableAggreType(this, \''+a[j].col+"', '"+b.id+'\')" class="grouptype"></span>'+a[j].desc+"</div></td>"}else{c=c+'<td class="gridtab-th2" colspan="'+a[j].colspan+'" rowspan="'+a[j].rowspan+"\" pos='"+a[j].pos+"'>"+(j==0?'<div class="tabhelpr2">表尾</div>':"")+"</td>"}}}c=c+"</tr>"}c=c+"</table>";return c}function table2json(o){var e=findCompById(o);e.header={};e.detail={};e.footer={};var q=document.getElementById("T"+o).rows;var f=0;var g=0;var b=0;for(i=0;i<q.length;i++){var p=q[i].cells;var d=null;if($(p[0]).hasClass("gridtab-th")){d=e.header["tr"+f]=[];f=f+1}else{if($(p[0]).hasClass("gridtab-td")){d=e.detail["tr"+g]=[];g=g+1}else{if($(p[0]).hasClass("gridtab-th2")){d=e.footer["tr"+b]=[];b=b+1}}}if(p.length==0){}for(j=0;j<p.length;j++){var h=$(p[j]);if(h.hasClass("gridtab-th")||h.hasClass("gridtab-th2")){var c={colspan:(h.attr("colspan")?h.attr("colspan"):"1"),rowspan:(h.attr("rowspan")?h.attr("rowspan"):"1"),desc:h.attr("desc"),width:(h.attr("width")?h.attr("width"):""),pos:h.attr("pos")};d.push(c);var a=h.children("div");if(a.attr("isaggre")=="y"){c.aggre=a.attr("aggre");c.col=a.attr("cid");c.alias=c.col+"_"+c.aggre;c.type=a.attr("type");c.desc=a.text();c.align=(a.attr("palign")?a.attr("palign"):"");c.isaggre="y";c.fmt=a.attr("fmt")?a.attr("fmt"):"";c.fontsize=a.attr("fontsize")?a.attr("fontsize"):"";c.fontcolor=a.attr("fontcolor")?a.attr("fontcolor"):"";c.fontweight=a.attr("fontweight")?a.attr("fontweight"):"";c.italic=a.attr("italic")?a.attr("italic"):"";c.underscore=a.attr("underscore")?a.attr("underscore"):"";c.bgcolor=a.attr("bgcolor")?a.attr("bgcolor"):"";c.order=a.attr("order")?a.attr("order"):"";c.width=a.attr("pwidth")?a.attr("pwidth"):"";c.height=a.attr("height")?a.attr("height"):"";c.dwidth=!h.attr("width")||h.attr("width")==""?"":h.attr("width").replace("%","")}else{c.align=(h.attr("palign")?h.attr("palign"):"");c.fmt=(h.attr("fmt")?h.attr("fmt"):"");c.fontsize=h.attr("fontsize")?h.attr("fontsize"):"";c.fontcolor=h.attr("fontcolor")?h.attr("fontcolor"):"";c.fontweight=h.attr("fontweight")?h.attr("fontweight"):"";c.italic=h.attr("italic")?h.attr("italic"):"";c.underscore=h.attr("underscore")?h.attr("underscore"):"";c.bgcolor=h.attr("bgcolor")?h.attr("bgcolor"):"";c.order=h.attr("order")?h.attr("order"):"";c.width=h.attr("pwidth")?h.attr("pwidth"):"";c.height=h.attr("height")?h.attr("height"):"";c.dwidth=!h.attr("width")||h.attr("width")==""?"":h.attr("width").replace("%","")}}else{if(h.hasClass("gridtab-td")){var c={colspan:(h.attr("colspan")?h.attr("colspan"):"1"),rowspan:(h.attr("rowspan")?h.attr("rowspan"):"1"),width:(h.attr("width")?h.attr("width"):""),pos:h.attr("pos")};d.push(c);var a=h.children("div");c.alias=a.attr("cid");c.type=a.attr("type");c.desc=a.text();c.align=(a.attr("palign")?a.attr("palign"):"");c.fmt=a.attr("fmt")?a.attr("fmt"):"";c.fontsize=a.attr("fontsize")?a.attr("fontsize"):"";c.fontcolor=a.attr("fontcolor")?a.attr("fontcolor"):"";c.fontweight=a.attr("fontweight")?a.attr("fontweight"):"";c.italic=a.attr("italic")?a.attr("italic"):"";c.underscore=a.attr("underscore")?a.attr("underscore"):"";c.bgcolor=a.attr("bgcolor")?a.attr("bgcolor"):"";c.width=a.attr("pwidth")?a.attr("pwidth"):"";c.height=a.attr("height")?a.attr("height"):"";c.funcname=a.attr("funcname")?a.attr("funcname"):"";c.code=a.attr("code")?a.attr("code"):""}}}}}function clearcells(){var a=curTmpInfo.compId;var b=curTmpInfo.curtabtd;$(b).html("").attr("desc","")}function selectArea(e,a,b){$("#T"+b+" td").removeClass("tdselect");var d=$(e).attr("pos").split(",");var c=$(a).attr("pos").split(",");if(d[0]>c[0]||d[1]>c[1]){tmp=d;d=c;c=tmp}for(i=d[0];i<=c[0];i++){for(j=d[1];j<=c[1];j++){$("#T"+b+" td[pos='"+(i+","+j)+"']").addClass("tdselect")}}}function resetPos(g){var q=document.getElementById("T"+g).rows;var p=q[0].cells;var f=0;for(i=0;i<p.length;i++){f=f+Number(($(p[i]).attr("colspan")?$(p[i]).attr("colspan"):1))}var h={};var c=q.length;for(j=0;j<c;j++){p=q[j].cells;var b=0;for(i=0;i<p.length;i++){var a=$(p[i]).attr("colspan")?Number($(p[i]).attr("colspan")):1;var e=$(p[i]).attr("rowspan")?Number($(p[i]).attr("rowspan")):1;if(e>1){for(k=1;k<e;k++){var o="before";for(m=0;m<i;m++){var d=($(p[m]).attr("rowspan")?Number($(p[m]).attr("rowspan")):1)-1;if(d<k){o="after";break}}h[(j+k)+","+(o=="before"?b:b-1)+o]=a}}for(l=b-1;i==0&&l<f;l++){if(h[j+","+(b)+"before"]){b=b+h[j+","+(b)+"before"]}else{break}}$(p[i]).attr({pos:j+","+b});b=b+1;if(a>1){b=b+(a-1)}for(l=b-1;l<f;l++){if(h[j+","+(l)+"after"]){b=b+h[j+","+(l)+"after"]}else{break}}}}}function insertCol(){var g=$("#tablerightmenu").menu("getItem",$("#m_insertcol"));if(g.disabled){return}var x=curTmpInfo.compId;var h=curTmpInfo.curtabtd;var p=function(z,c){var r=null;$("#T"+x+" td").each(function(A,B){var E=$(B).attr("pos").split(",");var D=$(B).attr("colspan")?Number($(B).attr("colspan")):1;var C=$(B).attr("rowspan")?Number($(B).attr("rowspan")):1;if(D>1){if(z>=Number(E[0])&&z<Number(E[0])+C&&c>Number(E[1])&&c<=Number(E[1])+D){r=$(B)}}});return r};var y=document.getElementById("T"+x).rows;var t=$(h).attr("pos").split(",");var v=Number(t[1]);var f=$(h).attr("colspan")?Number($(h).attr("colspan")):1;if(f>1){v=v+f-1}var b=[];for(i=0;i<y.length;i++){var u=null;var d=$("#T"+x+" td[pos='"+i+","+(v)+"']");if(d.size()==0){var o=p(i,v);if(o!=null){var a=Number(o.attr("colspan"))+1;o.attr("colspan",a);var s=Number(o.attr("rowspan"));if(s>1){i=i+s-1}continue}}else{var a=d.attr("colspan")?Number(d.attr("colspan")):1;var s=Number(d.attr("rowspan"));if(s>1){i=i+s-1}if(a>1){d.attr("colspan",a+1);continue}u=d}var w=u.attr("rowspan")?Number(u.attr("rowspan")):1;var e=u.attr("colspan")?Number(u.attr("colspan")):1;var q='<td colspan="'+e+'" rowspan="'+w+'" class="';if(u.hasClass("gridtab-th")){q=q+"gridtab-th"}else{if(u.hasClass("gridtab-td")){q=q+"gridtab-td"}else{if(u.hasClass("gridtab-th2")){q=q+"gridtab-th2"}}}q=q+'"></td>';b.push({obj:u,str:q})}for(i=0;i<b.length;i++){b[i].obj.after(b[i].str)}updateTableTdWidth(x);resetPos(x);regTableEvent(x);regTableDrop(x)}function updateTableTdWidth(b){var a=document.getElementById("T"+b).rows[0].cells;var e=0;for(i=0;i<a.length;i++){e=e+Number(($(a[i]).attr("colspan")?$(a[i]).attr("colspan"):1))}var d=document.getElementById("T"+b).rows;for(j=0;j<d.length;j++){a=d[j].cells;for(i=0;i<a.length;i++){var c=((100/e)*($(a[i]).attr("colspan")?$(a[i]).attr("colspan"):1));$(a[i]).attr("width",Math.round(c)+"%")}}}function deleteRow(){var u=$("#tablerightmenu").menu("getItem",$("#m_deleterow"));if(u.disabled){return}var q=curTmpInfo.compId;var p=$(curTmpInfo.curtabtd);var t=0;var f=document.getElementById("T"+q).rows[0].cells;for(i=0;i<f.length;i++){var d=$(f[i]).attr("colspan")?Number($(f[i]).attr("colspan")):1;t=t+d}var z=function(B,c){var r=null;$("#T"+q+" td").each(function(C,D){var G=$(D).attr("pos").split(",");var E=$(D).attr("rowspan")?Number($(D).attr("rowspan")):1;var F=$(D).attr("colspan")?Number($(D).attr("colspan")):1;if(E>1){if(B>Number(G[0])&&B<=Number(G[0]+E)&&c>=Number(G[1])&&c<Number(G[1])+F){r=$(D)}}});return r};var e=[];var g=$(p).attr("pos").split(",");var w=Number(g[0]);var x=p.attr("rowspan")?Number(p.attr("rowspan")):1;for(n=0;n<x;n++){for(i=0;i<t;i++){var o=w+n;var b=$("#T"+q+" td[pos='"+o+","+i+"']");if(b.size()==0){var a=z(o,i);if(a!=null){var s=Number(a.attr("rowspan"))-1;a.attr("rowspan",s);var y=Number(a.attr("colspan"));if(y>1){i=i+y-1}}}else{if(Number(b.attr("rowspan"))>1){b.attr("rowspan",Number(b.attr("rowspan"))-1);var h=false;var v=i-1;while(v>=0){var A=$("#T"+q+" td[pos='"+(o+1)+","+(v)+"']");if(A.size()>0){A.after(b);h=true;break}v=v-1}if(h==false){v=i+1;while(v<t){var A=$("#T"+q+" td[pos='"+(o+1)+","+(v)+"']");if(A.size()>0){A.before(b);h=true;break}v=v+1}}}var y=Number(b.attr("colspan"));if(y>1){i=i+y-1}}}e.push($("#T"+q+" tr").get(o))}for(i=0;i<e.length;i++){$(e[i]).remove()}resetPos(q);updateTableTdWidth(q)}function deleteCol(){var d=$("#tablerightmenu").menu("getItem",$("#m_deletecol"));if(d.disabled){return}var s=curTmpInfo.compId;var e=$(curTmpInfo.curtabtd);var u=document.getElementById("T"+s).rows;var g=function(v,c){var r=null;$("#T"+s+" td").each(function(w,x){var A=$(x).attr("pos").split(",");var z=$(x).attr("colspan")?Number($(x).attr("colspan")):1;var y=$(x).attr("rowspan")?Number($(x).attr("rowspan")):1;if(z>1){if(v>=Number(A[0])&&v<Number(A[0])+y&&c>Number(A[1])&&c<=Number(A[1])+z){r=$(x)}}});return r};var h=Number(e.attr("pos").split(",")[1]);var t=[];var q=e.attr("colspan")?Number(e.attr("colspan")):1;for(k=0;k<q;k++){var p=h+k;for(i=0;i<u.length;i++){var b=$("#T"+s+" td[pos='"+i+","+(p)+"']");if(b.attr("pos")==e.attr("pos")){t.push(b);var o=Number(b.attr("rowspan"));if(o>1){i=i+o-1}continue}if(b.size()==0){var f=g(i,p);if(f!=null){var a=Number(f.attr("colspan"))-1;f.attr("colspan",a);var o=Number(f.attr("rowspan"));if(o>1){i=i+o-1}continue}}else{var a=b.attr("colspan")?Number(b.attr("colspan")):1;var o=b.attr("rowspan")?Number(b.attr("rowspan")):1;if(o>1){i=i+o-1}if(a>1){b.attr("colspan",a-1);continue}}t.push(b)}}for(i=0;i<t.length;i++){$(t[i]).remove()}updateTableTdWidth(s);resetPos(s)}function mergeCell(){var o=curTmpInfo.compId;var h=null;var g=null;var p=$("#T"+o+" td.tdselect").size();if(p<=1){return}var d=true;var a=null;var e=false;$("#T"+o+" td.tdselect").each(function(q,r){if(q==0){a=$(this).attr("class")}else{if($(this).attr("class")!=a&&d==true){d=false}}if($(this).hasClass("gridtab-td")){e=true}});if(!d){msginfo("不能同时合并表头、表数据、表尾等内容。");return}if(e){msginfo("不能合并表数据单元格。");return}var f=null;$("#T"+o+" td.tdselect").each(function(q,r){if(q==0){h=$(this).attr("pos").split(",")}if(q==p-1){g=$(this).attr("pos").split(",");f=$(this)}if(q>0){$(this).remove()}});var b=f.attr("colspan")?Number(f.attr("colspan")):1;var c=f.attr("rowspan")?Number(f.attr("rowspan")):1;$("#T"+o+" td.tdselect").attr("rowspan",Math.abs(h[0]-g[0]+(c-1))+1).attr("colspan",Math.abs(h[1]-g[1]+(b-1))+1);updateTableTdWidth(o)}function unmergeCell(){var b=curTmpInfo.compId;var h=$(curTmpInfo.curtabtd);var g=h.attr("colspan")?Number(h.attr("colspan")):1;var e=h.attr("rowspan")?Number(h.attr("rowspan")):1;h.attr("colspan",1);h.attr("rowspan",1);for(i=1;i<=e;i++){var f="";for(j=1;j<(i==1?g:g+1);j++){f=f+'<td class="';if(h.hasClass("gridtab-th")){f=f+"gridtab-th"}else{if(h.hasClass("gridtab-td")){f=f+"gridtab-td"}else{if(h.hasClass("gridtab-th2")){f=f+"gridtab-th2"}}}f=f+'"></td>'}if(i==1){h.after(f)}else{var a=h.attr("pos").split(",");var c=$("#T"+b+" td[pos='"+((Number(a[0])+i-1)+","+(Number(a[1])-1))+"']");if(c.size()==0){c=$("#T"+b+" td[pos='"+((Number(a[0])+i-1)+","+(Number(a[1])+g))+"']");if(c.size()>0){c.before(f)}else{var d=h.parent();for(k=1;k<=i-1;k++){d=d.next()}d.append(f)}}else{c.after(f)}}}updateTableTdWidth(b);resetPos(b);regTableEvent(b);regTableDrop(b)}function insertRow(){var e=$("#tablerightmenu").menu("getItem",$("#m_insertrow"));if(e.disabled){return}var v=curTmpInfo.compId;var f=curTmpInfo.curtabtd;var o=function(y,c){var r=null;$("#T"+v+" td").each(function(z,A){var D=$(A).attr("pos").split(",");var B=$(A).attr("rowspan")?Number($(A).attr("rowspan")):1;var C=$(A).attr("colspan")?Number($(A).attr("colspan")):1;if(B>1){if(y>Number(D[0])&&y<=Number(D[0])+B&&c>=Number(D[1])&&c<Number(D[1])+C){r=$(A)}}});return r};var u=0;var w=document.getElementById("T"+v).rows[0].cells;for(i=0;i<w.length;i++){var d=$(w[i]).attr("colspan")?Number($(w[i]).attr("colspan")):1;u=u+d}var t=$(f).attr("pos").split(",");var x=Number(t[0])+1;var g=$(f).attr("rowspan")?Number($(f).attr("rowspan")):1;x=x+g-1;var s="<tr>";for(i=0;i<u;i++){var b=$("#T"+v+" td[pos='"+x+","+i+"']");if(b.size()==0){var h=o(x,i);if(h!=null){var a=Number(h.attr("rowspan"))+1;h.attr("rowspan",a);var q=Number(h.attr("colspan"));if(q>1){i=i+q-1}continue}}s=s+'<td class="';if($(f).hasClass("gridtab-th")){s=s+"gridtab-th"}else{if($(f).hasClass("gridtab-td")){s=s+"gridtab-td"}else{if($(f).hasClass("gridtab-th2")){s=s+"gridtab-th2"}}}s=s+'">';if(i==0&&$(f).hasClass("gridtab-th")){s=s+'<div class="tabhelpr2">表头</div>'}else{if(i==0&&$(f).hasClass("gridtab-td")){s=s+'<div class="tabhelpr2">表数据</div>'}else{if(i==0&&$(f).hasClass("gridtab-th2")){s=s+'<div class="tabhelpr2">表尾</div>'}}}s=s+"</td>"}s=s+"</tr>";var p=$(f).parent();for(i=1;i<g;i++){p=p.next()}p.after(s);resetPos(v);regTableEvent(v);regTableDrop(v)}function crtTable(a){if(!a.header&&!a.detail){var b='<table cellspacing="0" cellpadding="0" class="gridtab" id="T'+a.id+"\"><tr><td class=\"gridtab-th\" width='33%' pos='0,0'><div class='tabhelpr2'>表头</div></div></td><td class=\"gridtab-th\" width='33%' pos='0,1'></td><td class=\"gridtab-th\" width='33%' pos='0,2'></td></tr><tr><td class=\"gridtab-td\" pos='1,0'><div class='tabhelpr2'>表数据</div></td><td class=\"gridtab-td\" pos='1,1'></td><td class=\"gridtab-td\" pos='1,2'></td></tr><tr><td class=\"gridtab-th2\" pos='2,0'><div class='tabhelpr2'>表尾</div></td><td class=\"gridtab-th2\" pos='2,1'></td><td class=\"gridtab-th2\" pos='2,2'></td></tr></table>";return b}else{return json2table(a)}}function staticCrossTable(){this.compIndex=pageInfo.compIndex?pageInfo.compIndex:0,this.parent=null,this.nextId=function(){this.compIndex=this.compIndex+1;if(this.compIndex==100000){this.compIndex=0}pageInfo.compIndex=this.compIndex;return"r"+this.compIndex},this.create=function(layoutId){var obj={id:newGuid(),type:"staticCross",name:"固定表组件",head:{desc:"交叉表头",style:{}},tableJson:{cols:[],rows:[]}};var str=addComp(obj,layoutId,true);$("#layout_"+layoutId).append(str);regCompEvent(obj);initCompDropEvent(obj.id);this.regDropEvent(obj)},this.reloadField=function(dims,compId,pos){var ret="";for(var i=0;i<dims.length;i++){var t=dims[i];ret=ret+(pos=="row"?"<tr>":"")+'<td class="'+(this.parent==null?"root":this.parent.id)+'">';ret=ret+'<div id="'+t.id+'"><div class="crskpi2" style="'+(pos=="row"||(t.children&&t.children.length>0)?"width:auto":"")+'">'+(t.type!="kpi"?'<span class="crossdim"></span><span style="'+(pos=="row"&&t.spaceNum&&t.spaceNum!=""?"margin-left:"+(6*Number(t.spaceNum))+"px;":"")+'" class="txt">'+t.desc+"</span>":'<span title="聚合方式" onclick="curTmpInfo.scrossTable.kpiAggreType(this, \''+t.id+"', '"+compId+"','"+pos+'\')" class="kpilabel"></span><span class="txt">'+t.desc+"</span>")+"</div>";if(t.children&&t.children.length>0){if(dims.length>0){ret=ret+'<table cellspacing="0" cellpadding="0">'+(pos!="row"?"<tr>":"")}this.parent=t;ret=ret+this.reloadField(t.children,compId,pos);this.parent=null;if(dims.length>0){ret=ret+(pos!="row"?"</tr>":"")+"</table>"}}ret=ret+"</div></td>"+(pos=="row"?"</tr>":"")}return ret},this.crtStaticTable=function(comp){var rows=this.reloadField(comp.tableJson.rows,comp.id,"row");var cols=this.reloadField(comp.tableJson.cols,comp.id,"col");this.parent=null;var ret='<table class=\'d_table\'><tr><td class=\'crosstb\' width="20%"><div id="jcbt" class="crskpi2" style="width:auto;text-align:center">'+(comp.head?comp.head.desc:"")+'</div></td><td class=\'crosstb\' width="80%"><div id="d2_colDims" '+(cols==""?'class="tabhelpr"':"")+">"+(cols==""?"列表头":'<table class="sctab" cellspacing="0" cellpadding="0"><tr>'+cols+"</tr></table>")+'</div></td></tr><tr><td class=\'crosstb\' valign="bottom"><div id="d2_rowDims" '+(rows==""?'class="tabhelpr"':"")+">"+(rows==""?"行表头":'<table class="sctab2" cellspacing="0" cellpadding="0">'+rows+"</table>")+"</div></td><td class='crosstb'></td></tr></table>";return ret},this.dimExist=function(col,dims){var ret=false;if(!dims||dims==null){return ret}for(var i=0;i<dims.length;i++){if(dims[i].col==col){ret=true;break}if(dims[i].children&&dims[i].children.length>0){return this.dimExist(col,dims[i].children)}}return ret},this.regDropEvent=function(comp){var thiz=this;$("#"+comp.id+" #d2_colDims, #"+comp.id+" #d2_rowDims").droppable({accept:"#mydatatree .tree-node",onDragEnter:function(e,source){e.preventDefault();e.stopPropagation();var node=$("#datasettree").tree("getNode",source);var tp=node.attributes.type;$(source).draggable("proxy").find("span").removeClass("tree-dnd-no");$(source).draggable("proxy").find("span").addClass("tree-dnd-yes")},onDragLeave:function(e,source){e.preventDefault();e.stopPropagation();$(source).draggable("proxy").find("span").addClass("tree-dnd-no");$(source).draggable("proxy").find("span").removeClass("tree-dnd-yes")},onDrop:function(e,source){e.preventDefault();e.stopPropagation();var node=$("#datasettree").tree("getNode",source);var tp=node.attributes.type;var json=comp;if(node.attributes.income=="dataset"){msginfo("数据集字段不能拖入交叉表中。");return}if(!json.cubeId){json.cubeId=node.attributes.cubeId;var cube=fundCubeById(json.cubeId);json.tname=cube.tname;json.from=cube.from}else{if(json.cubeId!=node.attributes.cubeId){msginfo("组件只能映射一个立方体。");return}}var pos=null;var fss=null;if($(this).attr("id")=="d2_rowDims"){pos="row";fss=json.tableJson.rows}else{pos="col";fss=json.tableJson.cols}if(!thiz.dimExist(node.id,json.tableJson.cols)&&!thiz.dimExist(node.id,json.tableJson.rows)){if($(this).hasClass("tabhelpr")){$(this).removeClass("tabhelpr")}var parent=$("#datasettree").tree("getParent",node.target);var id=thiz.nextId();var crossField=null;if(tp=="dim"){crossField={id:id,col:node.id,desc:node.text,type:(node.attributes.dim_type?node.attributes.dim_type:"frd"),colname:(node.attributes.dimkey&&node.attributes.dimkey!=""?node.attributes.dimkey:node.id),colnamedesc:(node.attributes.dimtxt&&node.attributes.dimtxt!=""?node.attributes.dimtxt:node.id),iscas:(parent.attributes&&parent.attributes.type=="group"?"y":"n"),tname:node.attributes.tname,dimord:node.attributes.dimord}}else{crossField={id:id,col:node.id,desc:node.attributes.dispName,type:"kpi",alias:node.id,colname:(node.attributes.calc==1?node.attributes.expression:node.id),aggre:node.attributes.aggre,fmt:node.attributes.fmt,unit:node.attributes.unit,rate:1,calc:(node.attributes.calc?node.attributes.calc:0)}}fss.push(crossField);var string='<div id="'+id+'"><div class="crskpi2" style="'+(pos=="row"?"width:auto":"")+'">'+(tp=="dim"?'<span class="crossdim"></span><span class="txt">'+node.text+"</span>":'<span title="聚合方式" onclick="curTmpInfo.scrossTable.kpiAggreType(this, \''+crossField.id+"', '"+json.id+"','"+pos+'\')" class="kpilabel"></span><span class="txt">'+node.attributes.dispName+"</span>")+"</div></div>";if(fss.length==1){$(this).html('<table class="'+(pos=="col"?"sctab":"sctab2")+'" cellspacing="0" cellpadding="0"><tr><td class="root">'+string+"</td></tr></table>")}else{if(pos=="col"){$(this).find("table td.root").last().after('<td class="root">'+string+"</td>")}else{$(this).find("table tr").last().after('<tr><td class="root">'+string+"</td></tr>")}}thiz.cellSelect(json.id)}else{msginfo("维度或指标已经存在。");return}curTmpInfo.isupdate=true}})},this.cellSelect=function(compId){var thiz=this;var borderset=function(){$("#layout_table .comp_table").each(function(){var tp=$(this).attr("type");$(this).css("border",(tp=="table"||tp=="cross"?"0":"1")+"px solid #cccccc")});$("#"+compId).css("border","1px solid #999999")};$("#"+compId+" div.crskpi2").unbind("click").unbind("contextmenu").bind("click",function(){$("#"+compId+" div.crskpi2").removeClass("cellselect");$(this).addClass("cellselect");setProp($("#"+compId).parent().attr("id").split("_")[1],compId);borderset();return false}).bind("contextmenu",function(e){$("#"+compId+" div.crskpi2").removeClass("cellselect");var o=$(this).addClass("cellselect");setProp($("#"+compId).parent().attr("id").split("_")[1],compId);borderset();curTmpInfo.compId=compId;var tp="";if(o.parents("#d2_rowDims").size()>0){tp="row"}else{if(o.parents("#d2_colDims").size()>0){tp="col"}}curTmpInfo.layoutId=$("#"+compId).parent().attr("id").split("_")[1];var cid=o.parent().attr("id");curTmpInfo.tp=tp;curTmpInfo.colId=cid;var comp=findCompById(compId);var dim=thiz.findCrossField(cid,comp,tp);if(dim==null&&o.attr("id")=="jcbt"){return false}if(dim.type=="kpi"||dim.type=="none"||(dim.children&&dim.children.length>0)||dim.value){$("#staticCrossMenu").menu("disableItem",$("#staticCrossMenu #d_fj"))}else{$("#staticCrossMenu").menu("enableItem",$("#staticCrossMenu #d_fj"))}if(tp=="col"){$("#staticCrossMenu").menu("enableItem",$("#staticCrossMenu #i_child"))}else{$("#staticCrossMenu").menu("disableItem",$("#staticCrossMenu #i_child"))}if(tp=="row"){$("#staticCrossMenu").menu("setText",{target:$("#staticCrossMenu #i_left"),text:"上方插入"});$("#staticCrossMenu").menu("setText",{target:$("#staticCrossMenu #i_right"),text:"下方插入"});$("#staticCrossMenu").menu("setText",{target:$("#staticCrossMenu #c_up"),text:"上移"});$("#staticCrossMenu").menu("setText",{target:$("#staticCrossMenu #c_down"),text:"下移"})}else{$("#staticCrossMenu").menu("setText",{target:$("#staticCrossMenu #i_left"),text:"左边插入"});$("#staticCrossMenu").menu("setText",{target:$("#staticCrossMenu #i_right"),text:"右边插入"});$("#staticCrossMenu").menu("setText",{target:$("#staticCrossMenu #c_up"),text:"左移"});$("#staticCrossMenu").menu("setText",{target:$("#staticCrossMenu #c_down"),text:"右移"})}var offset=$(this).offset();$("#staticCrossMenu").menu("show",{left:e.pageX,top:e.pageY});return false})},this.loopField=function(id,dims,returnIndex){var ret=null;for(var i=0;i<dims.length;i++){if(dims[i].id==id){if(returnIndex){ret=i}else{ret=dims[i]}break}else{if(dims[i].children&&dims[i].children.length>0){ret=this.loopField(id,dims[i].children,returnIndex);if(ret!=null){this.parent=dims[i]}}}}return ret},this.findCrossField=function(id,comp,pos,returnIndex){var ret=null;var dims=null;this.parent=null;if(pos=="col"){dims=comp.tableJson.cols}else{dims=comp.tableJson.rows}return this.loopField(id,dims,returnIndex)},this.findCubeDim=function(cube,dimId){var ret=null;var iscas="n";for(i=0;i<cube.dim.length;i++){var d=cube.dim[i];if(d.tp=="group"){for(j=0;j<d.children.length;j++){if(d.children[j].id==dimId){ret=d.children[j];ret.iscas="y";break}}}else{if(d.id==dimId){ret=d;break}}}return ret},this.findCubeKpi=function(cube,kpiId){var ret=null;for(i=0;i<cube.kpi.length;i++){var k=cube.kpi[i];if(k.id==kpiId){ret=k;break}}return ret},this.delKeys=function(id){var dimid=curTmpInfo.colId;var compId=curTmpInfo.compId;var pos=curTmpInfo.tp;var comp=findCompById(compId);var dim=this.findCrossField(dimid,comp,pos);var idx=-1;for(i=0;i<dim.others.length;i++){if(dim.others[i].id==id){idx=i;break}}dim.others.splice(idx,1);$("#pdailog #dimkeys").html(this.listKeys(dim))},this.listKeys=function(dim){var ret='<table cellspacing="0" cellpadding="0" class="grid3"><tr><th>字段</th><th>限制值</th><th>备注</th><th>操作</th></tr>';for(i=0;dim.others&&i<dim.others.length;i++){var o=dim.others[i];ret=ret+'<tr><td class="kpiData1 grid3-td">'+o.desc+'</td><td class="kpiData1 grid3-td">'+o.value+'</td><td class="kpiData1 grid3-td">'+o.valnote+'</td><td class="kpiData1 grid3-td"><a href="javascript:;" onclick="curTmpInfo.scrossTable.delKeys(\''+o.id+"')\">删除</a></td></tr>"}ret=ret+"</table>";return ret},this.crtKeys=function(){thiz=this;var dimid=curTmpInfo.colId;var compId=curTmpInfo.compId;var pos=curTmpInfo.tp;var comp=findCompById(compId);var cube=fundCubeById(comp.cubeId);var dim=this.findCrossField(dimid,comp,pos);if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var str='<select class="inputform" name="cols" id="cols">';for(i=0;i<cube.dim.length;i++){var d=cube.dim[i];if(d.tp=="group"){for(j=0;j<d.children.length;j++){str=str+'<option value="'+d.children[j].id+'">'+d.children[j].name+"</option>"}}else{str=str+'<option value="'+d.id+'">'+d.name+"</option>"}}str=str+"</select>";var ctx='<div class="textpanel"><span class="inputtext">限制字段：</span>'+str+'<br/><span class="inputtext">限制值：</span><input type="text" id="vals" value="" class="inputform"><br/><span class="inputtext">限制值备注：</span><input type="text" id="valsnote" value="" class="inputform"></div>';$("#dsColumn_div").dialog({title:"创建节点限制条件",width:300,height:200,closed:false,cache:false,modal:true,toolbar:null,content:ctx,onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var cols=$("#dsColumn_div #cols").val();var vals=$("#dsColumn_div #vals").val();var valsnote=$("#dsColumn_div #valsnote").val();if(vals==""){msginfo("限制值是必填项。");return}if(!dim.others){dim.others=[]}var cubedim=thiz.findCubeDim(cube,cols);dim.others.push({id:thiz.nextId(),col:cubedim.id,desc:cubedim.name,valnote:valsnote,type:cubedim.dim_type,alias:cols,value:vals,tname:cubedim.tname,colname:cubedim.dimkey,colnamedesc:cubedim.dimtxt});$("#dsColumn_div").dialog("close");$("#pdailog #dimkeys").html(thiz.listKeys(dim))}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]})},this.createWarningHtml=function(warn){var str='<div class="textpanel"><span class="inputtext">图片样式：</span><select id="wctype"><option value="1" '+(warn&&warn.pictype=="1"?"selected":"")+'>交通灯</option><option value="2" '+(warn&&warn.pictype=="2"?"selected":"")+'>箭头</option></select> &nbsp; <input type="checkbox" value="y" id="fztp" name="fztp" '+(warn&&warn.reverse=="y"?"checked":"")+'><label for="fztp">反转图片</label><br/>';str=str+'<span id="w1" class="'+(warn?warn.pic1:"warning6")+'"></span> <span class="logictext">当前值</span> <select id="logic1" name="logic1" style="width:50px;"><option value=">=" '+(warn&&warn.logic1==">="?"selected":"")+'>&gt;=</option><option value=">" '+(warn&&warn.logic1==">"?"selected":"")+'>&gt;</option></select> <input type="text" id="val1" class="inputform" value="'+(warn?warn.val1:"")+'"> <br/><span id="w2" class="'+(warn?warn.pic2:"warning5")+'"></span> <span class="logictext">当前值 &lt; <span id="and1">'+(warn?warn.val1:"X")+'</span> 且 </span> <select id="logic2" name="logic2" style="width:50px;"><option value=">=" '+(warn&&warn.logic2==">="?"selected":"")+'>&gt;=</option><option value=">" '+(warn&&warn.logic2=="="?"selected":"")+'>&gt;</option></select> <input type="text" id="val2" class="inputform" value="'+(warn?warn.val2:"")+'"><br/> <span id="w3" class="'+(warn?warn.pic3:"warning4")+'"></span> <span class="logictext"> 当前值 &lt;  <span id="and2">'+(warn?warn.val2:"X")+'</span></span> <br/><br/>    <input type="checkbox" value="y" id="clear" name="clear" ><label for="clear">清除预警信息</label></div>';return str},this.getWarningVal=function(colObj){var pictype=$("#pdailog #wctype").val();var reverse=$('#pdailog input[name="fztp"]:checked').val();if(!reverse){reverse="n"}var logic1=$("#pdailog #logic1").val();var val1=$("#pdailog #val1").val();var logic2=$("#pdailog #logic2").val();var val2=$("#pdailog #val2").val();var pic1=$("#pdailog #w1").attr("class");var pic2=$("#pdailog #w2").attr("class");var pic3=$("#pdailog #w3").attr("class");colObj.warning={pictype:pictype,reverse:reverse,logic1:logic1,val1:val1,logic2:logic2,val2:val2,pic1:pic1,pic2:pic2,pic3:pic3}},this.regWarningEvent=function(){$("#pdailog #val1,#pdailog #val2").numberbox();$("#pdailog #val1").blur(function(){$("#pdailog #and1").text($(this).val())});$("#pdailog #val2").blur(function(){$("#pdailog #and2").text($(this).val())});$("#pdailog #wctype").change(function(){if($(this).val()==1){$("#pdailog #w1").attr("class","warning6");$("#pdailog #w2").attr("class","warning5");$("#pdailog #w3").attr("class","warning4")}else{if($(this).val()==2){$("#pdailog #w1").attr("class","warning3");$("#pdailog #w2").attr("class","warning2");$("#pdailog #w3").attr("class","warning1")}}});$("#pdailog #fztp").change(function(){if(this.checked){if($("#pdailog #wctype").val()==1){$("#pdailog #w1").attr("class","warning4");$("#pdailog #w2").attr("class","warning5");$("#pdailog #w3").attr("class","warning6")}else{if($("#pdailog #wctype").val()==2){$("#pdailog #w1").attr("class","warning1");$("#pdailog #w2").attr("class","warning2");$("#pdailog #w3").attr("class","warning3")}}}else{if($("#pdailog #wctype").val()==1){$("#pdailog #w1").attr("class","warning6");$("#pdailog #w2").attr("class","warning5");$("#pdailog #w3").attr("class","warning4")}else{if($("#pdailog #wctype").val()==2){$("#pdailog #w1").attr("class","warning3");$("#pdailog #w2").attr("class","warning2");$("#pdailog #w3").attr("class","warning1")}}}});$("#pdailog #clear").change(function(){if(this.checked){$("#pdailog #val1").val("");$("#pdailog #val2").val("")}})},this.editcell=function(){var thiz=this;var dimid=curTmpInfo.colId;var compId=curTmpInfo.compId;var pos=curTmpInfo.tp;var name=curTmpInfo.dimname;var comp=findCompById(compId);var dim=this.findCrossField(dimid,comp,pos);var cube=fundCubeById(comp.cubeId);var ctx='<div id="table_cell_tab" style="height:auto; width:auto;"><div title="基本信息"><div class="textpanel"><span class="inputtext">类型：</span>'+(dim.type=="kpi"?"指标":(dim.type=="none"?"NONE":"维度"))+'<br><span class="inputtext">显示名：</span><input type="text" id="dname" name="dname" class="inputform" value="'+(dim.type=="kpi"?dim.desc:dim.desc)+'">';if(dim.type!="kpi"&&dim.type!="none"){var cubeCol=this.findCubeDim(cube,dim.col);ctx=ctx+'<br><span class="inputtext">映射维度：</span>'+cubeCol.name+(dim.value?'<br/><span class="inputtext">绑定值：</span><input type="text" id="dimval" name="dimval" class="inputform" value="'+dim.value+'">':"");if(pos=="row"){ctx=ctx+'<br/><span class="inputtext">缩进(空格数)：</span><input type="text" data-options="min:1,max:10" id="spaceNum" name="spaceNum" class="inputform" value="'+(dim.spaceNum?dim.spaceNum:"")+'">'}}if(dim.type=="kpi"){var atp=["sum","avg","count","max","min"];var tpstr="";for(i=0;i<atp.length;i++){tpstr=tpstr+'<option value="'+atp[i]+'" '+(atp[i]==dim.aggre?"selected":"")+">"+atp[i]+"</option>"}ctx=ctx+'<br/><span class="inputtext">计算方式：</span><select id="kpiaggre" name="kpiaggre" class="inputform">'+tpstr+"</select> <br>";ctx=ctx+'<span class="inputtext">度量单位：</span><input type="text" id="kpiunit" name="kpiunit" class="inputform" value="'+(dim.unit?dim.unit:"")+'"> <br>';ctx=ctx+'<span class="inputtext">格式化：</span>'+curTmpInfo.property.ftmstr("kpifmt","inputform",(dim.fmt?dim.fmt:""))}if(pos=="col"){ctx=ctx+'<br/><span class="inputtext">表头排序：</span><select id="sort" name="sort" class="inputform"><option value="n">不启用</option><option value="y" '+(dim.sort&&"y"==dim.sort?"selected":"")+">启用</option></select>"}ctx=ctx+'</div></div><div title="限制条件"><div style="margin:5px;"><a href="javascript:;" onclick="curTmpInfo.scrossTable.crtKeys()">创建</a></div><div id="dimkeys">'+this.listKeys(dim)+"</div></div>"+(dim.type=="kpi"?'<div title="数据预警">'+this.createWarningHtml(dim.warning)+'</div><div title="回调函数"><div class="textpanel">function <input type="text" id="funcname" name="funcname" size="5" value="'+(dim.funcname?dim.funcname:"")+'">(<b>value</b>, <b>col</b>, <b>row</b>, <b>data</b>){<br/><textarea id="code" name="code" cols="50" rows="5">'+(dim.code?unescape(dim.code):"")+'</textarea><br/>}<br/><a target="_blank" href="../helper/callback.html" id="helper">帮助</a></div></div>':"")+"</div>";$("#pdailog").dialog({title:"编辑节点",width:400,height:(pos=="kpi"?380:310),closed:false,cache:false,modal:true,toolbar:null,content:ctx,onLoad:function(){},buttons:[{text:"确定",handler:function(){var tab=$("#pdailog #table_cell_tab").tabs("getSelected");var index=$("#pdailog #table_cell_tab").tabs("getTabIndex",tab);if(index==0){var dname=$("#pdailog #dname").val();var dimval=$("#pdailog #dimval").val();var kpiaggre=$("#pdailog #kpiaggre").val();var kpiunit=$("#pdailog #kpiunit").val();var kpifmt=$("#pdailog #kpifmt").val();var spaceNum=$("#pdailog #spaceNum").val();var sort=$("#pdailog #sort").val();dim.desc=dname;if(dim.type=="kpi"){dim.aggre=kpiaggre;dim.fmt=kpifmt;dim.unit=kpiunit}else{dim.value=dimval;if(spaceNum&&spaceNum!=""){dim.spaceNum=spaceNum;$("#"+compId+" #"+dimid+" span.txt").css("margin-left",Number(spaceNum)*6+"px")}else{delete dim.spaceNum;$("#"+compId+" #"+dimid+" span.txt").css("margin-left","inherit")}}dim.sort=sort;$("#"+compId+" #"+dimid+" span.txt").first().text(dname)}else{if(index==2){var val1=$("#pdailog #val1").val();var val2=$("#pdailog #val2").val();if(val1==""||val2==""){delete dim.warning;$("#pdailog").dialog("close");return}thiz.getWarningVal(dim)}else{if(index==3){var funcname=$("#table_cell_tab #funcname").val();var code=$("#table_cell_tab #code").val();if(funcname==""&&code==""){delete dim.funcname;delete dim.code;$("#pdailog").dialog("close");return}if(funcname==""){msginfo("函数名是必填项！");$("#table_cell_tab #funcname").focus();return}if(code==""){msginfo("函数内容是必填项！");$("#table_cell_tab #code").focus();return}dim.funcname=funcname;dim.code=escape(code)}}}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #spaceNum").numberbox();$("#pdailog #table_cell_tab").tabs({border:false,fit:true});$("#pdailog #table_cell_tab #helper").linkbutton({iconCls:"icon-tip"});if(dim.type=="kpi"){this.regWarningEvent()}},this.delall=function(){var dimid=curTmpInfo.colId;var compId=curTmpInfo.compId;var pos=curTmpInfo.tp;var comp=findCompById(compId);var dim=this.findCrossField(dimid,comp,pos);var dims=null;if(this.parent==null){if(pos=="col"){dims=comp.tableJson.cols;comp.tableJson.cols=[];$("#"+compId+" #d2_colDims").addClass("tabhelpr").html("列表头")}else{dims=comp.tableJson.rows;comp.tableJson.rows=[];$("#"+compId+" #d2_rowDims").addClass("tabhelpr").html("行表头")}}else{dims=this.parent.children;this.parent.children=[];$("#"+compId+" #"+this.parent.id+" table").remove();$("#"+compId+" #"+parent.id).find("div.crskpi2").css("width","70px")}},this.delcell=function(){var dimid=curTmpInfo.colId;var compId=curTmpInfo.compId;var pos=curTmpInfo.tp;var comp=findCompById(compId);var dim=null;var dims=null;var parent=null;if(pos=="col"){dims=comp.tableJson.cols}else{dims=comp.tableJson.rows}var idx=-1;var loopdims=function(tdims,id){for(var i=0;i<tdims.length;i++){if(tdims[i].id==id){idx=i;dim=tdims[i];dims=tdims;break}if(tdims[i].children&&tdims[i].children.length>0){parent=tdims[i];loopdims(tdims[i].children,id)}}};loopdims(dims,dimid);dims.splice(idx,1);if(pos=="col"){$("#"+compId+" #"+dim.id).parent().remove()}else{$("#"+compId+" #"+dim.id).parent().parent().remove()}if(dims.length==0&&parent==null){if(pos=="col"){$("#"+compId+" #d2_colDims").addClass("tabhelpr").html("列表头")}else{$("#"+compId+" #d2_rowDims").addClass("tabhelpr").html("行表头")}}else{if(dims.length==0&&parent!=null){$("#"+compId+" #"+parent.id+" table").remove();$("#"+compId+" #"+parent.id).find("div.crskpi2").css("width","70px")}}},this.resolveDim=function(){var dimid=curTmpInfo.colId;var compId=curTmpInfo.compId;var pos=curTmpInfo.tp;var comp=findCompById(compId);if(comp.from!="olap"){msginfo("自定义的立方体不支持维度分解操作。");return}var dims=null;var dim=this.findCrossField(dimid,comp,pos);if(this.parent==null){if(pos=="col"){dims=comp.tableJson.cols}else{dims=comp.tableJson.rows}}else{dims=this.parent.children}if(dim.value){return}if(dim.children&&dim.children.length>0){return}if(dim.type!="frd"){msginfo("当前维度不支持分解操作。");return}var thiz=this;$.ajax({type:"POST",url:"DataSet!queryDimValues.action",dataType:"json",data:{dim:JSON.stringify(dim)},success:function(resp){if(resp.length==0){msginfo("维度无值。");return}var str=JSON.stringify(dim);dim.value=resp[0].val+"";dim.desc=resp[0].text;for(i=1;i<resp.length;i++){var t=eval("("+str+")");t.value=resp[i].val+"";t.desc=resp[i].text;t.id=thiz.nextId();dims.push(t)}$("#"+compId+" #"+dimid+" span.txt").text(dim.desc);var sclass=$("#"+compId+" #"+dimid).parent().attr("class");var ss="";for(i=1;i<dims.length;i++){ss=ss+((pos=="row"?"<tr>":"")+'<td class="'+sclass+'"><div id="'+dims[i].id+'"><div class="crskpi2" style="'+(pos=="row"?"width:auto;":"")+'"><span class="crossdim"></span><span class="txt">'+dims[i].desc+"</span></div></div></td>"+(pos=="row"?"</tr>":""))}if(pos=="row"){$("#"+compId+" #"+dimid).parent().parent().after(ss)}else{$("#"+compId+" #"+dimid).parent().after(ss)}thiz.cellSelect(comp.id)}})},this.baseKpi=function(){var thiz=this;var compId=curTmpInfo.compId;var comp=findCompById(compId);if(!comp.tableJson.baseKpi){comp.tableJson.baseKpi={}}var baseKpi=comp.tableJson.baseKpi;var cube=fundCubeById(comp.cubeId);var ctx='<div class="textpanel">(注意:仅当表格中未设置指标时，该配置才起作用。)';var atp=["sum","avg","count","max","min"];var tpstr="";for(i=0;i<atp.length;i++){tpstr=tpstr+'<option value="'+atp[i]+'" '+(atp[i]==baseKpi.aggre?"selected":"")+">"+atp[i]+"</option>"}var kpistr='<option value=""></option>';for(i=0;i<cube.kpi.length;i++){kpistr=kpistr+'<option value="'+cube.kpi[i].id+'" '+(baseKpi.kpi==cube.kpi[i].id?"selected":"")+">"+cube.kpi[i].name+"</option>"}ctx=ctx+'<br/><span class="inputtext">映射指标：</span><select id="kpi" name="kpi" class="inputform">'+kpistr+'</select><br/><span class="inputtext">计算方式：</span><select id="kpiaggre" name="kpiaggre" class="inputform">'+tpstr+'</select> <br><span class="inputtext">格式化：</span>'+curTmpInfo.property.ftmstr("kpifmt","inputform",(baseKpi.fmt?baseKpi.fmt:""));ctx=ctx+"</div>";$("#pdailog").dialog({title:"设置表格基本指标",width:330,height:220,closed:false,cache:false,modal:true,toolbar:null,content:ctx,onLoad:function(){},buttons:[{text:"确定",handler:function(){var kpi=$("#pdailog #kpi").val();var aggre=$("#pdailog #kpiaggre").val();var fmt=$("#pdailog #kpifmt").val();var kpiObj=thiz.findCubeKpi(cube,kpi);baseKpi.kpi=kpi;if(kpiObj.calc==1){baseKpi.colname=kpiObj.expression}else{baseKpi.colname=kpiObj.id}baseKpi.calc=kpiObj.calc;baseKpi.aggre=aggre;baseKpi.fmt=fmt;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #kpi").change(function(){var kpi=thiz.findCubeKpi(cube,$(this).val());$("#pdailog #kpiaggre").val(kpi.aggre);$("#pdailog #kpifmt").val(kpi.fmt)})},this.move=function(tp){var dimid=curTmpInfo.colId;var compId=curTmpInfo.compId;var pos=curTmpInfo.tp;var comp=findCompById(compId);var dim=this.findCrossField(dimid,comp,pos);var parent=this.parent;this.parent=null;var dims=null;if(pos=="col"){dims=parent==null?comp.tableJson.cols:parent.children}else{dims=parent==null?comp.tableJson.rows:parent.children}var mvfunc=function(tp,dimid){var t=null;if(pos=="col"){t=$("#"+compId+" #"+dimid).parent()}else{t=$("#"+compId+" #"+dimid).parent().parent()}if(tp=="left"){t.prev().before(t)}else{if(tp=="right"){t.next().after(t)}}};for(var i=0;i<dims.length;i++){if(dims[i].id==dimid){if(tp=="left"){if(i<=0){msginfo("无效移动。");return}else{var tp=dims[i-1];dims[i-1]=dims[i];dims[i]=tp;mvfunc("left",dimid);curTmpInfo.isupdate=true;return}}else{if(tp=="right"){if(i>=dims.length-1){msginfo("无效移动。");return}else{var tp=dims[i+1];dims[i+1]=dims[i];dims[i]=tp;mvfunc("right",dimid);curTmpInfo.isupdate=true;return}}}break}}},this.insert=function(tp){var thiz=this;var dimid=curTmpInfo.colId;var compId=curTmpInfo.compId;var pos=curTmpInfo.tp;var comp=findCompById(compId);var dim=this.findCrossField(dimid,comp,pos);var cube=fundCubeById(comp.cubeId);var str='<select class="inputform" name="matchctx" id="matchctx"><option value="none@none">NONE</option>';for(i=0;i<cube.dim.length;i++){var d=cube.dim[i];if(d.tp=="group"){for(j=0;j<d.children.length;j++){str=str+'<option value="dim@'+d.children[j].id+'">D_'+d.children[j].name+"</option>"}}else{str=str+'<option value="dim@'+d.id+'">D_'+d.name+"</option>"}}for(i=0;i<cube.kpi.length;i++){var k=cube.kpi[i];str=str+'<option value="kpi@'+k.id+'">K_'+k.name+"</option>"}str=str+"</select>";var nodectx="";var vtp=dim.type;if(vtp=="kpi"){nodectx="指标("+dim.desc+")"}else{if(vtp=="none"){nodectx="none"}else{var d=thiz.findCubeDim(cube,dim.col);nodectx=d.name+"("+dim.desc+")"}}var ctx='<div class="textpanel"><span class="inputtext">当前节点：</span>'+nodectx+'<br/><span class="inputtext">新节点：</span>'+str+'<br/><div id="matchvaldiv" style="display:none"><span class="inputtext">绑定值：</span><input type="text" value="" class="inputform" name="nodeval" id="nodeval"></div><span class="inputtext">显示值：</span><input type="text" value="" class="inputform" name="nodedesc" id="nodedesc"></div>';$("#pdailog").dialog({title:(pos=="col"?(tp=="left"?"左边":"右边"):(tp=="left"?"上方":"下方"))+"插入节点",width:310,height:250,closed:false,cache:false,modal:true,content:ctx,buttons:[{text:"确定",handler:function(){var matchCtx=$("#pdailog #matchctx").val();var nodeval=$("#pdailog #nodeval").val();var nodedesc=$("#pdailog #nodedesc").val();if(nodedesc==""){msginfo("显示值是必填项。");return}var col=matchCtx.split("@")[1];var colType=matchCtx.split("@")[0];var cf=null;if(colType=="dim"){var dim=thiz.findCubeDim(cube,col);cf={id:thiz.nextId(),col:dim.id,desc:nodedesc,type:(dim.dim_type?dim.dim_type:"frd"),colname:dim.dimkey,colnamedesc:dim.dimtxt,iscas:dim.iscas,tname:dim.tname,dimord:dim.dimord,value:nodeval}}else{if(colType=="kpi"){var kpi=thiz.findCubeKpi(cube,col);cf={id:thiz.nextId(),col:kpi.id,desc:nodedesc,type:"kpi",alias:kpi.id,colname:(kpi.calc==1?kpi.expression:kpi.id),aggre:kpi.aggre,fmt:kpi.fmt,unit:kpi.unit,rate:1,calc:(kpi.calc?kpi.calc:0)}}else{cf={id:thiz.nextId(),col:"none",type:"none",desc:nodedesc}}}var dims=null;if(thiz.parent==null){if(pos=="col"){dims=comp.tableJson.cols}else{dims=comp.tableJson.rows}}else{dims=thiz.parent.children}var idx=-1;for(i=0;i<dims.length;i++){if(dims[i].id==dimid){idx=i;break}}if(tp=="right"){idx=idx+1}dims.splice(idx,0,cf);var str=(pos=="row"?"<tr>":"")+'<td class="'+(thiz.parent==null?"root":thiz.parent.id)+'"><div id="'+cf.id+'"><div class="crskpi2" style=\''+(pos=="row"?"width:auto":"")+"'>"+(colType=="kpi"?'<span title="聚合方式" onclick="curTmpInfo.scrossTable.kpiAggreType(this, \''+cf.id+"', '"+comp.id+"','"+pos+'\')" class="kpilabel"></span><span class="txt">'+cf.desc+"</span>":'<span class="crossdim"></span><span class="txt">'+cf.desc+"</span>")+"</div></div></td>"+(pos=="row"?"</tr>":"");if(tp=="left"){if(pos=="col"){$("#"+compId+" #"+dimid).parent().before(str)}else{$("#"+compId+" #"+dimid).parent().parent().before(str)}}else{if(pos=="col"){$("#"+compId+" #"+dimid).parent().after(str)}else{$("#"+compId+" #"+dimid).parent().parent().after(str)}}curTmpInfo.isupdate=true;thiz.cellSelect(comp.id);$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #matchctx").change(function(e){var val=$(this).val();var tp=val.split("@")[0];if(tp=="dim"){$("#pdailog #matchvaldiv").css("display","block")}else{$("#pdailog #matchvaldiv").css("display","none")}})},this.kpiAggreType=function(ts,kpiId,compId,pos){curTmpInfo.usetype="staticCross";curTmpInfo.compId=compId;curTmpInfo.kpiId=kpiId;curTmpInfo.pos=pos;$("#aggretypemenu").children().each(function(index,element){$("#aggretypemenu").menu("setIcon",{target:$(this),iconCls:"icon-blank"})});var comp=findCompById(compId);var dim=this.findCrossField(kpiId,comp,pos);var oldtp=dim.aggre;$("#aggretypemenu").menu("setIcon",{target:$("#aggre_"+oldtp),iconCls:"icon-ok"});var offset=$(ts).offset();$("#aggretypemenu").menu("show",{left:offset.left,top:offset.top+20})},this.insertChild=function(){var dimid=curTmpInfo.colId;var compId=curTmpInfo.compId;var pos=curTmpInfo.tp;if(pos=="row"){return}var comp=findCompById(compId);var dim=this.findCrossField(dimid,comp,pos);var cube=fundCubeById(comp.cubeId);var thiz=this;var str='<select class="inputform" name="matchctx" id="matchctx"><option value="none@none">NONE</option>';for(i=0;i<cube.dim.length;i++){var d=cube.dim[i];if(d.tp=="group"){for(j=0;j<d.children.length;j++){str=str+'<option value="dim@'+d.children[j].id+'">D_'+d.children[j].name+"</option>"}}else{str=str+'<option value="dim@'+d.id+'">D_'+d.name+"</option>"}}for(i=0;i<cube.kpi.length;i++){var k=cube.kpi[i];str=str+'<option value="kpi@'+k.id+'">K_'+k.name+"</option>"}str=str+"</select>";var ctx='<div class="textpanel"><span class="inputtext">节点对应内容：</span>'+str+'<br/><div id="matchvaldiv" style="display:none"><span class="inputtext">绑定值：</span><input type="text" value="" class="inputform" name="nodeval" id="nodeval"></div><span class="inputtext">显示值：</span><input type="text" value="" class="inputform" name="nodedesc" id="nodedesc"></div>';$("#pdailog").dialog({title:"插入下级节点",width:310,height:200,closed:false,cache:false,modal:true,content:ctx,buttons:[{text:"确定",handler:function(){var matchCtx=$("#pdailog #matchctx").val();var nodeval=$("#pdailog #nodeval").val();var nodedesc=$("#pdailog #nodedesc").val();if(nodedesc==""){msginfo("显示值是必填项。");return}var col=matchCtx.split("@")[1];var colType=matchCtx.split("@")[0];if(!dim.children){dim.children=[]}var cf=null;if(colType=="dim"){var d=thiz.findCubeDim(cube,col);cf={id:thiz.nextId(),col:d.id,desc:nodedesc,type:(d.dim_type?d.dim_type:"frd"),colname:(d.dimkey&&d.dimkey!=""?d.dimkey:d.id),colnamedesc:(d.dimtxt&&d.dimtxt!=""?d.dimtxt:d.id),iscas:d.iscas,tname:d.tname,dimord:d.dimord,value:nodeval}}else{if(colType=="kpi"){var kpi=thiz.findCubeKpi(cube,col);cf={id:thiz.nextId(),col:kpi.id,desc:nodedesc,type:"kpi",alias:kpi.id,colname:(kpi.calc==1?kpi.expression:kpi.id),aggre:kpi.aggre,fmt:kpi.fmt,unit:kpi.unit,rate:1,calc:(kpi.calc?kpi.calc:0)}}else{cf={id:thiz.nextId(),col:"none",type:"none",desc:nodedesc}}}dim.children.push(cf);var string='<div id="'+cf.id+'"><div class="crskpi2">'+(cf.type!="kpi"?'<span class="crossdim"></span><span class="txt">'+cf.desc+"</span>":'<span title="聚合方式" onclick="curTmpInfo.scrossTable.kpiAggreType(this, \''+cf.id+"', '"+comp.id+'\',\'col\')" class="kpilabel"></span><span class="txt">'+cf.desc+"</span>")+"</div></div>";if(dim.children.length==1){$("#"+compId+" #"+dim.id).find("div.crskpi2").css("width","auto");$("#"+compId+" #"+dim.id).append('<table cellspacing="0" cellpadding="0"><tr><td class="'+dim.id+'">'+string+"</td></tr></table>")}else{$("#"+compId+" #"+dim.id).find("td."+dim.id).last().after('<td class="'+dim.id+'">'+string+"</td>")}curTmpInfo.isupdate=true;thiz.cellSelect(comp.id);$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #matchctx").change(function(e){var val=$(this).val();var tp=val.split("@")[0];if(tp=="dim"){$("#pdailog #matchvaldiv").css("display","block")}else{$("#pdailog #matchvaldiv").css("display","none")}})}};